<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Tari Network: RFC library</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The Tari network RFC library and documentation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
            tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true
            }
          });
        </script>
        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = 'light';
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <img src="theme/images/tari-splash.png" class="tlu">

            <ol class="chapter"><li class="affix"><a href="about.html">About the Tari RFC documents</a></li><li><a href="RFC-0001_overview.html"><strong aria-hidden="true">1.</strong> RFC-0001: An overview of the Tari network</a></li><li><ol class="section"><li><a href="RFC-1000_TariUseCases.html"><strong aria-hidden="true">1.1.</strong> RFC-1000: Tari Use cases</a></li></ol></li><li><a href="RFC-0010_CodeStructure.html"><strong aria-hidden="true">2.</strong> RFC-0010: Tari code structure and organisation</a></li><li><a href="RFC-0100_BaseLayer.html"><strong aria-hidden="true">3.</strong> RFC-0100: The Tari Base Layer</a></li><li><ol class="section"><li><a href="RFC-0110_BaseNodes.html"><strong aria-hidden="true">3.1.</strong> RFC-0110: Base nodes</a></li><li><a href="RFC-0111_BaseNodeArchitecture.html"><strong aria-hidden="true">3.2.</strong> RFC-0111: Base node architecture</a></li><li><a href="RFC-0130_Mining.html"><strong aria-hidden="true">3.3.</strong> RFC-0130: Mining</a></li><li><a href="RFC-0140_Syncing_and_seeding.html"><strong aria-hidden="true">3.4.</strong> RFC-0140: Sync and Seeding</a></li><li><a href="RFC-0150_Wallets.html"><strong aria-hidden="true">3.5.</strong> RFC-0150: Wallets</a></li><li><a href="RFC-0151_TransactionProtocol.html"><strong aria-hidden="true">3.6.</strong> RFC-0151: Transaction protocol</a></li><li><a href="RFC-0170_NetworkCommunicationProtocol.html"><strong aria-hidden="true">3.7.</strong> RFC-0170: Network Communication Protocol</a></li><li><ol class="section"><li><a href="RFC-0171_MessageSerialisation.html"><strong aria-hidden="true">3.7.1.</strong> RFC-0171: Message Serialisation</a></li><li><a href="RFC-0172_PeerToPeerMessagingProtocol.html"><strong aria-hidden="true">3.7.2.</strong> RFC-0172: Peer to Peer Messaging Protocol</a></li></ol></li><li><a href="RFC-0190_Mempool.html"><strong aria-hidden="true">3.8.</strong> RFC-0190: Mempool</a></li><li><a href="BaseLayerExtensions.html"><strong aria-hidden="true">3.9.</strong> Tari-specific extensions to Mimblewimble</a></li><li><ol class="section"><li><a href="RFC-0220_AssetCheckpoints.html"><strong aria-hidden="true">3.9.1.</strong> RFC-0220: Asset checkpoints</a></li><li><a href="RFC-0230_HTLC.html"><strong aria-hidden="true">3.9.2.</strong> RFC-0230: Hash time locked contracts</a></li><li><a href="RFC-0322_VNRegistration.html"><strong aria-hidden="true">3.9.3.</strong> RFC-0322: Validator Node Registration</a></li><li><a href="RFC-0341_AssetRegistration.html"><strong aria-hidden="true">3.9.4.</strong> RFC-0341: Asset registration</a></li></ol></li></ol></li><li><a href="RFC-0300_DAN.html"><strong aria-hidden="true">4.</strong> RFC-0300: The Digital Assets Network</a></li><li><ol class="section"><li><a href="RFC-0301_NamespaceRegistration.html"><strong aria-hidden="true">4.1.</strong> RFC-0301: Namespace Registration</a></li><li><a href="RFC-0302_ValidatorNodes.html"><strong aria-hidden="true">4.2.</strong> RFC-0302: Validator Nodes</a></li><li><a href="RFC-0304_VNCommittees.html"><strong aria-hidden="true">4.3.</strong> RFC-0304: Validator Node committee selection</a></li><li><a href="AssetManagement.html"><strong aria-hidden="true">4.4.</strong> Asset Management</a></li><li><ol class="section"><li><a href="RFC-0311_AssetTemplates.html"><strong aria-hidden="true">4.4.1.</strong> RFC-0311: Digital Asset templates</a></li><li><a href="RFC-0313_AssetReadAPI.html"><strong aria-hidden="true">4.4.2.</strong> RFC-0313: The asset read-only API</a></li><li><a href="RFC-0315_AssetTransfer.html"><strong aria-hidden="true">4.4.3.</strong> RFC-0315: Asset transfer mechanism</a></li><li><a href="RFC-0316_AssetRetirement.html"><strong aria-hidden="true">4.4.4.</strong> RFC-0316: Asset retirement</a></li></ol></li><li><a href="RFC-0340_VNConsensusOverview.html"><strong aria-hidden="true">4.5.</strong> RFC-0340: Validator Node Consensus</a></li><li><ol class="section"><li><a href="RFC-0342_VNInstructions.html"><strong aria-hidden="true">4.5.1.</strong> RFC-0342: Validator node instructions</a></li><li><a href="RFC-0343_VNConsensusAlgorithm.html"><strong aria-hidden="true">4.5.2.</strong> RFC-0343: The VN consensus algorithm</a></li></ol></li><li><a href="RFC-0350_DisputeResolution.html"><strong aria-hidden="true">4.6.</strong> RFC-0350: DAN Dispute resolution mechanism</a></li></ol></li><li><a href="RFC-0500_PaymentChannels.html"><strong aria-hidden="true">5.</strong> RFC-0500: Tari payment channels</a></li><li><a href="RFC-0400_TariApplications.html"><strong aria-hidden="true">6.</strong> RFC-0400: Tari Application Suite</a></li><li><a href="RFC-1000_TariUseCases.html"><strong aria-hidden="true">7.</strong> RFC-1000: Tari Use Cases</a></li><li><a href="Glossary.html"><strong aria-hidden="true">8.</strong> Glossary</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"><img src="theme/images/tari-horizontal-logo.png"/> </h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#the-tari-rfcs" id="the-tari-rfcs"><h1>The Tari RFCs</h1></a>
<p>Tari is a community-driven project. The documents presented in this RFC collection have typically gone through several
iterations before reaching this point:</p>
<ul>
<li>Ideas and questions are posted in #tari-dev on <a href="https://freenode.net/">#FreeNode IRC</a>. This is typically short-form
content with rapid feedback. Often, these conversations will lead to someone posting a proposal as a <a href="https://github.com/tari-project/RFC/pulls" title="Tari RFC pull requests">pull request</a> into
<a href="https://github.com/tari-project/RFC/tree/master/proposals" title="Tari proposals">proposals</a>.</li>
<li><a href="https://github.com/tari-project/RFC/tree/master/proposals" title="Tari proposals">Proposals</a> get debated and refined using Github's Review and <a href="https://github.com/tari-project/RFC/pulls" title="Tari RFC pull requests">pull request</a> systems. After the content has
stabilised, and the community accepts the proposal, it can be written up as a formal RFC.</li>
<li>RFCs are &quot;Requests for Comment&quot;, so although the proposals in these documents are usually well-thought out, they are
not cast in stone. RFCs can, and should, undergo further evaluation and discussion by the community. RFC comments are
best made using Github <a href="https://github.com/tari-project/RFC/issues" title="Tari RFC Issues">issues</a>.</li>
</ul>
<p>New RFC's should follow the format given in the <a href="./RFC_template.html">RFC template</a>.</p>
<a class="header" href="#lifecycle" id="lifecycle"><h2>Lifecycle</h2></a>
<p>RFCs go through the following lifecycle, which roughly corresponds to the <a href="https://rfc.unprotocols.org/spec:2/COSS/">COSS</a>:</p>
<table><thead><tr><th align="left"> Status      </th><th align="left">                                                   </th><th align="left"> Description                                                                                                                                                                                                         </th></tr></thead><tbody>
<tr><td align="left"> Draft       </td><td align="left"> <img src="theme/images/status-draft.svg" alt="draft" />           </td><td align="left"> Changes, additions and revisions can be expected.                                                                                                                                                                   </td></tr>
<tr><td align="left"> Stable      </td><td align="left"> <img src="theme/images/status-stable.svg" alt="stable" />         </td><td align="left"> Typographical and cosmetic changes aside, no further changes should be made. Changes to the Tari code base w.r.t. a stable RFC will lead to the RFC becoming out of date, deprecated, or retired.                   </td></tr>
<tr><td align="left"> Out of date </td><td align="left"> <img src="theme/images/status-outofdate.svg" alt="out of date" /> </td><td align="left"> This RFC has become stale due to changes in the code base. Contributions will be accepted to make it stable again if the changes are relatively minor, otherwise it should eventually become deprecated or retired. </td></tr>
<tr><td align="left"> Deprecated  </td><td align="left"> <img src="theme/images/status-deprecated.svg" alt="deprecated" /> </td><td align="left"> This RFC has been replaced by a newer RFC document, but is still is use in some places and/or versions of Tari.                                                                                                     </td></tr>
<tr><td align="left"> Retired     </td><td align="left"> <img src="theme/images/status-retired.svg" alt="retired" />       </td><td align="left"> The RFC is no longer in use on the Tari network.                                                                                                                                                                    </td></tr>
</tbody></table>
<a class="header" href="#rfc-0001overview" id="rfc-0001overview"><h1>RFC-0001/Overview</h1></a>
<a class="header" href="#an-overview-of-the-tari-network" id="an-overview-of-the-tari-network"><h2>An overview of the Tari network</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a></p>
<a class="header" href="#license" id="license"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2018 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language" id="language"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer" id="disclaimer"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals" id="goals"><h2>Goals</h2></a>
<p>The aim of this proposal is to provide a very high-level perspective for the moving parts involved in the Tari protocol.</p>
<a class="header" href="#related-rfcs" id="related-rfcs"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0100_BaseLayer.html">RFC-0100: Base layer</a></li>
<li><a href="RFC-0300_DAN.html">RFC-0300: Digital asset network</a></li>
<li><a href="RFC-0311_AssetTemplates.html">RFC-0310: Digital assets</a></li>
</ul>
<a class="header" href="#description" id="description"><h2>Description</h2></a>
<a class="header" href="#abstract" id="abstract"><h3>Abstract</h3></a>
<p>The Tari network is composed of three layers:</p>
<ol>
<li>The base layer deals with <a href="Glossary.html#transaction">Tari coin</a>s. It governed by a proof-of-work blockchain that is merged-mined with
Monero. The base layer is highly secure, decentralised and relatively slow.</li>
<li>A multiparty payments channel allows rapid, secure, low cost off-chain payments that are periodically settled on the
base layer.</li>
<li>The digital assets network. This layer manages all things to do with native digital assets. It is built for liveness,
speed and scalability at the expense of decentralisation.</li>
</ol>
<p><img src="theme/images/tari_network_overview.png" alt="Tari Network Overview" /></p>
<a class="header" href="#currency-tokens-and-digital-assets" id="currency-tokens-and-digital-assets"><h3>Currency tokens and digital assets</h3></a>
<p>There are two major digital entities on the Tari network: The coins that are the unit of transfer for the Tari
cryptocurrency, and the digital assets that could represent anything from tickets to in-game items.</p>
<p>Tari coins are the fuel that drives the entire Tari ecosystem. They share many of the properties of money, and so
security is a non-negotiable requirement. In a cryptocurrency context, this is usually achieved by employing a
decentralised network running a censorship-resistant protocol like Nakamoto consensus over a proof of work blockchain.
As we know, proof of work blockchains are not scalable, or terribly fast.</p>
<p>On the other hand, the Tari network will be used to create and manage digital assets.</p>
<p>In Tari parlance, a digital asset is defined as a finite set of digital stateful tokens that are governed by predefined
rules. A single digital asset may define anything from one to thousands of tokens within its scope.</p>
<p>For example, in a ticketing context, an <em>event</em> will be an asset. The asset definition will allocate tokens representing
the tickets for that event. The ticket tokens will have state, such as its current owner and whether it has been
redeemed or not. Users might be interacting with digital assets hundreds of times a second, and state updates need to be
propagated and agreed upon by the network very quickly. A blockchain-enabled ticketing system is practically useless if
a user has to wait for &quot;3 block confirmations&quot; before the bouncer will let her into a venue. Users expect near-instant
state updates because centralised solutions offer them that today.</p>
<p>Therefore the Tari digital assets network must offer speed and scalability.</p>
<a class="header" href="#multiple-layers" id="multiple-layers"><h4>Multiple layers</h4></a>
<p>The <a href="https://en.wikipedia.org/wiki/CAP_theorem">distributed system trilemma</a> tells us that these requirements are
mutually exclusive.</p>
<p>We can't have fast, cheap digital assets and also highly secure and decentralised currency tokens on a single system.</p>
<p>Tari overcomes this constraint by building three layers:</p>
<ul>
<li>A base layer that provides a public ledger of Tari coin transactions, secured by proof of work to maximise security,</li>
<li>A multiparty payment channel, allowing funds to be sent to parties in the channel instantly, securely and with very
low fees.</li>
<li>A digital asset layer that manages digital asset state that is very fast and cheap, at the expense of
decentralisation.</li>
</ul>
<p>If required, the digital asset layer can refer back to the base layer to temporarily give up speed in exchange for
increased security. This fallback is used to resolve consensus issues on the digital asset layer that may crop up from
time to time as a result of the lower degree of decentralisation.</p>
<a class="header" href="#the-base-layer" id="the-base-layer"><h3>The Base Layer</h3></a>
<p><em>Refer to <a href="RFC-0100_BaseLayer.html">RFC-0100/BaseLayer</a> for more detail</em>.</p>
<p>The Tari base layer has the following primary features:</p>
<ul>
<li>Proof of work-based blockchain using Nakamoto consensus</li>
<li>Transactions and blocks based on the <a href="Glossary.html#mimblewimble">Mimblewimble</a> protocol</li>
</ul>
<p><a href="Glossary.html#mimblewimble">Mimblewimble</a> is an exciting new blockchain protocol that offers some key advantages over other <a href="Glossary.html#unspent-transaction-outputs">UTXO</a>-based
cryptocurrencies like Bitcoin:</p>
<ul>
<li>Transactions are private. This means that casual observers cannot ascertain the amounts being transferred or the
identities of the parties involved.</li>
<li>Mimblewimble employs a novel blockchain &quot;compression&quot; method called cut-through that dramatically reduces the
storage requirements for blockchain nodes.</li>
<li>Multi-signature transactions can be easily aggregated, making such transactions very compact, and completely hiding
the parties involved, or the fact that there were multiple parties involved at all.</li>
</ul>
<blockquote>
<p>&quot;Mimblewimble is the most sound, scalable 'base layer' protocol we know&quot; -- @fluffypony</p>
</blockquote>
<a class="header" href="#proof-of-work" id="proof-of-work"><h4>Proof of work</h4></a>
<p>There are a few options for the proof of work mechanism for Tari:</p>
<ul>
<li>Implement an existing PoW mechanism. This is a bad idea, because a nascent cryptocurrency that uses a non-unique
mining algorithm is incredibly vulnerable to a 51% attack from miners from other currencies using the same algorithm.
Bitcoin Gold and Verge have already experienced this, and it's a <a href="https://www.crypto51.app/">matter of time</a> before it
happens to others.</li>
<li>Implement a unique PoW algorithm. This is a risky approach and comes close to breaking the #1 rule of
cryptocurrency design: Never roll your own crypto.</li>
<li><a href="https://tari-labs.github.io/tari-university/merged-mining/merged-mining-scene/MergedMiningIntroduction.html">Merge mining</a>.
This approach is not without its own risks but offers the best trade-offs in terms of bootstrapping the network. It
typically provides high levels of hash rate from day one along with 51% attack resistance assuming mining pools are
well-distributed.</li>
<li>A hybrid approach, utilising two or more of the above mechanisms.</li>
</ul>
<p>Given Tari's relationship with Monero, a merge-mined strategy with Monero makes the most sense, but the PoW mechanism
SHOULD be written in a way that makes it relatively easy to code, implement and switch to a different strategy in the
future.</p>
<a class="header" href="#multiparty-payment-channels" id="multiparty-payment-channels"><h3>Multiparty Payment Channels</h3></a>
<p>Further details about the Tari multiparty payment channel technology are given in
<a href="RFC-0500_PaymentChannels.html">RFC-500/PaymentChannels</a>.</p>
<a class="header" href="#the-digital-assets-network" id="the-digital-assets-network"><h3>The Digital Assets Network</h3></a>
<p>A more detailed proposal for the digital assets network is presented in <a href="RFC-0300_DAN.html">RFC-0300/DAN</a>. Digital assets
<em>are discussed in more detail in <a href="RFC-0311_AssetTemplates.html">RFC-0310/Assets</a>.</em></p>
<p>The Tari digital assets network (DAN) consists of a peer-to-peer network of <a href="Glossary.html#validator-node">Validator nodes</a>. These nodes ensure the
safe and efficient operation of all native digital assets on the Tari network.</p>
<p>Validator nodes are responsible for</p>
<ul>
<li><em>registering</em> themselves on the base layer.</li>
<li>validating and executing the contracts that <em>create</em> and issue <em>new digital assets</em> on the network.</li>
<li>validating and executing <em>instructions</em> for <em>changes in state</em> of digital assets, for example allowing the transfer of
ownership of a token from one person to another.</li>
<li><em>Maintaining consensus</em> with other validator nodes managing the same asset.</li>
<li>submitting periodic <em>checkpoints</em> to the base layer for the state of assets under their management.</li>
</ul>
<p>The DAN is focused on achieving high speed and scalability, without compromising on security. To achieve
this we make the explicit trade-off of sacrificing decentralisation.</p>
<p>In many ways this is desirable, since the vast majority of assets (and their issuers) don't need or want <em>the entire
network</em> to validate every state change in their asset contracts.</p>
<p>Digital assets necessarily have <em>state</em>. Therefore the digital assets layer must have a means of synchronising and
agreeing on state that is managed simultaneously by multiple servers (a.k.a. reaching consensus).</p>
<p>Please refer to Tari Labs University for detailed discussions on
<a href="https://tlu.tarilabs.com/layer2scaling/layer2scaling-landscape/layer2scaling-survey.html">layer 2 scaling solutions</a>
and
<a href="https://tlu.tarilabs.com/consensus-mechanisms/BFT-consensus-mechanisms-applications/Introduction.html">consensus mechanisms</a>.</p>
<a class="header" href="#interaction-between-the-base-layer-and-the-dan" id="interaction-between-the-base-layer-and-the-dan"><h3>Interaction between the base layer and the DAN</h3></a>
<p>The base layer provides supporting services to the digital asset network. In general, the base layer only knows about
Tari coin transactions. It knows nothing about the details of any digital assets and their state.</p>
<p>This is by design: The network cannot scale if details of digital asset contracts have to be tracked on the base layer.
We envisage that there could be tens of thousands of contracts deployed on Tari. Some of those contracts may be enormous;
imagine controlling every piece of inventory and their live statistics for a MMORPG. The base layer is also too slow. If
<em>any</em> state relies on base layer transactions being confirmed, there is an immediate lag before that state change can be
considered final, which kills the liveness properties we seek for the DAN.</p>
<p>It's better to keep the two networks almost totally decoupled from the outset, and allow each network to play to its
strength.</p>
<p>That said, there are key interactions between the two layers. The base layer is a ledger and so it can be used as a
source of truth for the DAN to use as a type of registrar as well as final court of appeal in the case of consensus
disputes. This is what gives the DAN a secure fallback in case bad actors try to manipulate asset state by taking
advantage of its non-decentralisation.</p>
<p>These interactions require making provision for additional transaction types, in addition to payment and coinbase
transactions, that mark validator node registrations, contract collateral and so on.</p>
<p>The interplay between base layer and DAN is what incentivises every actor in the system to maintain an efficient and
well-functioning network even while acting in their own self-interests.</p>
<a class="header" href="#summary" id="summary"><h3>Summary</h3></a>
<p>Table 1 summarises the defining characteristics of the Tari network layers:</p>
<table><thead><tr><th align="left">                                      </th><th align="left"> Base layer       </th><th align="left"> Payment Channels </th><th align="left"> DAN                    </th></tr></thead><tbody>
<tr><td align="left"> Speed                                </td><td align="left"> Slow             </td><td align="left"> Fast             </td><td align="left"> Fast                   </td></tr>
<tr><td align="left"> Scalability                          </td><td align="left"> Moderate         </td><td align="left"> High             </td><td align="left"> Very high              </td></tr>
<tr><td align="left"> Security                             </td><td align="left"> High             </td><td align="left"> High             </td><td align="left"> Mod (High w/ fallback) </td></tr>
<tr><td align="left"> Decentralisation                     </td><td align="left"> High             </td><td align="left"> Low - Med        </td><td align="left"> Low - Med              </td></tr>
<tr><td align="left"> Processes Tari coin transactions     </td><td align="left"> Yes              </td><td align="left"> Yes              </td><td align="left"> No                     </td></tr>
<tr><td align="left"> Processes digital asset instructions </td><td align="left"> Only checkpoints </td><td align="left"> No               </td><td align="left"> Yes                    </td></tr>
</tbody></table>
<a class="header" href="#rfc-1000tariusecases" id="rfc-1000tariusecases"><h1>RFC-1000/TariUseCases</h1></a>
<a class="header" href="#a-digital-asset-framework" id="a-digital-asset-framework"><h2>A Digital Asset Framework</h2></a>
<p><img src="./theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/lelandlee">Leland Lee</a></p>
<a class="header" href="#license-1" id="license-1"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-1" id="language-1"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-1" id="disclaimer-1"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-1" id="goals-1"><h2>Goals</h2></a>
<p>There will be many types of digital assets that can be issued on Tari. This document is intended to help potential asset
issuers identify use cases for Tari that lead to the design of new types of digital assets that may or may not exist in
their ecosystems today.</p>
<a class="header" href="#related-rfcs-1" id="related-rfcs-1"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0001_overview.html">RFC-0001: An overview of the Tari network</a></li>
<li><a href="RFC-0300_DAN.html">RFC-0300: The Digital Assets Network</a></li>
</ul>
<a class="header" href="#description-1" id="description-1"><h2>Description</h2></a>
<p>Tari <a href="Glossary.html#digital-asset">digital asset</a>s may exist on the Tari <a href="Glossary.html#digital-asset-network">Digital Assets Network</a> (DAN), are perceived to have value and can be
owned, with the associated digital data being classified as intangible, personal property.</p>
<a class="header" href="#types" id="types"><h3>Types</h3></a>
<p>Digital assets may have the following high level classification scheme:</p>
<ul>
<li>Symbolic
<ul>
<li>Insignia</li>
<li>Mascots</li>
<li>Event-driven or historical (eg. a rivalry or a highly temporal event)</li>
</ul>
</li>
<li>Artifacts or Objects
<ul>
<li>Legendary</li>
<li>Rare</li>
<li>High demand</li>
<li>Artistic</li>
<li>Historical</li>
</ul>
</li>
<li>Utility
<ul>
<li>Tickets</li>
<li>In-game items</li>
<li>Points</li>
<li>Currency</li>
<li>Full or fractional representation</li>
<li>Bearer instruments / access token</li>
<li>Chat stickers</li>
</ul>
</li>
<li>Persona
<ul>
<li>Personality trait(s)</li>
<li>Emotion(s)</li>
<li>Statistics</li>
<li>Superpower(s)</li>
<li>Storyline(s)</li>
<li>Relationship(s)</li>
<li>Avatar</li>
</ul>
</li>
</ul>
<a class="header" href="#behaviors" id="behaviors"><h3>Behaviors</h3></a>
<p>Digital asset tokens may influence the following behavioral types:</p>
<ul>
<li>Advance purchase</li>
<li>Experience enhancement</li>
<li>Sharing</li>
<li>Loyalty</li>
<li>Reward for performance</li>
<li>Tipping</li>
<li>Donating to a charity</li>
<li>Collecting</li>
<li>Trading</li>
<li>Building / combining</li>
</ul>
<a class="header" href="#attributes" id="attributes"><h3>Attributes</h3></a>
<p>Digital assets have many different properties, which may be one or more of the following:</p>
<ul>
<li>Digital assets can be interactive:
<ul>
<li>Easter eggs
<ul>
<li>Media</li>
<li>Dynamic (eg. Imagine if assets were similar to sounds, visualisations or other kinds of &quot;demos&quot; or &quot;gifs&quot;)</li>
</ul>
</li>
<li>Game mechanics</li>
<li>Evolutionary</li>
</ul>
</li>
<li>Digital assets can be combined to create super assets.</li>
<li>Digital assets can be attribute(s) of another digital asset (e.g. wheels of a vehicle or a VIP ticket has two drink cards).</li>
<li>Digital assets can have contingencies (e.g. ownership of a digital asset is contingent on ownership of a different digital asset, using this digital asset is contingent on holding it for a particular duration, etc)</li>
<li>Digital assets can have utility (e.g. be useful).</li>
<li>Digital assets can be used across platforms (e.g. a digital asset for a game could be used as avatars in a social network).</li>
<li>Digital assets can have history.</li>
<li>Digital assets can have user-generated tags and/or metadata.</li>
</ul>
<a class="header" href="#interactions" id="interactions"><h3>Interactions</h3></a>
<p>Digital asset owners may have the following interactions with the DAN and/or other people:</p>
<ul>
<li>Digital asset owners can attest that they have ownership over there assets at time <code>t</code>.</li>
<li>Digital assets owners may attest ownership to an individual, to a group of friends or to the entire world.</li>
</ul>
<a class="header" href="#rules" id="rules"><h3>Rules</h3></a>
<p>Rules are the governance of how digital assets may be used or transferred, as defined by the asset issuer:</p>
<ul>
<li>Royalty Fees -  Digital asset issuers can set a royalty that charges a fee every time the digital asset is transferred between parties. The fee as defined by the issuer can be fixed or dynamic or follow a complex formula and value is granted to the issuer(s) and/or other entities.</li>
<li>Contingency - Digital asset ownership/interaction may be contingent/dependent on another asset.</li>
<li>Timing Controls - Digital assets can only be transferred or used at particular times.</li>
<li>Sharing - Digital assets can be shared to others or even co-owned.</li>
<li>Privacy - Ownership of a digital asset can be changed from private to public.</li>
<li>Upgradability/Versioning - Digital assets can be upgraded and/or versioned.</li>
<li>Redeemability - Digital assets can be used once or multiple times.</li>
</ul>
<a class="header" href="#examples" id="examples"><h3>Examples</h3></a>
<p>Some examples of how different types of digital assets with different attributes, rules and interactions may be
manifested are shown below.</p>
<a class="header" href="#crystal-skull-of-akador" id="crystal-skull-of-akador"><h4>Crystal Skull of Akador</h4></a>
<ul>
<li>Is rare
<ul>
<li>Is 1 of 5</li>
</ul>
</li>
<li>Is legendary
<ul>
<li>https://indianajones.fandom.com/wiki/Crystal_Skull_of_Akator</li>
<li>Press reports that this artifact could be worth $X</li>
</ul>
</li>
<li>Drives collectibility</li>
<li>Drives advance purchase
<ul>
<li>If you are one of the first 100,000 people to buy tickets to Indiana Jones World you have a chance of winning this 1 of 5 artifact.</li>
</ul>
</li>
<li>Has superpowers and utility
<ul>
<li>If you have this item while visiting Indiana Jones World, you get to skip the line three times.</li>
</ul>
</li>
<li>Is a contingency for another asset
<ul>
<li>If you collect this item, two Sankara stones, and the Cross of Coronado, you can buy the ark of the covenant:
<ul>
<li>Ark of the covenant is rare. It is 1 of 1.</li>
<li>Ark of the covenant is legendary.</li>
<li>Ark of the covenant gives you lifetime access to Indiana Jones World.</li>
<li>Ark of the covenant has rules; 20% of the resale price goes to Indiana Jones World.</li>
</ul>
</li>
</ul>
</li>
</ul>
<a class="header" href="#ab-de-villiers-bat" id="ab-de-villiers-bat"><h4>AB de Villiers' bat</h4></a>
<ul>
<li>Isn’t Rare
<ul>
<li>Is 1 of 100,000</li>
</ul>
</li>
<li>Is Legendary
<ul>
<li>https://www.youtube.com/watch?v=HK6B2da3DPA</li>
</ul>
</li>
<li>Drives collectibility
<ul>
<li>Is part of a series of bats from famous batsmen.</li>
</ul>
</li>
<li>Can be combined with other assets
<ul>
<li>Be one of the first 10 people to combine six bats to turn this asset into a One Day International (ODI) century bat:
<ul>
<li>ODI century bats are rare, they are 1 of 10.</li>
<li>ODI century bats are legendary.</li>
</ul>
</li>
</ul>
</li>
<li>Has no superpowers</li>
<li>Has no utility</li>
<li>Has no rules</li>
</ul>
<a class="header" href="#ovo-owl-x-supreme" id="ovo-owl-x-supreme"><h4>OVO Owl x Supreme</h4></a>
<ul>
<li>Is Rare
<ul>
<li>Is 1 of 200</li>
</ul>
</li>
<li>Is Legendary
<ul>
<li>https://www.supremenewyork.com</li>
<li>https://us.octobersveryown.com</li>
</ul>
</li>
<li>Has a game mechanic
<ul>
<li>Every time it’s transferred, it may become a golden ticket that grants you access to any Drake show.</li>
<li>If its become a golden ticket and is transferred, it loses its golden ticket superpower.</li>
</ul>
</li>
<li>Has utility
<ul>
<li>Unlocks exclusive media content feat. Drake hosted by OVO SOUND.</li>
<li>May become a golden ticket that grants you access to any Drake show.</li>
</ul>
</li>
<li>Has rules
<ul>
<li>Every time its transferred Supreme and OVO SOUND receive 25% of the transaction value.</li>
</ul>
</li>
</ul>
<a class="header" href="#rfc-0010codestructure" id="rfc-0010codestructure"><h1>RFC-0010/CodeStructure</h1></a>
<a class="header" href="#tari-code-structure-and-organisation" id="tari-code-structure-and-organisation"><h2>Tari code structure and organisation</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a></p>
<a class="header" href="#license-2" id="license-2"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright <YEAR> &lt;COPYRIGHT HOLDER | The Tari Development Community&gt;</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-2" id="language-2"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-2" id="disclaimer-2"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-2" id="goals-2"><h2>Goals</h2></a>
<p>This RFC describes and explains the Tari codebase layout.</p>
<a class="header" href="#related-rfcs-2" id="related-rfcs-2"><h2>Related RFCs</h2></a>
<p>None.</p>
<a class="header" href="#description-2" id="description-2"><h2>Description</h2></a>
<p>The code follows a Domain-Driven Design layout (<a href="https://en.wikipedia.org/wiki/Domain-driven_design" title="Wikipedia: Domain Driven Design">DDD</a>), with top-level directories falling into infrastructure, domain
and application layers.</p>
<a class="header" href="#infrastructure-layer" id="infrastructure-layer"><h3>Infrastructure layer</h3></a>
<p>This layer provides a set of crates which have general infrastructural utility. The rest of the Tari codebase can make use
of these crates to obtain persistence, communication and cryptographic services. The infrastructure layer doesn't know
anything about blockchains, transactions, or digital assets.</p>
<p>We recommend that code in this layer generalises infrastructure services behind abstraction layers as much as is
reasonable, so that specific implementations can be swapped out with relative ease.</p>
<a class="header" href="#domain-layer" id="domain-layer"><h3>Domain layer</h3></a>
<p>The Domain layer houses the Tari &quot;business logic&quot;. All protocol-related concepts and procedures are defined and
implemented here.</p>
<p>This entails that any and all terms defined in the <a href="../Glossary.html" title="Glossary">Glossary</a> will have a software implementation here, and only here.
They can be <em>used</em> in the Application layer, but must be implemented in the Domain layer.</p>
<p>The domain layer can make use of crates in the infrastructure layer to achieve its goals.</p>
<a class="header" href="#application-layer" id="application-layer"><h3>Application layer</h3></a>
<p>Applications build on top of the domain layer to produce the executable software that is deployed as part of the Tari
network.</p>
<p>As an example, the following base layer applications may be developed as part of the Tari protocol release:</p>
<ul>
<li>A standalone miner (tari_miner)</li>
<li>A pool miner (tari_pool_miner)</li>
<li>A CLI wallet for the Tari cryptocurrency (cli_wallet)</li>
<li>A base node executable (tari_basenode)</li>
<li>A REST API server for the base node</li>
</ul>
<a class="header" href="#code-layout" id="code-layout"><h3>Code layout</h3></a>
<p>The top-level source code directories in this repository reflect the respective <a href="https://en.wikipedia.org/wiki/Domain-driven_design" title="Wikipedia: Domain Driven Design">DDD</a> layers; except that there are two
domain layer directories, corresponding to the two network layers that make up the Tari network.</p>
<ol>
<li>
<p>The <code>infrastructure</code> directory contains application-layer code and is not Tari-specific. It holds the following
crates:</p>
<ul>
<li><code>comms</code>: The networking and messaging subsystem</li>
<li><code>crypto</code>: All cryptographic services, including a Curve25519 implementation</li>
<li><code>storage</code>: Data persistence services, including an LMDB persistence implementation</li>
<li><code>merklemountainrange</code>: An independant implementation of a merkle mountain range</li>
<li><code>derive</code>: A crate to contain <code>derive(...)</code> macros</li>
</ul>
</li>
<li>
<p><code>base_layer</code> is a domain-layer directory and contains:</p>
<ul>
<li><code>blockchain</code>: The Tari consensus code</li>
<li><code>core</code>: common classes and traits, such as <a href="../Glossary.html#transaction">Transaction</a>s and <a href="../Glossary.html#block">Block</a>s</li>
<li><code>mempool</code>: The unconfirmed transaction pool implementation</li>
<li><code>mining</code>: The merge-mining modules</li>
<li><code>p2p</code>: The block and transaction propagation module</li>
<li><code>api</code>: interfaces for clients and wallets to interact with the base layer components</li>
</ul>
</li>
<li>
<p><code>digital_assets_layer</code> is a domain-layer directory. It contains code related to the management of native Tari digital
assets.</p>
<ul>
<li>Its sub-structure is TBD.</li>
</ul>
</li>
<li>
<p><code>applications</code> contains crates for all the application-layer executables that form part of the Tari codebase.</p>
</li>
</ol>
<a class="header" href="#rfc-0100baselayer" id="rfc-0100baselayer"><h1>RFC-0100/BaseLayer</h1></a>
<a class="header" href="#the-tari-base-layer" id="the-tari-base-layer"><h2>The Tari Base Layer</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a></p>
<a class="header" href="#license-3" id="license-3"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2018 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-3" id="language-3"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-3" id="disclaimer-3"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-3" id="goals-3"><h2>Goals</h2></a>
<p>This document describes the major software components of the Tari Base Layer network.</p>
<a class="header" href="#related-rfcs-3" id="related-rfcs-3"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0001_overview.html">RFC-0001: Overview</a></li>
<li><a href="./RFC-0110_BaseNodes.html">RFC-0110: Base Nodes</a></li>
<li><a href="./RFC-0130_Mining.html">RFC-0130: Mining</a></li>
<li><a href="./RFC-0150_Wallets.html">RFC-0150: Wallets</a></li>
</ul>
<a class="header" href="#description-3" id="description-3"><h2>Description</h2></a>
<p>The Tari Base Layer network comprises the following major pieces of software:</p>
<ul>
<li>Base Layer full node implementation - The base layer full nodes are the consensus-critical pieces of software for the
Tari base layer and cryptocurrency. The base nodes validate and transmit transactions and blocks and maintain
consensus about the longest valid proof-of-work blockchain.</li>
<li>Mining software - Mining nodes perform proof-of-work to secure the base layer and compete to submit the
next valid block into the Tari blockchain. Tari is merge-mined with Monero. The Tari source provides two alternatives
for Tari miners:
<ul>
<li>A standalone miner</li>
<li>A stratum-compatible pool miner.</li>
</ul>
</li>
<li>Wallet software - Client software and APIs offering means to construct transactions, query nodes for information and
maintain personal private keys</li>
</ul>
<p>These three main pieces of software make use of common functionality provided by the following libraries within the Tari
project source code:</p>
<ul>
<li>Local data storage</li>
<li>Cryptography services</li>
<li>Peer-to-peer networking and messaging services</li>
</ul>
<p><a href="RFC-0010_CodeStructure.html">RFC-0010</a> provides more detail on how the source code is structured within the Tari codebase.</p>
<a class="header" href="#rfc-0110basenodes" id="rfc-0110basenodes"><h1>RFC-0110/BaseNodes</h1></a>
<a class="header" href="#base-layer-full-nodes-base-nodes" id="base-layer-full-nodes-base-nodes"><h2>Base Layer Full Nodes (Base Nodes)</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a> <a href="https://github.com/SWvheerden">SW van heerden</a></p>
<a class="header" href="#license-4" id="license-4"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-4" id="language-4"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-4" id="disclaimer-4"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-4" id="goals-4"><h2>Goals</h2></a>
<p>This document describes the roles that <a href="Glossary.html#base-node">base node</a>s play in the Tari network and their general approach for doing so.</p>
<a class="header" href="#related-rfcs-4" id="related-rfcs-4"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0100_BaseLayer.html">RFC-0100: Base layer</a></li>
</ul>
<a class="header" href="#description-4" id="description-4"><h2>Description</h2></a>
<a class="header" href="#broad-requirements" id="broad-requirements"><h3>Broad requirements</h3></a>
<p>Tari Base Nodes form a peer-to-peer network for a proof-of-work based blockchain running the <a href="Glossary.html#mimblewimble">Mimblewimble</a>
protocol. The proof of work is performed via merge mining with Monero. Arguments for this design are
presented <a href="RFC-0001_overview.html#proof-of-work">in the overview</a>.</p>
<p>Tari Base Nodes MUST carry out the following tasks:</p>
<ul>
<li>Validate all <a href="Glossary.html#transaction">Tari coin</a>s.</li>
<li>Propagate valid transactions to peer nodes.</li>
<li>Validate all new <a href="Glossary.html#block">block</a>s received.</li>
<li>Propagate validated new blocks to peer nodes.</li>
<li>Connect to peer nodes to catch up (sync) its blockchain state.</li>
<li>Provide historical block information to peers that are syncing.</li>
</ul>
<p>Once the Digital Assets Network goes live, Base Nodes will also need to support the tasks described in
<a href="RFC-0300_DAN.html">RFC-0300/Assets</a>. These requirements are omitted for the moment.</p>
<p>To carry out these tasks effectively, Base Nodes SHOULD:</p>
<ul>
<li>Save the <a href="Glossary.html#blockchain">blockchain</a> into a indexed local database.</li>
<li>Maintain an index of all unspent outputs (<a href="Glossary.html#unspent-transaction-outputs">UTXO</a>s).</li>
<li>Maintain a list of all pending, valid transactions that have not yet been mined (the <a href="Glossary.html#mempool">mempool</a>).</li>
<li>Manage a list of Base Node peers present on the network.</li>
</ul>
<p>Tari Base nodes MAY implement chain pruning strategies that are features of Mimblewimble, including transaction
<a href="https://tlu.tarilabs.com/protocols/grin-protocol-overview/MainReport.html#mimblewimble-protocol-overview">cut-through and block compaction techniques</a>.</p>
<p>Tari Base Nodes MAY also implement the following services via an API to clients. Such clients may include &quot;light&quot;
clients, block explorers, wallets, and Tari applications:</p>
<ul>
<li>Block queries.</li>
<li>Kernel data queries.</li>
<li>Transaction queries.</li>
<li>Submission of new transactions.</li>
</ul>
<a class="header" href="#transaction-validation-and-propagation" id="transaction-validation-and-propagation"><h3>Transaction validation and propagation</h3></a>
<p>Base nodes can be notified of new transactions by</p>
<ul>
<li>connected peers.</li>
<li>clients via APIs.</li>
</ul>
<p>When a new transaction has been received, it has the <code>unvalidated</code> <a href="Glossary.html#validationstate">ValidationState</a>. The transaction is then passed
to the transaction validation service, where its state will become either <code>rejected</code>, <code>timelocked</code> or <code>validated</code>.</p>
<p>The transaction validation service checks that:</p>
<ul>
<li>all inputs to the transaction are valid <a href="Glossary.html#unspent-transaction-outputs">UTXO</a>s.</li>
<li>no inputs are duplicated.</li>
<li>all inputs are able to be spent (they're not time-locked).</li>
<li>all inputs are signed by their owners.</li>
<li>all outputs have valid <a href="Glossary.html#range-proof">range proof</a>s.</li>
<li>no outputs currently exist in the <a href="Glossary.html#unspent-transaction-outputs">UTXO</a> set.</li>
<li>the transaction does not have <a href="RFC-0230_HTLC.html#time-locked-contracts">timelocks</a> applied, limiting it from being mined and added to the blockchain before a
specified block height or timestamp has been reached.</li>
<li>the transaction excess has a valid signature.</li>
<li>the transaction excess is a valid public key. This proves that:
$$ \Sigma \left( \mathrm{inputs} - \mathrm{outputs} - \mathrm{fees} \right) = 0 $$</li>
</ul>
<p><code>Rejected</code> transactions are dropped silently.</p>
<p><code>Timelocked</code> transactions are:</p>
<ul>
<li>marked with a timelocked status and gets added to the <a href="Glossary.html#mempool">mempool</a>.</li>
<li>will be evaluated again at a later state to determine if the timelock has passed and if it can be upgraded to 'Validated' status.</li>
<li>More detailed information in <a href="RFC-0230_HTLC.html#time-locked-contracts">timelocks</a> RFC document.</li>
</ul>
<p><code>Validated</code> transactions are:</p>
<ul>
<li>Added to the <a href="Glossary.html#mempool">mempool</a>.</li>
<li>forwarded to peers using the transaction <a href="Glossary.html#broadcaststrategy">BroadcastStrategy</a>.</li>
</ul>
<a class="header" href="#block-validation-and-propagation" id="block-validation-and-propagation"><h3>Block validation and propagation</h3></a>
<p>The Block validation and propagation process is analogous to that of transactions.</p>
<p>New blocks are received from the peer-to-peer network, or from an API call if the Base Node is connected to a Miner.</p>
<p>When a new block is received, it is assigned the <code>unvalidated</code> <a href="Glossary.html#validationstate">ValidationState</a>. The block is then passed to the
block validation service.  The validation service checks that</p>
<ul>
<li>the block hasn't been processed before.</li>
<li>every <a href="Glossary.html#transaction">transaction</a> in the block is valid.</li>
<li>the proof-of-work is valid.</li>
<li>the block header is well-formed.</li>
<li>the block is being added to the chain with the highest accumulated proof-of-work.
<ul>
<li>it is possible for the chain to temporarily fork; base nodes SHOULD account for forks up to some configured depth.</li>
<li>it is possible that blocks may be received out of order; particularly while syncing. Base Nodes SHOULD keep blocks.
that have block heights greater than the current chain tip in memory for some preconfigured period.</li>
</ul>
</li>
<li>the sum of all excesses is a valid public key. This proves that:
$$ \Sigma \left( \mathrm{inputs} - \mathrm{outputs} - \mathrm{fees} \right) = 0$$</li>
<li>check if <a href="RFC-0140_Syncing_and_seeding.html#pruning-and-cut-through">cut-through</a> was applied. If a block contains already spent outputs, reject that block.</li>
</ul>
<p>Because MimbleWimble blocks can be simple be seen as large transactions with multiple inputs and outputs, the block validation service checks all transaction verification on the block as well.</p>
<p><code>Rejected</code> blocks are dropped silently.</p>
<p>Base Nodes are not obliged to accept connections from any peer node on the network. In particular:</p>
<ul>
<li>Base Nodes MAY refuse connections from peers that have been added to a blacklist.</li>
<li>Base Nodes MAY be configured to exclusively connect to a given set of peer nodes.</li>
</ul>
<p><code>Validated</code> blocks are</p>
<ul>
<li>added to the <a href="Glossary.html#blockchain">blockchain</a>.</li>
<li>forwarded to peers using the block <a href="Glossary.html#broadcaststrategy">BroadcastStrategy</a>.</li>
</ul>
<p>In addition, when a block has been validated and added to the blockchain:</p>
<ul>
<li>The mempool MUST also remove all transactions that are present in the newly validated block.</li>
<li>The UTXO set MUST be updated; removing all inputs in the block, and adding all the new outputs in it.</li>
</ul>
<a class="header" href="#synchronising-and-pruning-of-the-chain" id="synchronising-and-pruning-of-the-chain"><h3>Synchronising and pruning of the chain</h3></a>
<p>Syncing, pruning and cut-through is discussed in detail in <a href="RFC-0140_Syncing_and_seeding.html">RFC-0140</a></p>
<a class="header" href="#archival-nodes" id="archival-nodes"><h3>Archival nodes</h3></a>
<p><a href="Glossary.html#archive-node">Archival nodes</a> are used to keep a complete history of the blockchain since genesis block, they do not employ pruning at all. These nodes will allow full syncing of the blockchain because normal nodes will not keep the full history to enable this.</p>
<a class="header" href="#rfc-0111basenodesarchitecture" id="rfc-0111basenodesarchitecture"><h1>RFC-0111/BaseNodesArchitecture</h1></a>
<a class="header" href="#base-node-architecture" id="base-node-architecture"><h2>Base Node Architecture</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a></p>
<a class="header" href="#license-5" id="license-5"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-5" id="language-5"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-5" id="disclaimer-5"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-5" id="goals-5"><h2>Goals</h2></a>
<p>Describe the high-level the Base Node architecture.</p>
<a class="header" href="#architectural-layout" id="architectural-layout"><h2>Architectural layout</h2></a>
<p>The base node architecture is designed to be modular, robust and performant.</p>
<p><img src="theme/images/base_layer_arch.png" alt="Base Layer architecture" /></p>
<p>The major components are separated into separate modules. Each module exposes a public API which typically communicates
with other modules using the <a href="https://en.wikipedia.org/wiki/Command_pattern">Command Pattern</a>.</p>
<a class="header" href="#base-node-service" id="base-node-service"><h3>Base Node Service</h3></a>
<p>The Base Node Service is an instantiation of a Tari Comms Service, which subscribes to and handles specific messages
coming from the P2P Tari network via the Comms Module of a live Tari communications node. The Base Node Service's job is
to delegate the jobs required by those messages to its submodules, consisting primarily of the Transaction Validation
Service and the Block Validation service.</p>
<p>The Base Node Service will pass messages back to the P2P network via the Comms Module based on the results of its
actions.</p>
<p>The primary messages that a Base Node will subscribe to are:</p>
<ul>
<li>
<p><strong>NewTransaction</strong>: A New Transaction is being propagated over the network. If it hasn't seen the transaction before,
the Base Node will validate the transaction and if it is valid:</p>
<ul>
<li>add it to its MemPool</li>
<li>pass the transaction onto peers.</li>
</ul>
<p>Otherwise the transaction is dropped.</p>
</li>
<li>
<p><strong>NewBlock</strong>: A newly mined block is being propagated over the network, If the node hasn't seen the block before, the
node will validate it. It's action depends on the validation outcome:</p>
<ul>
<li><em>Invalid block</em>: Drop the block.</li>
<li><em>Valid block appending to the longest chain</em>: Add the block to the local state; propagate the block to peers.</li>
<li><em>Valid block forking off main chain</em>: Add the block to the local state; propagate the block to peers.</li>
<li><em>Valid block building off unknown block</em>: Add the orphan block to local state.</li>
</ul>
</li>
<li>
<p><strong>Sync Request</strong>: A peer is synchronising state and is asking for block data. The node can decide to</p>
<ul>
<li>ignore or ban the peer (based on previous behaviour heuristics)</li>
<li>Try and provide the data, returning an appropriate response. Note that most nodes can only offer block data up until
their pruning horizon. Only full archival nodes can return the full block history. See
<a href="RFC-0140_Syncing_and_seeding.html">RFC-0140</a> for more details.</li>
</ul>
</li>
</ul>
<p>The validation procedures are complex and thus are encapsulated into their own sub-services. These services hold
references to the blockchain state API, the mempool API, a range proof service and whatever other modules they need to
complete their work. Each validation module has a single primary method, <code>validate_xxx()</code>, which takes in the
transaction or block to be validated and carries out the validation logic.</p>
<a class="header" href="#dht-service" id="dht-service"><h3>DHT Service</h3></a>
<p>Peer discovery is a key service that blockchain nodes provide so that the peer mesh network can be navigated by the full
nodes making up the network.</p>
<p>In Tari, the peer-to-peer network is used by more than just full nodes (Base Nodes), but also by Validator Nodes, and
Tari and DAN clients.</p>
<p>For this reason, peer management is handled by the Comms layer internally. If a Base Node wants to propagate a message,
a new Block or Transaction, for example, it simply selects a <code>BROADCAST</code> strategy for the message and the comms layer
will do the rest.</p>
<p>When a node wishes to query a peer for it's peer list, this request will be handled by the <code>DHTService</code>. It will
communicate with its Comms module's Peer Manager, and provide that information to the peer.</p>
<a class="header" href="#blockchain-state-module" id="blockchain-state-module"><h3>Blockchain state module</h3></a>
<p>The blockchain state module is responsible for providing a persistent storage solution for blockchain state data. For
Tari, this is delivered using the memory-mapped database LMDB. LMDB is highly performant, intelligent and
straightforward to use. An LMDB database is essentially treated as a hash map data structure that transparently handles
memory caching, disk I/O, and multithreaded access.</p>
<p>The blockchain module is able to run as a standalone service. All communication with clients is done via message
channels. This allows the blockchain state service to completely control and manage read and write access to the
underlying blockchain state, reducing the scope for race conditions and deadlocks.</p>
<p>Since a message-based approach is employed, <em>no read-write locks are required</em> at the blockchain state module level.</p>
<p>Rust's channel infrastructure in the standard library is fairly limited. Therefore we propose to use the
<a href="https://crates.io/crates/crossbeam-channel">crossbeam-channel</a> and <a href="https://crates.io/crates/crossbeam-queue">crossbeam-queue</a> libraries for managing message passing between the blockchain state module and
its clients. Messages are constructed using Rust enums using the <a href="https://en.wikipedia.org/wiki/Command_pattern">Command Pattern</a>.</p>
<p>Inside the Blockchain state module, data access could be managed by a single thread. However, since we're managing
requests via a single message queue, and LMDB can handle multiple thread access it is fairly straightforward to extend
data access to multiple threads using a <a href="https://crates.io/crates/threadpool">thread pool</a>.</p>
<p>The blockchain state API will be fairly rich, since it will serve not only base nodes talking to the Tari P2P network,
but also applications such as block explorers and monitoring programs via a <a href="https://grpc.io/">gRPC</a> interface.</p>
<p>A non-exhaustive list of methods the blockchain state module API will expose include:</p>
<ul>
<li>checking whether a given UTXO is in the current UTXO set</li>
<li>requesting the latest block height</li>
<li>requesting the total accumulated work on the longest chain</li>
<li>request a specific block at a given height</li>
<li>request the merklish root commitment of the current UTXO set</li>
<li>request a block header for a given height</li>
<li>request the block header for the chain tip</li>
<li>validate signatures for a given transaction kernel</li>
<li>validate a new block without adding it to the state tree</li>
<li>validate and add a (validated) new block to the state, and inform of the result (orphaned, fork, re-org, etc)</li>
</ul>
<a class="header" href="#mempool-module" id="mempool-module"><h3>Mempool module</h3></a>
<p>The mempool module tracks (valid) transactions that the node knows about but that have not yet been included into a
block. The mempool is ephemeral and non-consensus critical and as such may be a memory-only data structure. Maintaining
a large mempool is far more important for base nodes serving miners than those serving wallets. A mempool will slowly
rebuild after a node reboots.</p>
<p>That said, the mempool module must be thread safe. The Tari Mempool module handles requests in the same way as the
Blockchain state module does: via <a href="https://crates.io/crates/crossbeam-channel">crossbeam-channel</a> queues. The mempool structure itself is a set of hash maps as
described in <a href="RFC-0190_Mempool.html">RFC-0190</a>. For performance reasons, it may be worthwhile using a <a href="https://crates.io/crates/chashmap">concurrent hash map</a> implementation
backed by a <a href="https://crates.io/crates/threadpool">thread pool</a>, although a single thread may suffice.</p>
<a class="header" href="#grpc-interface" id="grpc-interface"><h3>gRPC interface</h3></a>
<p>Base nodes need to provide a local communication interface in a addition to the P2P communication interface. This is
best achieved using <a href="https://grpc.io/">gRPC</a>. The Base node gRPC interface provides access to the public API methods of the base node
service, the mempool module and the blockchain state module, as discussed above.</p>
<p>gRPC access is useful for tools like local UIs to a running base node; client wallets running on the same machine as the
base node that want a more direct communication interface to the node than the P2P network provides, third party
applications such as block explorers, and of course, miners.</p>
<a class="header" href="#rfc-0130mining" id="rfc-0130mining"><h1>RFC-0130/Mining</h1></a>
<a class="header" href="#full-node-mining-on-tari-base-layer" id="full-node-mining-on-tari-base-layer"><h2>Full-node mining on Tari base layer</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: [Yuko Roodt] (https://github.com/neonknight64)</p>
<a class="header" href="#license-6" id="license-6"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2018 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-6" id="language-6"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all
capitals, as shown here.</p>
<a class="header" href="#disclaimer-6" id="disclaimer-6"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in theprocess of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-6" id="goals-6"><h2>Goals</h2></a>
<p>This document will provide a brief overview of the Tari merged mining process and will introduce the primary
functionality required of the Mining Server and Mining Worker.</p>
<a class="header" href="#related-rfcs-5" id="related-rfcs-5"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0100_BaseLayer.html">RFC-0100: Base layer</a></li>
<li><a href="RFC-0110_BaseNodes.html">RFC-0110: Base nodes</a></li>
</ul>
<a class="header" href="#description-5" id="description-5"><h2>Description</h2></a>
<a class="header" href="#assumptions" id="assumptions"><h3>Assumptions</h3></a>
<ul>
<li>That the Tari <a href="Glossary.html#blockchain">blockchain</a> will be merged mined with Monero.</li>
<li>The Tari <a href="Glossary.html#base-layer">Base Layer</a> has a network of <a href="Glossary.html#base-node">Base Node</a>s that verify and propagate valid <a href="Glossary.html#transaction">transaction</a>s and <a href="Glossary.html#block">block</a>s.</li>
</ul>
<a class="header" href="#abstract-1" id="abstract-1"><h3>Abstract</h3></a>
<p>The process of merged mining Tari with Monero on the Tari Base Layer is performed by <a href="Glossary.html#mining-server">Mining Server</a>s and <a href="Glossary.html#mining-worker">Mining
Worker</a>s. Mining Servers are responsible for constructing new blocks by bundling transactions from the <a href="Glossary.html#mempool">mempool</a>
of a connected Base Node. They then distribute Proof-of-Work(PoW) tasks to Mining Workers in an attempt to solve
newly created blocks. Solved solutions and shares are sent by the Mining Workers to the Mining Server, who in turns
verifies the solution and distributes the newly created blocks to the Base Node and Monero Node for inclusion in
their respective blockchains.</p>
<a class="header" href="#merged-mining-on-the-tari-base-layer" id="merged-mining-on-the-tari-base-layer"><h3>Merged mining on the Tari Base Layer</h3></a>
<p>This document is divided into three parts. First, a brief overview of the merged mining process and the interactions
between the Base Node, Mining Server and Mining Worker will be provided, then the primary functionality required
of the Mining Server and Mining Worker will be proposed.</p>
<a class="header" href="#overview-of-the-tari-merged-mining-process-using-mining-servers-and-mining-workers" id="overview-of-the-tari-merged-mining-process-using-mining-servers-and-mining-workers"><h4>Overview of the Tari merged mining process using Mining Servers and Mining Workers</h4></a>
<p>Mining on the Tari Base Layer consists of three primary entities: the Base Nodes, Mining Servers and Mining Workers.
A description of the Base Node is provided in [RFC-0110/Base Nodes] (https://tari-project.github.io/tari/RFC-0110_BaseNodes.html).
A Mining Server is connected locally or remotely to a Tari Base Node and a Monero Node, and is responsible for
constructing Tari and Monero Blocks from their respective mempools. The Mining Server should retrieve transactions
from the mempool of the connected Base Node and assemble a new Tari block by bundling transactions together.</p>
<p>Mining servers may re-verify transactions before including them in a new Tari block, but this enforcement of
verification and transaction rules such as signatures and timelocks are the responsibility of the connected Base node. Mining servers are responsible for <a href="RFC-0140_Syncing.html#Pruning-and-cut-through">cut-through</a> as this is required for scalability and privacy.</p>
<p>To enable Merged mining of Tari with Monero, both a Tari and a Monero block needs to be created and linked. First,
a new Tari block is created and then the block header hash of the new Tari block is included in the coinbase
transaction of the new Monero block. Once a new merged mined Monero block has been constructed, PoW tasks can then
be sent to the connected Mining Workers that will attempt to solve the block by performing the latest released
version of the PoW algorithm selected by Monero.</p>
<p>Assuming the Tari difficulty is less than the Monero difficulty, miners get rewarded for solving the PoW at any
difficulty above the Tari difficulty. If the block is solved above the Tari difficulty, a new Tari block is mined.
If the difficulty is also greater than the Monero difficulty, a new Monero block is mined as well. In either event,
the header for the candidate Monero block is included in the Tari block header.</p>
<p>If the PoW solution was sufficient to meet the difficult level of both the Tari and Monero blockchains, then the
individual blocks for each blockchain can be sent from the Mining Server to the Base Node and Monero Node to be
added to the respective blockchains.</p>
<p>Every Tari block must include the solved Monero block’s information (block header hash, Merkle tree branch, and
hash of the coinbase transaction) into the PoW summary section of the Tari block header.
If the PoW solution found by the Mining Workers only solved the problem at the Tari difficulty, the Monero block can be discarded.</p>
<p>This process will ensure that the Tari difficulty remains independent. Adjusting the difficulty will ensure that
the Tari block times are preserved. Also, the Tari block time can be less than, equal
or greater than the Monero block times. A more detailed description of the Merged Mining process between a Primary
and Auxiliary blockchain is provided in the [Merged Mining TLU report] (https://tlu.tarilabs.com/merged-mining/merged-mining.html).</p>
<a class="header" href="#functionality-required-by-the-tari-mining-server" id="functionality-required-by-the-tari-mining-server"><h4>Functionality required by the Tari Mining Server</h4></a>
<ul>
<li>The Tari blockchain MUST have the ability to be merged mined with Monero.</li>
<li>The Mining Server MUST maintain a local or remote connection with a Base Node and a Monero Node.</li>
<li>It MUST have a mechanism to construct a new Tari and Monero block by selecting transactions from the different
Tari and Monero mempools that need to be included in the different blocks.</li>
<li>It MUST apply <a href="RFC-0140_Syncing.html#Pruning-and-cut-through">cut-through</a> when mining Tari transactions from the <a href="Glossary.html#mempool">mempool</a> and only add the excess to the list of new  Tari block transactions.</li>
<li>It MAY have a configurable transaction selection mechanism for the block construction process.</li>
<li>It MAY have the ability to re-verify transactions before including them in a new Tari block.</li>
<li>It MUST have the ability to include the block header hash of the new Tari block into the coinbase section of a
newly created Monero block to enable merged mining.</li>
<li>It MUST be able to include the Monero block header hash, Merkle tree branch and hash of the coinbase transaction
of the Monero block into the PoW summary field of the new Tari block header.</li>
<li>It MUST have the ability to transmit and distribute PoW tasks for the newly created Monero block, that contains
the Tari block information, to connected Mining Workers.</li>
<li>It MUST verify PoW solutions received from Mining Workers and it MUST reject and discard invalid solutions or
solutions that do not meet the minimum required difficulty.</li>
<li>The Mining Server MAY keep track of mining share contributions of the connected Mining Workers.</li>
<li>It MUST submit completed Tari blocks to the Tari Base Node.</li>
<li>It MUST submit completed Monero blocks to the Monero Network.</li>
</ul>
<a class="header" href="#functionality-required-by-the-tari-mining-worker" id="functionality-required-by-the-tari-mining-worker"><h4>Functionality required by the Tari Mining Worker</h4></a>
<ul>
<li>It MUST maintain a local or remote connection to a Mining Server.</li>
<li>It MUST have the ability to receive PoW tasks from the connected Mining Server.</li>
<li>It MUST have the ability to perform the latest released version of Monero's PoW algorithm on the received PoW tasks.</li>
<li>It MUST attempt to solve the PoW task at the difficulty specified by the Mining Server.</li>
<li>It MUST submit completed shares to the connected Mining Server.</li>
</ul>
<a class="header" href="#rfc-0140syncandseeding" id="rfc-0140syncandseeding"><h1>RFC-0140/SyncAndSeeding</h1></a>
<a class="header" href="#syncing-strategies-and-objectives" id="syncing-strategies-and-objectives"><h2>Syncing strategies and objectives</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/SWvheerden">SW van heerden</a></p>
<a class="header" href="#license-7" id="license-7"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2018 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-7" id="language-7"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-7" id="disclaimer-7"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-7" id="goals-7"><h2>Goals</h2></a>
<p>This document describes the process of Syncing, seeding, pruning and cut-through.</p>
<a class="header" href="#related-rfcs-6" id="related-rfcs-6"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0110_BaseNodes.html">RFC-0110: Base Nodes</a></li>
</ul>
<a class="header" href="#descriptions" id="descriptions"><h2>Descriptions</h2></a>
<a class="header" href="#syncing" id="syncing"><h3>Syncing</h3></a>
<p>When a new node comes online, loses connection or encounters a chain re-organisation that is longer than it can tolerate, it must enter syncing mode. This will allow it to recover its state to the newest up to date state. Syncing can be divided into 2 <a href="Glossary.html#synchronisationstrategy">SynchronisationStrategy</a>s, complete sync and sync. Complete sync will mean that the node communicates with an archive node to get the complete history of every single block from genesis block. Sync will involve the node getting every block from its <a href="pruninghorizon">pruning horizon</a> to [current head](current head), as well as every block header from genesis block.</p>
<a class="header" href="#complete-sync" id="complete-sync"><h4>Complete Sync</h4></a>
<p>Complete sync is only available from archive nodes, as these will be the only nodes that will be able to supply the complete history required to sync every block with every transaction from genesis block up onto <a href="currenthead">current head</a>.</p>
<a class="header" href="#syncing-process" id="syncing-process"><h4>Syncing process</h4></a>
<p>The syncing process MUST be done in the following steps:</p>
<ol>
<li>Set <a href="Glossary.html#synchronisationstate">SynchronisationState</a> to <code>Synchronising</code>.</li>
<li>Asks peers for their latest block, so it can get the total proof of work.</li>
<li>Choose the longest chain based on total PoW done on that chain.</li>
<li>Selects a connected peer with the longest chain to sync from, this is based on the following criteria:
<ol>
<li>Does the peer have a high enough <a href="pruninghorizon">pruning horizon</a>.</li>
<li>Does the peer allow syncing.</li>
<li>Does the peer have a low latency.</li>
</ol>
</li>
<li>Download all headers from genesis block up onto <a href="currenthead">current head</a>, and validate the headers as you receive them.</li>
<li>Download <a href="utxo">UTXO</a> set at <a href="pruninghorizon">pruning horizon</a>.</li>
<li>Download all blocks from  <a href="pruninghorizon">pruning horizon</a> up to <a href="currenthead">current head</a>, if the node is doing a complete sync, the <a href="pruninghorizon">pruning horizon</a> will just be infinite, which means you will download all blocks ever created.</li>
<li>Validate blocks as if they where just mined and then received, in chronological order.</li>
</ol>
<p>After this process the node will be in sync and able to process blocks and transaction normally.</p>
<a class="header" href="#keeping-in-sync" id="keeping-in-sync"><h4>Keeping in sync</h4></a>
<p>The node SHOULD periodically test its peers with ping messages to ensure that they are alive. When a node sends a ping message, it MUST include the current total PoW, hash of the <a href="currenthead">current head</a> and genesis block hash of its own current longest chain in the ping message. The receiving node MUST reply with a pong message also including the total PoW, <a href="currenthead">current head</a> and genesis block hash of its longest chain. If the two chains don't match up, the node with the lowest PoW has the responsibility to ask the peer for syncing information and set <a href="Glossary.html#synchronisationstate">SynchronisationState</a> to <code>Synchronising</code>.</p>
<p>If the genesis block hashes don't match, the node is removed from its peer list as this node is running a different blockchain.</p>
<p>This will be handled by the node asking for each block header from the <a href="currenthead">current head</a> going backward for older blocks until a known block is found. If a known block is found, and it has missing blocks it MUST set <a href="Glossary.html#synchronisationstate">SynchronisationState</a> to <code>Synchronising</code> while it is busy catching up those blocks.</p>
<p>If no block is found, the node will enter sync mode and resync. It cannot recover from its state as the fork is older than its <a href="pruninghorizon">pruning horizon</a>.</p>
<a class="header" href="#chain-forks" id="chain-forks"><h4>Chain forks</h4></a>
<p>Chain forks can be a problem since in Mimblewimble not all nodes keep the complete transaction history, the design philosophy is more along the lines of only keeping the current <a href="blockchainstate">Blockchain state</a>. However, if such a node only maintains only the current <a href="blockchainstate">Blockchain state</a> it is not possible for the node to &quot;rewind&quot; its state to handle forks in the chain history. In this case, a mode must re-sync its chain to recover the necessary transaction history up onto its <a href="pruninghorizon">pruning horizon</a>.</p>
<p>To counter this problem we use  <a href="pruninghorizon">pruning horizon</a>, this allows every [node](base node) to be a &quot;light&quot; <a href="archivenode">archival node</a>. This in effect means that the node will keep a full history for a short while. If the node encounters a fork it can easily rewind its state to apply the fork. If the fork is longer than the <a href="pruninghorizon">pruning horizon</a>, the node will enter a sync state where it will resync.</p>
<a class="header" href="#pruning-and-cut-through" id="pruning-and-cut-through"><h3>Pruning and cut-through</h3></a>
<p>[Pruning and cut-through]: #Pruning-and-cut-through &quot;Remove already spent outputs from the <a href="Glossary.html#unspent-transaction-outputs">utxo</a>&quot;</p>
<p>In Mimblewimble, the state can be completely verified using the current <a href="utxo">UTXO</a> set (which contains the output commitments and range proofs), the set of excess signatures (contained in the transaction kernels) and the proof-of-work. The full block and transaction history is not required. This allows base layer nodes to remove old used inputs from the <a href="Glossary.html#blockchain">blockchain</a> and or the <a href="Glossary.html#mempool">mempool</a>. <a href="cut-through">Cut-through</a> happens in the <a href="Glossary.html#mempool">mempool</a> while pruning happens in the <a href="Glossary.html#blockchain">blockchain</a> with already confirmed transactions. This will remove the spent inputs and outputs, but will retain the excesses of each <a href="Glossary.html#transaction">transaction</a>.</p>
<p>Pruning is only for the benefit of the local base node as it reduces the local blockchain size. Pruning only happens after the block is older than the <a href="pruninghorizon">pruning horizon</a> height. A Base node will either run in archive mode or prune mode, if the base node is running in archive mode it MUST NOT prune.</p>
<p>When running in pruning mode, <a href="Glossary.html#base-node">base node</a>s have the following responsibilities:</p>
<ol>
<li>MUST remove all spent outputs that is older than the <a href="pruninghorizon">pruning horizon</a> in it's current stored <a href="utxo">UTXO</a> when a new block is received from another <a href="Glossary.html#base-node">base node</a>.</li>
</ol>
<a class="header" href="#rfc-0150wallets" id="rfc-0150wallets"><h1>RFC-0150/Wallets</h1></a>
<a class="header" href="#base-layer-wallet-module" id="base-layer-wallet-module"><h2>Base layer wallet module</h2></a>
<p><img src="https://github.com/tari-project/tari/raw/master/RFC/src/theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/neonknight64">Yuko Roodt</a>, <a href="https://github.com/CjS77">Cayle Sharrock</a></p>
<a class="header" href="#license-8" id="license-8"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-8" id="language-8"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-8" id="disclaimer-8"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-8" id="goals-8"><h2>Goals</h2></a>
<p>This document will propose the functionality and techniques required by the <a href="Glossary.html#base-layer">Base Layer</a> Tari <a href="Glossary.html#wallet">wallet</a> module. The module
exposes the core wallet functionality that user-facing wallet applications may be built on.</p>
<a class="header" href="#related-rfcs-7" id="related-rfcs-7"><h2>Related RFCs</h2></a>
<ul>
<li><a href="https://github.com/tari-project/tari/blob/master/RFC/src/RFC-0100_BaseLayer.md">RFC-0100: Base layer</a></li>
</ul>
<p>This RFC is derived from a proposal first made in <a href="https://github.com/tari-project/tari/issues/17">this issue</a>.</p>
<a class="header" href="#description-6" id="description-6"><h2>Description</h2></a>
<a class="header" href="#key-responsibilities" id="key-responsibilities"><h3>Key responsibilities</h3></a>
<p>The wallet software is responsible for constructing and negotiating <a href="Glossary.html#transaction">transaction</a>s for transferring and receiving <a href="Glossary.html#tari-coin">Tari coin</a>s on the Base Layer. It should also provide functionality to generate, store and recover a master seed key and derived cryptographic key pairs that can be used for Base Layer addresses and signing of transactions.</p>
<a class="header" href="#details-of-functionality" id="details-of-functionality"><h3>Details of functionality</h3></a>
<p>A detailed description of the required functionality of the Tari software wallet is provided in three parts:</p>
<ul>
<li>Basic transaction functionality,</li>
<li>Key management features and</li>
<li>the different wallet recovery methods.</li>
</ul>
<a class="header" href="#basic-transaction-functionality" id="basic-transaction-functionality"><h4>Basic transaction functionality</h4></a>
<ul>
<li>It MUST be able to send and receive Tari coins using <a href="Glossary.html#mimblewimble">Mimblewimble</a> transactions.</li>
<li>It SHOULD be able to establish a connection between different user wallets to negotiate:
<ul>
<li>the construction of a transaction and</li>
<li>the signing of multi signature transactions.</li>
</ul>
</li>
<li>The Tari software wallet SHOULD be implemented as a library or API so that GUI or CLI applications can be developed on top of it.</li>
<li>It MUST be able to establish a connection to a <a href="Glossary.html#base-node">Base Node</a> to submit transactions and monitor the Tari <a href="Glossary.html#blockchain">blockchain</a>.</li>
<li>It SHOULD maintain an internal ledger to keep track of the Tari coin balance of the wallet.</li>
<li>It MAY offer transaction fee estimation taking into account:
<ul>
<li>transaction byte size,</li>
<li>network congestion and</li>
<li>the desired transaction priority.</li>
</ul>
</li>
<li>It SHOULD be able to monitor and return the states (Spent, Unspent or Unconfirmed) of previously submitted transactions by querying information from the connected base node.</li>
<li>The Wallet SHOULD present the total Spent, Unspent or Unconfirmed transactions in summarised form.</li>
<li>The wallet software SHOULD be able to update its software to patch potential security vulnerabilities. Automatic updating SHOULD be selected by default, but users can decide to opt out.</li>
<li>Wallet features requiring querying a base node for information, SHOULD have caching capabilities to reduce bandwidth consumption.</li>
</ul>
<a class="header" href="#key-management-features" id="key-management-features"><h4>Key management features</h4></a>
<ul>
<li>It MUST be able to generate a master seed key for the wallet by using one of:
<ul>
<li>input from a user (for example, when restoring a wallet, or in testing),</li>
<li>a user defined set of mnemonic word sequences using known word lists,</li>
<li>a cryptographically secure random number generator.</li>
</ul>
</li>
<li>It SHOULD be able to generate derived transactional cryptographic key pairs from the master seed key using deterministic key pair generation.</li>
<li>It SHOULD store the wallet state using a password or passphrase encrypted persistent key-value database.</li>
<li>It SHOULD provide the ability to backup the wallet state to a single encrypted file to simplify wallet recovery and reconstruction at a later stage.</li>
<li>It MAY provide the ability to export the master seed key or wallet state as a printable paper wallet using coded markers.</li>
</ul>
<a class="header" href="#different-methods-for-recovering-the-wallet-state-of-the-tari-software-wallet" id="different-methods-for-recovering-the-wallet-state-of-the-tari-software-wallet"><h4>Different methods for recovering the wallet state of the Tari software wallet:</h4></a>
<ul>
<li>It MUST be able to reconstruction the wallet state from a manually entered master seed key.</li>
<li>It MUST have a mechanism to systematically search through the Tari blockchain and mempool for unspent and unconfirmed transactions using the keys derived from the master key.</li>
<li>The master seed key SHOULD be derivable from a specific set of mnemonic word sequences using known word lists.</li>
<li>It MAY enable the reconstruction of the master seed key by scanning a coded marker of a paper wallet.</li>
</ul>
<a class="header" href="#transactionprotocol" id="transactionprotocol"><h1>TransactionProtocol</h1></a>
<a class="header" href="#transaction-protocol" id="transaction-protocol"><h2>Transaction protocol</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: Cayle Sharrock <CjS77></p>
<a class="header" href="#license-9" id="license-9"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019. The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-9" id="language-9"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-9" id="disclaimer-9"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-9" id="goals-9"><h2>Goals</h2></a>
<p>This document describes the transaction protocol for peer-to-peer Tari payments using the Mimblewimble protocol. It also
considers some attacks that may be launched against the protocol and offers some discussion around those attacks and
potential alternatives to the protocol.</p>
<p>The goal is to describe a transaction protocol that</p>
<ul>
<li>permits multiple recipients,</li>
<li>preserves privacy regarding how many parties are involved in the transaction,</li>
<li>is secure against all reasonable attacks.</li>
</ul>
<a class="header" href="#related-rfcs-8" id="related-rfcs-8"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0100_BaseLayer.html">RFC-0100: The Base Layer</a></li>
</ul>
<a class="header" href="#description-7" id="description-7"><h2>Description</h2></a>
<p>The Tari base layer is built using <a href="https://tlu.tarilabs.com/protocols/grin-protocol-overview/MainReport.html" title="Mimblewimble on TLU">Mimblewimble</a>, which requires that all parties involved in a Tari transfer must interact
to construct a valid <a href="https://tlu.tarilabs.com/protocols/mimblewimble-1/MainReport.html" title="Mimblewimble
transactions on TLU">Mimblewimble transaction</a>.</p>
<p>A valid transaction involves:</p>
<ul>
<li>A set of one or more inputs being spent by the Sender,</li>
<li>A set of zero or more outputs being sent to the Sender,</li>
<li>A set of recipients, each of whom MUST construct exactly one output,</li>
<li>A set of partial schnorr signatures that when aggregated, validates the transaction construction and indicates every
party's satisfaction with the terms.</li>
</ul>
<a class="header" href="#the-issue-with-multiple-recipients" id="the-issue-with-multiple-recipients"><h3>The issue with multiple recipients</h3></a>
<p>Each party involved in a Tari transaction must produce a partial signature signing the same challenge. This challenge is
defined as</p>
<p>$$ e = H(\Sigma R_i \Vert \Sigma P_i \Vert m) $$</p>
<p>where \(R_i\) are public nonces generated by each party for this signature; \(P_i\) are the public <a href="Glossary.html#spending-key">Spending Key</a>s;
and <em>m</em> is the additional metadata for the transaction. \(\Sigma P_i\) is the value of the (pre-offset) excess that is
stored in the transaction kernel.</p>
<p>Notice that every signing party needs to know the sum of all the nonces and public spending keys. This suggests that
every party knows how many parties are involved in the transaction, which is not an ideal privacy scenario. It would be
preferable if a secure scheme could be found where each recipient interacts only with the sender and does not need to
calculate these sums themselves.</p>
<p>Unfortunately, as we discuss below, it seems that it's not possible using any known scheme that satisfies both this
privacy goal while achieving the desired security level.</p>
<a class="header" href="#the-issue-with-multiple-senders" id="the-issue-with-multiple-senders"><h3>The issue with multiple senders</h3></a>
<p>To increase privacy, the public excess values are <a href="https://github.com/mimblewimble/grin/blob/master/doc/intro.md#kernel-offsets">offset</a> by a constant random value. The choice of this value, as well
as fee selection, can only be set once per transaction. The privilege of selecting these values is generally bestowed on
the sender, since she pays the fee. Allowing multiple sending parties (or equivalently, allowing recipients to provide
inputs) would require a negotiation round to set the fee and offset before the transaction could be constructed. This is
a complication we don't want to deal with, and so all schemes presented here allow exactly one sender.</p>
<a class="header" href="#two-party-transactions" id="two-party-transactions"><h3>Two-party transactions</h3></a>
<p>Two party transactions are fairly straightforward and are described in detail on TLU. (See <a href="https://tlu.tarilabs.com/protocols/mimblewimble-1/MainReport.html" title="Mimblewimble
transactions on TLU">Mimblewimble transaction</a>).</p>
<p>It is proposed that Tari implement this single-round 2-party transaction scheme as a special case to support both online
2-party transactions as well as &quot;offline&quot; transactions such as via e-mail, text-message, carrier pigeon etc.</p>
<a class="header" href="#multiple-recipient-transaction-scheme" id="multiple-recipient-transaction-scheme"><h3>Multiple recipient transaction scheme</h3></a>
<div class="mermaid">
sequenceDiagram
    participant Sender
    participant Receivers
# Sender Initializes the transaction
    activate Sender
        Sender-->>Sender: initialize
    deactivate Sender
# Sender transmits initial data to all receivers
    activate Sender
        Sender-->>+Receivers: [tx_id, amt_i,H(Rs||Xs),m]
        note left of Sender: CollectingCommitments
        note right of Receivers: SendingCommitment
        Receivers-->>-Sender: [tx_id, H(Ri||Pi)]
     deactivate Sender
# Receiving Outputs
     activate Sender
        Sender-->>+Receivers: [tx_id, [Hashed commitments]]
        note left of Sender: CollectingPubKeys
        note right of Receivers: SendingOutput
        Receivers-->>-Sender: [tx_id, Pi, Ri, C_i, RP_i]
    deactivate Sender
    alt inflation_error()?
        Sender--XReceivers: [tx-id, failed]
    end
# Signature collection
    activate Sender
        Sender-->>+Receivers: [tx_id, [Rs, Ri] [Xs, Pi]]
        note left of Sender: CollectingSignatures
        note right of Receivers: Signing
        Receivers-->>Receivers: validate nonces, pubkeys and pubkey sum
        alt invalid
           Receivers--XSender: failed
        end
        Receivers-->>Receivers: Sign
        Receivers-->>-Sender: [tx_id, s_i]
    deactivate Sender
# Sender sends final notification of result
    note left of Sender: Finalizing
    alt is_valid()
      Sender-->>Receivers: [tx_id, OK]
    else invalid
      Sender--XReceivers: [tx_id, Failed]
    end
</div>
<p>** Legend **</p>
<table><thead><tr><th align="left"> Symbol </th><th align="left"> Meaning                       </th></tr></thead><tbody>
<tr><td align="left"> tx_id  </td><td align="left"> Transaction identifier        </td></tr>
<tr><td align="left"> amt_i  </td><td align="left"> Amount sent to i-th recipient </td></tr>
<tr><td align="left"> Rs, Ri </td><td align="left"> Public nonce                  </td></tr>
<tr><td align="left"> Xs, Pi </td><td align="left"> Public excess / key           </td></tr>
<tr><td align="left"> m      </td><td align="left"> Message metadata              </td></tr>
<tr><td align="left"> C_i    </td><td align="left"> Commitment                    </td></tr>
<tr><td align="left"> RP_i   </td><td align="left"> Range proof                   </td></tr>
<tr><td align="left"> [..] </td><td align="left"> Vector of data                </td></tr>
</tbody></table>
<a class="header" href="#transaction-id" id="transaction-id"><h2>Transaction ID</h2></a>
<p>The scheme above makes use of a <code>tx_id</code> field in every peer-to-peer message. Since all messages are stateless and
asynchronous, peers need some way of figuring out which message refers to which transaction. The transaction id fulfils
this role.</p>
<p>The ID does not appear on the blockchain in any manner; is purely used to disambiguate Tari transaction messages; and
can be discarded after the transaction is broadcast to the network.</p>
<p>The <code>tx_id</code> is unique for every receiver so that any observers of the communication won't be able to group receivers
together (the communication should be over secure channels in general though).</p>
<p>The format of the transaction ID is a 4-byte little endian integer (u64) and is
calculated as</p>
<pre><code class="language-text">H(Rs||i)[0..4]
</code></pre>
<p>where <code>i</code> is the i-th recipient in the transaction. The sender can use the <code>tx_id</code> as a hash map key to identify and
differentiate recipients.</p>
<a class="header" href="#replay-attacks" id="replay-attacks"><h2>Replay attacks</h2></a>
<p>If any party can be convinced to sign a different message with the same nonce, their private keys will be lost. One way
of achieving this would be if a virtual machine could be &quot;snapshotted&quot; or otherwise cloned at any point between sharing
the public nonce and signing the message. Both copies of the victim's machine will now continue unaware that there's a
copy participating in a signature round. What then happens is:</p>
<p>$$
\begin{align}
&amp;\text{Clone A} &amp; &amp;\text{Clone B} \\
e_1 &amp;= H(r_1 \Vert r_s \Vert \dots) &amp; e_2 &amp;= H(r_1 \Vert r_s^* \Vert \dots) \\
s_1 &amp;= r_1 + e_1 \cdot k_1 &amp; s_2 &amp;= r_1 + e_2 \cdot k_1 \\
\end{align}
$$</p>
<p>The attacker receives both signatures and trivially calculates the secret key:</p>
<p>$$
\begin{align}
\Delta s &amp;= s_1 - s_2 \\
&amp;= k_1(e_1 - e_2) = k_1\Delta e \\
\Rightarrow k_1 &amp;= \frac{\Delta s}{\Delta e}
\end{align}
$$</p>
<p>We've demonstrated this with the attacker changing his nonce, but literally any alteration to the challenge will provide
a new challenge \(e_2\), enabling the attack.</p>
<p>What can we do about this? In fact, it's not possible to eliminate this attack at all! The reason sits with the proof
that the Schnorr scheme works as a zero-knowledge protocol; the demonstration of this proof is precisely the attack
we're trying to avoid [<a href="https://medium.com/magicofc/interactive-proofs-and-zero-knowledge-b32f6c8d66c3" title="On Interactive Proofs and
Zero-Knowledge: A Primer [Section 3]">GOL19</a>]. If we could eliminate this attack, we'd need to come up with a completely different way
of proving the zero-knowledge property.</p>
<p>So we can't stop it, but we can make it as tricky as possible for the attacker to trick the receiver into replaying the
signature -- MuSig does this by requiring parties to share the hash of their nonces beforehand. At it's extreme; in the
two-party single-round scheme for example; the attacker would need to be able to control the victim's machine code
execution (like running a debugger), at which point one might think the attacker could read the private key directly
from memory anyway.</p>
<a class="header" href="#rogue-key-attacks" id="rogue-key-attacks"><h2>Rogue key attacks</h2></a>
<p>Another type of attack that can occur in multi-signature schemes are what's known as
<a href="https://tlu.tarilabs.com/cryptography/digital_signatures/introduction_schnorr_signatures.html#key-cancellation-attack">Rogue Key attacks</a>.</p>
<p>In this case, the attacker has the freedom to choose a key or nonce <em>after</em> the victim has already disclosed his. This
may allow the attacker to forge a valid signature on behalf of the victim. A recent paper, [<a href="https://eprint.iacr.org/2018/417.pdf" title="On the Security of Two-Round Multi-Signatures">DRI19</a>]], suggests that
<em>any</em> Schnorr-based 2-round multi-signature scheme is vulnerable to a rogue key attack.</p>
<p>How this might apply in an insecure 2-round Tari multi-signature scheme is as follows: A receiver sends his public
nonce, output commitment and range proof, and public spending key to the sender, but then decides to cancel the
transaction by refusing to provide a signature and sending an &quot;Abort&quot; message to the sender instead. The sender could,
if he wanted, forge the 2-of-2 signature using this rogue key attack and broadcast the transaction anyway.</p>
<p><em>Note:</em> This attack is not applicable in the one-round 2-party scheme since the receiver returns his information in an
all-or-nothing manner. However, the <em>receiver</em> could attempt to forge a signature, since he has the Sender's public
nonce, but there's nothing he can really do with this signature; he certainly cannot broadcast a transaction with it
because he doesn't have any of the transaction data at this stage.</p>
<p>We avoid rogue-key attacks in the Tari multi-recipient scheme by employing 3-rounds. In the first round, parties share a
hash of their public nonces, which each party can later use to verify that no nonces were changed after the actual
public nonces were shared.</p>
<a class="header" href="#rfc-0170networkcommunicationprotocol" id="rfc-0170networkcommunicationprotocol"><h1>RFC-0170/NetworkCommunicationProtocol</h1></a>
<a class="header" href="#the-tari-communication-network-and-network-communication-protocol" id="the-tari-communication-network-and-network-communication-protocol"><h2>The Tari Communication Network and Network Communication Protocol</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/neonknight64">Yuko Roodt</a></p>
<a class="header" href="#license-10" id="license-10"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2018 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-10" id="language-10"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-10" id="disclaimer-10"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-10" id="goals-10"><h2>Goals</h2></a>
<p>This document will introduce the Tari communication network and the communication protocol used to select, establish and maintain connections between peers on the network.
<a href="Glossary.html#communication-node">Communication Node</a>s and <a href="Glossary.html#communication-client">Communication Client</a>s will be introduced and their required functionality will be proposed.</p>
<a class="header" href="#related-rfcs-9" id="related-rfcs-9"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0100_BaseLayer.html">RFC-0100: The Tari Base Layer</a></li>
<li><a href="RFC-0300_DAN.html">RFC-0300: Digital asset network</a></li>
</ul>
<a class="header" href="#description-8" id="description-8"><h2>Description</h2></a>
<a class="header" href="#assumptions-1" id="assumptions-1"><h3>Assumptions</h3></a>
<ul>
<li>A communication channel can be established between two peers once their online communication addresses are known to each other.</li>
<li>A <a href="Glossary.html#validator-node">Validator Node</a> is able to derive a <a href="Glossary.html#node-id">node ID</a> from the Validator Node registration transaction on the Base Layer.</li>
</ul>
<a class="header" href="#abstract-2" id="abstract-2"><h3>Abstract</h3></a>
<p>The backbone of the Tari communication network consists of a large number of nodes that maintain peer connections between each other.
These nodes forward and propagate encrypted and unencrypted data messages through the network such as joining requests, discovery requests, <a href="Glossary.html#transaction">transaction</a>s and completed <a href="Glossary.html#block">block</a>s.
Network clients, not responsible for maintaining the network, are able to create ad hoc connections with nodes on the network to perform joining and discovery requests.
The majority of communication between clients and nodes will be performed using direct Peer-to-peer (P2P) communication once the discovery process was used to obtain the online communication addresses of peers.
Where possible the efficient Kademlia based directed forwarding of encrypted data messages can be used to perform quick node discovery and joining of clients and nodes on the Tari communication network.
Where messages are of importance to a wide variety of entities on the network, Gossip protocol based message propagation can be performed to distribute the message to the entire network.</p>
<a class="header" href="#overview" id="overview"><h3>Overview</h3></a>
<p>The Tari communication network is a variant of a <a href="https://en.wikipedia.org/wiki/Kademlia">Kademlia</a> network that allows for fast discovery of nodes, with an added ability to perform Gossip protocol based broadcasting of data messages to the entire network.
The majority of the communication required on the <a href="Glossary.html#base-layer">Base Layer</a> and <a href="Glossary.html#digital-asset-network">Digital Asset Network</a> (DAN) will be performed via direct P2P communication between known clients and nodes.
Alternatively, the Tari communication network can be used for broadcasting joining requests, discovery requests and propagating data messages such as completed blocks, transactions and data messages that are of interest to a large part of the Tari communication network.</p>
<p>The Tari communication network consists of a number of different entities that need to communicate in a distributed and ad-hoc manner.
The primary entities that need to communicate are Validator Nodes (VN), <a href="Glossary.html#base-node">Base Node</a>s (BN), <a href="Glossary.html#wallet">Wallet</a>s (W) and <a href="Glossary.html#token-wallet">Token Wallet</a>s (TW).
Here are some examples of different communication tasks that need to be performed by these entities on the Tari Communication network:</p>
<ul>
<li>Base Nodes on the Base Layer need to propagate completed blocks and transactions to other Base Nodes using Gossip protocol based broadcasting.</li>
<li>Validator Nodes need to efficiently discover other Validator Nodes in the process of forming Validator Node committees.</li>
<li>Wallets need to communicate and negotiate with other Wallets to create transactions. They also need the ability to submit transactions to the <a href="Glossary.html#mempool">mempool</a> of Base Nodes.</li>
<li>Token Wallets need to communicate with Validator Node <a href="Glossary.html#committee">committee</a>s and other Token Wallets to construct and send DAN instructions.</li>
</ul>
<p>Here is an overview communication matrix that show which source entities SHOULD initiate communication with destination entities on the Tari Communication network:</p>
<table><thead><tr><th>         \Destination<br>Source </th><th> Validator Node </th><th> Base Node </th><th> Wallet </th><th> Token Wallet </th></tr></thead><tbody>
<tr><td> Validator Node         </td><td> Yes            </td><td> Yes       </td><td> Yes    </td><td> Yes          </td></tr>
<tr><td> Base Node              </td><td> No             </td><td> Yes       </td><td> No     </td><td> No           </td></tr>
<tr><td> Wallet                 </td><td> No             </td><td> Yes       </td><td> Yes    </td><td> No           </td></tr>
<tr><td> Token Wallet           </td><td> Yes            </td><td> No        </td><td> Yes    </td><td> Yes          </td></tr>
</tbody></table>
<a class="header" href="#communication-nodes-and-communication-clients" id="communication-nodes-and-communication-clients"><h4>Communication Nodes and Communication Clients</h4></a>
<p>To simplify the description of the Tari communication network, the different entities with similar behaviour were grouped into two groups: Communication Nodes and Communication Clients.
Validator Nodes and Base Nodes are Communication Nodes (CN).
Wallets and Token Wallets are Communication Clients (CC).
CNs form the core communication infrastructure of the Tari communication network and are responsible for maintaining the Tari communication network by receiving, forwarding and distributing joining requests, discovery requests, data messages and routing information.
CCs are different from CNs in that they do not maintain the network and they are not responsible for propagating any joining requests, discovery requests, data messages and routing information.
They do make use of the network to submit their own joining requests and perform discovery request of other specific CNs and CCs when they need to communicate with them.
Once a CC has discovered the CC or CN they want to communicate with, they will establish a direct P2P channel with them.
The Tari communication network is unaware of this direct P2P communication once discovery is completed.</p>
<p>The different entity types MUST be grouped into the different communication node types as follows:</p>
<table><thead><tr><th> Entity Type    </th><th> Communication Node Type </th></tr></thead><tbody>
<tr><td> Validator Node </td><td> Communication Node      </td></tr>
<tr><td> Base Node      </td><td> Communication Node      </td></tr>
<tr><td> Wallet         </td><td> Communication Client    </td></tr>
<tr><td> Token Wallet   </td><td> Communication Client    </td></tr>
</tbody></table>
<a class="header" href="#unique-identification-of-communication-nodes-and-communication-clients" id="unique-identification-of-communication-nodes-and-communication-clients"><h4>Unique identification of Communication Nodes and Communication Clients</h4></a>
<p>In the Tari communication network, each CN or CC makes use of a node ID to determine their position in the network.
This node ID is either assigned based on registration on the Base Layer or can be derived from the CNs or CCs identification public key.
The method used to obtain a node ID will either enhance or limit the trustworthiness of that entity when propagating messages through them on the Tari communication network.
When performing the broadcasting of data messages or propagating discovery requests, nodes with registration assigned node IDs are considered more trustworthy compared to nodes with derived node IDs.</p>
<p>Obtaining a node ID from registration on the Base Layer is important as it will limit the potential of some parties performing <a href="https://eprint.iacr.org/2015/263.pdf">Eclipse attacks</a> on the network.
Registration makes it more difficult for <a href="Glossary.html#bad-actor">Bad Actor</a>s to position themselves in ideal patterns on the network to perform disruptive operations and actions.
In sensitive situations or situations where the Kademlia-style directed propagation of messages are vulnerable, gossip protocol-based broadcasting of messages can be performed as a less efficient, but safer alternative to ensure that the message will successfully reach the rest of the network.</p>
<p>The similarity or distance between different node IDs can be calculated by performing the <a href="https://en.wikipedia.org/wiki/Hamming_distance">Hamming distance</a> between the bits of the two node ID numbers.
The Hamming distance can be implemented as an Exclusive OR (XOR) between the bits of the numbers and the summation of the resulting true bits.
CCs and/or CNs that have similar node IDs, that produce a small Hamming distance, are located in similar regions of the Tari communication network.
This does not mean that their geographic locations are near each other, but rather that their location in the network is similar.
A thresholding scheme can be applied to the Hamming distance to ensure that only neighboring CNs with similar node IDs are allowed to share and propagate specific information.
As an example, only routing table information that contains similar node IDs to the requesting CCs or CNs node ID should be shared with them.
Limiting the sharing of routing table information makes it more difficult to map the entire Tari communication network.</p>
<p>The recommended method of node ID assignment for each Tari communication network entity type MUST be implemented as follows:</p>
<table><thead><tr><th> Entity Type    </th><th> Communication Node Type </th><th> Node ID Assignment </th></tr></thead><tbody>
<tr><td> Validator Node </td><td> Communication Node      </td><td> Registration       </td></tr>
<tr><td> Base Node      </td><td> Communication Node      </td><td> Derived            </td></tr>
<tr><td> Wallet         </td><td> Communication Client    </td><td> Derived            </td></tr>
<tr><td> Token Wallet   </td><td> Communication Client    </td><td> Derived            </td></tr>
</tbody></table>
<p>Note that <a href="Glossary.html#mining-server">Mining Server</a>s and <a href="Glossary.html#mining-worker">Mining Worker</a>s are excluded from the Tari communication network.
A Mining Worker will have a local or remote P2P connection with a Mining Server.
A Mining Server will have a local or remote P2P connection with a Base Node.
They do not need to make use of the communication network and they are not responsible for propagating any messages on the network.
The parent Base Node will perform any communication tasks on the Tari communication network on their behalf.</p>
<a class="header" href="#online-communication-address-peer-address-and-routing-table" id="online-communication-address-peer-address-and-routing-table"><h4>Online Communication Address, Peer Address and Routing Table</h4></a>
<p>Each CC and CN on the Tari communication network will have identification cryptographic keys, a node ID and an online communication address.
The online communication address SHOULD be either an IPv4, IPv6, URL, Tor (Base32) or I2P (Base32) address and can be stored using the network address type as follows:</p>
<table><thead><tr><th> Description  </th><th> Data type  </th><th> Comments                                            </th></tr></thead><tbody>
<tr><td align="left"> address type </td><td align="left"> uint4      </td><td align="left"> Specify if IPv4/IPv6/Url/Tor/I2P                    </td></tr>
<tr><td align="left"> address      </td><td align="left"> char array </td><td align="left"> IPv4, IPv6, URL, Tor (Base32), I2P (Base32) address </td></tr>
<tr><td align="left"> port         </td><td align="left"> uint16     </td><td align="left"> port number                                         </td></tr>
</tbody></table>
<p>The address type is used to determine how to interpret the address characters. An I2P address can be interpreted as &quot;{52
address characters}.b32.i2p&quot;. The Tor address should be interpreted as &quot;http://{16_or_52_address_chars}.onion/&quot;. The
IPv4 and IPv6 address can be stored in the address field without modification. URL addresses can be used for nodes with
dynamic IP addresses.</p>
<p>A Tor or I2P address can be used when anonymity is important for a CC or CN.
The IPv4, IPv6 and URL address types do not provide any privacy features but do provide increased bandwidth.</p>
<p>Each CC or CN has a local routing table that contains the online communication addresses of all CCs and CNs on the Tari communication network known to that CC or CN.
When a CC or CN wants to join the Tari communication network, the online communication address of at least one other CN that is part of the network needs to be known.
The online communication address of the initial CN can either be manually provided or a bootstrapped list of &quot;reliable&quot; and persistent CNs can be provided with the Validator Node, Base Node, Wallet or Token Wallet software.
The new CC or CN can then request additional peer contact information of other CNs from the initial peers to extend their own routing table.</p>
<p>The routing table consists of a list of peer addresses that link node IDs, public identification keys and online communication addresses of each known CC and CN.</p>
<p>The Peer Address stored in the routing table MAY be implemented as follows:</p>
<table><thead><tr><th> Description      </th><th> Data type         </th><th> Comments                                                                 </th></tr></thead><tbody>
<tr><td align="left"> network address  </td><td align="left"> network_address   </td><td align="left"> The online communication address of the CC or CN                         </td></tr>
<tr><td align="left"> node_ID          </td><td align="left"> node_ID           </td><td align="left"> Registration Assigned for VN, Self selected for BN, W and TW             </td></tr>
<tr><td align="left"> public_key       </td><td align="left"> public_key        </td><td align="left"> The public key of the identification cryptographic key of the CC or CN   </td></tr>
<tr><td align="left"> node_type        </td><td align="left"> node_type         </td><td align="left"> VN, BN, W or TW                                                          </td></tr>
<tr><td align="left"> linked asset IDs </td><td align="left"> list of asset IDs </td><td align="left"> Asset IDs can be used as an address on Tari network similar to a node ID </td></tr>
<tr><td align="left"> last_connection  </td><td align="left"> timestamp         </td><td align="left"> Time of last successful connection with peer                             </td></tr>
<tr><td align="left"> update_timestamp </td><td align="left"> timestamp         </td><td align="left"> A timestamp for the last peer address update                             </td></tr>
</tbody></table>
<p>When a new CC or CN wants to join the Tari communication network they need to submit a joining request to the rest of the network.
The joining request contains the peer address of the new CC or CN.
Each CN that receives the joining request can decide if they want to add the new CCs or CNs contact information to their local routing table.
When a CN, that received the joining request, has a similar node ID to the new CC or CN then that node must add the peer address to their routing table.
All CNs with similar node IDs to the new CC or CN should have a copy of the new peer address in their routing tables.</p>
<p>To limit potential attacks, only one registration for a specific node type with the same online communication address can be stored in the routing table of a CN.
This restriction will limit Bad Actors from spinning up multiple CNs on a single computer.</p>
<a class="header" href="#joining-the-network-using-a-joining-request" id="joining-the-network-using-a-joining-request"><h4>Joining the Network using a Joining Request</h4></a>
<p>A new CC or CN needs to register their peer address on the Tari communication network.
This is achieved by submitting a network joining request to a subset of CNs selected from the routing table of the new CC or CN.
These peers will forward the joining request, with the peer address, to the rest of the network until CNs with similar node IDs have been reached.
CNs with similar node IDs will then add the new peer address of the new node to their routing table, allowing for fast discovery of the new CC or CN.</p>
<p>Other CCs and CNs will then be able to retrieve the new CCs or CNs peer address by submitting discovery requests.
Once the peer address of the desired CC or CN has been discovered then a direct P2P communication channel can be established between the two parties for any future communication.
After discovery, the rest of the Tari communication network will be unaware of any further communication between the two parties.</p>
<a class="header" href="#sending-data-messages-and-discovery-requests" id="sending-data-messages-and-discovery-requests"><h4>Sending Data Messages and Discovery Requests</h4></a>
<p>The majority of all communication on the Tari communication network will be performed using direct P2P channels established between different CCs and CNs once they are aware of the peer addresses of each other that contain their online communication addresses.
Message propagation on the network will typically consist only of joining and discovery requests where a CC or CN wants to join the network or retrieve the peer address of another CC or CN so that a direct P2P channel can be established.</p>
<p>Messages can be transmitted in this network in either an unencrypted or encrypted form.
Typically messages that have been sent in unencrypted form are of interest to a number of CNs on the network and should be propagated so that every CN that is interested in that data message obtains a copy.
Block and Transaction propagation are examples of data messages where multiple entities on the Tari communication network are interested in that data message; this requires propagation through the entire Tari communication network in unencrypted form.</p>
<p>Encrypted data messages make use of the source and destinations identification cryptographic keys to construct a shared secret with which the message can be encoded and decoded.
This ensures that only the two parties are able to decode the data message as it is propagated through the communication network.
This mechanism can be used to perform private discovery requests, where the online communication address of the source node is encrypted and propagated through the network until it reached the destination node.
Private discovery requests can only be performed if both parties are online at the same time.
Encryption of the data message ensures that only the destination node is able to view the online address of the source node as the data message moves through the network.
Once the destination node receives and decrypts the data message, that node is then able to establish a P2P communication channel with the source node for any further communication.</p>
<p>Propagation of completely private discovery request, hidden as an encrypted data message, can be performed as a broadcast through the entire network using the Gossip protocol.
Propagation of public discovery requests can be performed using more efficient directed propagation using the Kademlia protocol.
As encrypted message with visible destinations tend to not be of interest to the rest of the network, directed propagation using the Kademlia protocol to forward these messages to the correct parties are preferred.
Privacy of a CCs online address, whom is sending a transaction to a Base Node, may be enhanced if the transaction is encrypted and sent to a Base Node with a node ID that is not the closest to the CCs node ID. This should prevent linking a transaction to the originating online address.</p>
<p>This same encryption technique can be used to send encrypted messages to a single node or a group of nodes, where the group of nodes have shared identification keys.
A Validation Committee is an example of a group of CNs that have shared identification keys for the committee.
The shared identification keys ensure that all members of that committee are able to receive and decrypt data messages that were sent to the committee.</p>
<a class="header" href="#maintaining-connections-with-peers" id="maintaining-connections-with-peers"><h4>Maintaining connections with peers</h4></a>
<p>CCs and CNs establish and maintain connections with peers differently.
CCs only create a few short-lived ad hoc channels and CNs create and maintain long-lived channels with a number of peers.</p>
<p>If a CC is unaware of a destination CNs or CCs online communication address then the address first needs to be obtained using a discovery request.
When a CC already knows the communication address of the CC or CN that he wants to communicate with, then a direct P2P channel can be established between the two peers for the duration of the communication task.
The communication channel can then be closed as soon as the communication task has been completed.</p>
<p>CNs consisting of VNs and BNs typically attempt to maintain communication channels with a large number of peers.
The distribution of peers (VNs vs BNs) that a single CN keeps communication channels open with can change depending on the type of node.
A CN that is also a BN should maintain more peer connections with other BNs, but should also have some connections with other VNs.</p>
<p>Having some connections with VNs are important as BNs have derived node IDs and not registered node IDs such as VNs, making it possible for the CN to be separated from the main network and become victim to an <a href="https://www.radixdlt.com/post/what-is-an-eclipse-attack">Eclipse attack</a>.
Having some connections with VNs will make it more difficult to separate the CN from the network and will ensure successful propagation of transactions and completed blocks from that CN.</p>
<p>A CN that is also a VN should maintain more peer connections with other VNs, but also have some connections with BNs.
CNs that are part of Validator Node committees should attempt to maintain permanent connections with the other members of the committee to ensure that quick consensus can be achieved.</p>
<p>To maintain connections with peers, the following process can be performed.
Discover peers using discovery requests, and add their details to the local routing table.
The CN can decide how the peer connections should be selected from the routing table by either:</p>
<ul>
<li>manually selecting a subset,</li>
<li>automatically selecting a random subset or</li>
<li>selecting a subset of neighbouring nodes with similar node IDs.</li>
</ul>
<p>Maintaining communication channels is important and the following process can be followed in an attempt to keep peer connections alive:
For an existing peer connection.
When more than 30 minutes have passed since the last communication with that peer, then a heartbeat message should be sent to the peer in an attempt to keep the connection with the peer alive.
If the peer connection was not established for a specific purpose, such as with the connections between committee members, then a new replacement peer can be selected from the local routing table.
A new connection can then be established and maintained between the current node and the newly selected node.
If that specific connection is important, such as with the connections between committee members, then the current CN or CC must wait and attempt to create a new connection with that same peer.
If more than 90 minutes have passed since the last successful communication with the peer node, a new discovery request can be sent on the Tari communication network in an attempt to locate that peer again.
Losing of a peer might happen in cases where the CN or CC went temporarily offline and their dynamic communication address changed, requiring the discovery process to be performed again before a direct P2P communication channel can be established.</p>
<a class="header" href="#functionality-required-of-communication-nodes" id="functionality-required-of-communication-nodes"><h4>Functionality Required of Communication Nodes</h4></a>
<ul>
<li>It MUST select a cryptographic key pair used for identification on the Tari Communication network.</li>
<li>A CN MAY request the peer addresses of CNs with similar node IDs from other CNs to extend their local routing table.</li>
<li>If a CN is a VN, then a node ID MUST be obtained by registering on the Base layer.</li>
<li>If a CN is a BN, then a node ID MUST be derived from the nodes identification public key.</li>
<li>A new CN MUST submit a joining request to the Tari communication network so that the nodes peer address can be added to the routing table of neighbouring peers in the network.</li>
<li>If a CN receives a new joining request with a similar node ID (within a network selected threshold), then the peer address specified in the joining request MUST be added to its local routing table.</li>
<li>When a CN receives an encrypted message, the node MUST attempt to open the message.</li>
<li>When a CN receives an encrypted message that the node is unable to open, and the destination node ID is known then the CN MUST forward it to all connected peers that have node IDs that are closer to the destination.</li>
<li>When a CN receives an encrypted message that the node is unable to open and the destination node is unknown then the CN MUST forward the message to all connected peers.</li>
<li>A CN MUST have the ability to verify the content of unencrypted messages to limit the propagation of spam messages.</li>
<li>If an unencrypted message is received by the CN with a unspecified destination node ID, then the node MUST verify the content of the message and forward the message to all connected peers.</li>
<li>If an unencrypted message is received by the CN with an specified destination node ID, then the node MUST verify the content of the message and forward the message to all connected peers that have closer node IDs.</li>
<li>A CN MUST have the ability to select a set of peer connections from its routing table.</li>
<li>Connections with the selected set of peers MUST be maintained by the CN.</li>
<li>A CN MUST have a mechanism to construct encrypted and unencrypted joining requests, discovery requests or data messages.</li>
<li>A CN MUST construct and provide a list of peer addresses from its routing table that is similar to a requested node ID so that other CCs and CNs can extend their routing tables.</li>
<li>A CN MUST keep its routing table up to date by removing unreachable peer addresses and adding newly received addresses.</li>
<li>It MUST have a mechanism to determine if a node ID was obtained through registration or was derived from an identification public key.</li>
<li>A CN MUST calculate the similarity between different node IDs by calculating the Hamming distance between the bits of the two node ID numbers.</li>
</ul>
<a class="header" href="#functionality-required-of-communication-clients" id="functionality-required-of-communication-clients"><h4>Functionality Required of Communication Clients</h4></a>
<ul>
<li>It MUST select a cryptographic key pair used for identification on the Tari Communication network.</li>
<li>It MUST have a mechanism to derive a node ID from the self-selected identification public key.</li>
<li>A CC must have the ability to construct a peer address that links its identification public key, node ID and an online communication address.</li>
<li>A new CC MUST broadcast a joining request with its peer address to the Tari communication network so that CNs with similar node IDs can add the peer address of the new CC to their routing tables.</li>
<li>A CC MAY request the peer addresses of CNs with similar node IDs from other CNs to extend their local routing table.</li>
<li>A CC MUST have a mechanism to construct encrypted and unencrypted joining and discovery requests.</li>
<li>A CC MUST maintain a small persistent routing table of Tari Communication network peers with which ad hoc connections can be established.</li>
<li>As the CC becomes aware of other CNs and CCs on the communication network, the CC SHOULD extend its local routing table by including the newly discovered CCs or CNs contact information.</li>
<li>Peers from the CCs routing table that have been unreachable for a number of attempts SHOULD be removed from the its routing table.</li>
<li>A CC MUST calculate the similarity between different node IDs by calculating the Hamming distance between the bits of the two node ID numbers.</li>
</ul>
<a class="header" href="#rfc-0711messageserialisation" id="rfc-0711messageserialisation"><h1>RFC-0711/MessageSerialisation</h1></a>
<a class="header" href="#message-serialization" id="message-serialization"><h2>Message Serialization</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a></p>
<a class="header" href="#license-11" id="license-11"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019. The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-11" id="language-11"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-11" id="disclaimer-11"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-11" id="goals-11"><h2>Goals</h2></a>
<p>This document describes the message serialisation formats for message payloads used in the Tari network.</p>
<a class="header" href="#related-rfcs-10" id="related-rfcs-10"><h2>Related RFCs</h2></a>
<p><a href="RFC-0170_NetworkCommunicationProtocol.html">RFC-0710: The Tari Communication Network and Network Communication Protocol</a></p>
<a class="header" href="#description-9" id="description-9"><h2>Description</h2></a>
<p>One way of interpreting the Tari network is that it is a large peer-to-peer messaging application. The entities chatting
on the network include</p>
<ul>
<li>Users</li>
<li>Wallets</li>
<li>Base nodes</li>
<li>Validator nodes</li>
</ul>
<p>The types of messages that these entities send might include</p>
<ul>
<li>Text messages</li>
<li>Transaction messages</li>
<li>Block propagation messages</li>
<li>Asset creation instructions</li>
<li>Asset state change instructions</li>
<li>State Checkpoint messages</li>
</ul>
<p>For successful communication to occur, the following needs to happen:</p>
<ul>
<li>The message is translated from its memory storage format into a standard payload format that will be transported over
the wire.</li>
<li>The communication module wraps the payload into a message format, which may entail any/all of
<ul>
<li>adding a message header to describe the type of payload,</li>
<li>encrypting the message,</li>
<li>signing the message, and</li>
<li>adding destination/recipient metadata.</li>
</ul>
</li>
<li>The communication module then sends the message over the wire.</li>
<li>The recipient receives the message and unwraps it, possibly performing any/all of the following:
<ul>
<li>decryption,</li>
<li>verifying signatures,</li>
<li>extracting the payload,</li>
<li>passing the serialised payload to modules that are interesting in that particular message type</li>
</ul>
</li>
<li>The message is deserialised into the correct data structure for use by the receiving software</li>
</ul>
<p>This document only covers the first and last steps: <em>viz</em>: serialising data from in-memory objects to a format that can
be transmitted over the wire. The other steps are handled by the Tari communication protocol.</p>
<p>In addition to machine-to-machine communication, we also standardise on human-to-machine communication. Use cases for
this include</p>
<ul>
<li>Handcrafting instructions or transactions. The ideal format here is a very human-readable format.</li>
<li>Copying transactions or instructions from cold wallets. The ideal format here is a compact but easy-to-copy format.</li>
<li>Peer-to-peer text messaging. This is just a special case of what has already been described, with the message
structure containing a unicode <code>message_text</code> field.</li>
</ul>
<p>When sending a message from a human to the network, the following happens:</p>
<ul>
<li>The message is deserialised into the native structure.</li>
<li>The deserialisation acts as an automatic validation step.</li>
<li>Additional validation can be performed.</li>
<li>The usual machine-to-machine process is followed as described above.</li>
</ul>
<a class="header" href="#binary-serialisation-formats" id="binary-serialisation-formats"><h3>Binary serialisation formats</h3></a>
<p>The ideal properties for binary serialisation formats are:</p>
<ul>
<li>Widely used across multiple platforms and languages, but with excellent Rust support.</li>
<li>Compact binary representation</li>
<li>Serialisation &quot;Just Works&quot;(TM) with little or no additional coding overhead.</li>
</ul>
<p>Several candidates fulfil these properties to some degree.</p>
<a class="header" href="#a-hrefhttpwwwituintitu-tasn1indexhtmlasn1a" id="a-hrefhttpwwwituintitu-tasn1indexhtmlasn1a"><h4><a href="http://www.itu.int/ITU-T/asn1/index.html">ASN.1</a></h4></a>
<ul>
<li>Pros:
<ul>
<li>Very mature (was developed in the 80s)</li>
<li>Large number of implementations</li>
<li>Dovetails into ZMQ nicely</li>
</ul>
</li>
<li>Cons:
<ul>
<li>Limited Rust / Serde support</li>
<li>Requires schema (additional coding overhead if no automated tools for this exist)</li>
</ul>
</li>
</ul>
<a class="header" href="#a-hrefhttpmsgpackorgmessage-packa" id="a-hrefhttpmsgpackorgmessage-packa"><h4><a href="http://msgpack.org/">Message Pack</a></h4></a>
<ul>
<li>Pros:
<ul>
<li>Very compact</li>
<li>Fast</li>
<li>Multiple language support</li>
<li>Good Rust / Serde support</li>
<li>Dovetails into ZMQ nicely</li>
</ul>
</li>
<li>Cons:
<ul>
<li>No metadata support</li>
</ul>
</li>
</ul>
<a class="header" href="#a-hrefhttpscodegooglecompprotobufprotobufa" id="a-hrefhttpscodegooglecompprotobufprotobufa"><h4><a href="https://code.google.com/p/protobuf/">Protobuf</a></h4></a>
<p>Similar to <a href="#message-pack">Message Pack</a>, but also requires schema's to be written and compiled. Serialisation performance and size
is similar to Message Pack. Can work with ZMQ but is better designed to be used with gRPC.</p>
<a class="header" href="#a-hrefhttpkentonvgithubiocapnprotocapn-protoa" id="a-hrefhttpkentonvgithubiocapnprotocapn-protoa"><h4><a href="http://kentonv.github.io/capnproto/">Cap'n Proto</a></h4></a>
<p>Similar to <a href="#protobuf">Protobuf</a>, but claims to be much faster. Rust is supported.</p>
<a class="header" href="#hand-rolled-serialisation" id="hand-rolled-serialisation"><h4>Hand-rolled serialisation</h4></a>
<p><a href="http://zguide.zeromq.org/py:chapter7#Serialization-Libraries">Hintjens recommends</a> using hand-rolled serialization for
bulk messaging. While Pieter usually offers sage advice, I'm going to argue against using custom serialisers at this
point in time for the following reasons:</p>
<ul>
<li>We're unlikely to improve hugely over MessagePack</li>
<li>Since serde does 95% of our work for us with MessagePack, there's significant development overhead (and new bugs)
involved with a hand-rolled solution.</li>
<li>We'd have to write de/serialisers for every language that wants Tari bindings; whereas every major language has a
MessagePack implementation.</li>
</ul>
<a class="header" href="#serialisation-in-tari" id="serialisation-in-tari"><h3>Serialisation in Tari</h3></a>
<p>Deciding between these protocols is largely a matter of preference, since there isn't that much to choose between them.
Given that ZMQ is used in other places in the Tari network; MessagePack looks to be a good fit while offering a compact
data structure and highly performant de/serialisation. In Rust in particular, there's first-class support for MessagePack
in serde.</p>
<p>For human-readable formats, it makes little sense to deviate from JSON. For copy-paste semantics, the extra compression
that Base64 offers over raw hex or Base58 makes it attractive.</p>
<p>Many Tari data types' binary representation will be the straightforward MessagePack version of each field in the related
Struct. In these cases, as straightforward <code>#[derive(Deserialize, Serialize)]</code> is all that is required to make the data
structure able to be sent over the wire.</p>
<p>However, other structures might need fine tuning, or hand-written serialisation procedures. To capture both use cases,
it is proposed that a <code>MessageFormat</code> trait be defined:</p>
<pre><pre class="playpen"><code class="language-rust compile_fail">
# #![allow(unused_variables)]
#fn main() {
{{#include ../../base_layer/core/src/message.rs:41:49}}
#}</code></pre></pre>
<p>This trait will have default implementations to cover most use cases (e.g. a simple call through to <code>serde_json</code>). Serde
also offers significant ability to tweak how a given struct will be serialised through the use of
<a href="https://serde.rs/attributes.html">attributes</a>.</p>
<a class="header" href="#rfc-0172peertopeermessaging" id="rfc-0172peertopeermessaging"><h1>RFC-0172/PeerToPeerMessaging</h1></a>
<a class="header" href="#peer-to-peer-messaging-protocol" id="peer-to-peer-messaging-protocol"><h2>Peer to Peer Messaging Protocol</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/sdbondi">Stanley Bondi</a>, <a href="https://github.com/CjS77">Cayle Sharrock</a>, <a href="https://github.com/neonknight64">Yuko Roodt</a></p>
<a class="header" href="#license-12" id="license-12"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019. The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-12" id="language-12"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-12" id="disclaimer-12"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-12" id="goals-12"><h2>Goals</h2></a>
<p>This document describes the peer-to-peer messaging protocol for <a href="Glossary.html#communication-node">communication node</a>s and <a href="Glossary.html#communication-client">communication client</a>s on the Tari network.</p>
<a class="header" href="#related-rfcs-11" id="related-rfcs-11"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0170_NetworkCommunicationProtocol.html">RFC-0170: NetworkCommunicationProtocol</a></li>
<li><a href="RFC-0171_MessageSerialisation.html">RFC-0171: Message Serialisation</a></li>
</ul>
<a class="header" href="#description-10" id="description-10"><h2>Description</h2></a>
<a class="header" href="#assumptions-2" id="assumptions-2"><h3>Assumptions</h3></a>
<ul>
<li>Either every <a href="Glossary.html#communication-node">communication node</a> or <a href="Glossary.html#communication-client">communication client</a> has access to a Tor/I2P proxy, or a native Tor/I2P implementation
exists which allows communication across the Tor network.</li>
<li>All messages are de/serialized as per <a href="RFC-0171_MessageSerialisation.html">RFC-0171: Message Serialisation</a></li>
</ul>
<a class="header" href="#broad-requirements-1" id="broad-requirements-1"><h3>Broad requirements</h3></a>
<p>Tari network peer communication must facilitate secure, private and efficient communication
between peers. Broadly, a <a href="Glossary.html#communication-node">communication node</a> or <a href="Glossary.html#communication-client">communication client</a> MUST be capable of</p>
<ul>
<li>bi-directional communication between multiple connected peers,</li>
<li>private and secure over the wire communication,</li>
<li>understanding and constructing Tari messages,</li>
<li>encrypting and decrypting message payloads,</li>
<li>gracefully reestablishing dropped connections,</li>
<li>and optionally, communicating to a SOCKS5 proxy (for connections over Tor and I2P).</li>
</ul>
<p>Additionally, <a href="Glossary.html#communication-node">communication node</a>s MUST be capable of performing the following tasks:</p>
<ul>
<li>Open a control port for establishing secure peer channels.</li>
<li>Maintain a list of known peers in the form of a routing table.</li>
<li>Forward directed messages to neighbouring peers.</li>
<li>Broadcast messages to neighbouring peers.</li>
</ul>
<a class="header" href="#overall-architectural-design" id="overall-architectural-design"><h3>Overall Architectural Design</h3></a>
<p>The Tari communication layer has a modular design to allow for the various communicating nodes and clients to
use the same infrastructure code.</p>
<p>The design is influenced by open-source library called <a href="http://zeromq.org/">ZeroMQ</a> and the <a href="http://zeromq.org/">ZeroMQ</a> C bindings are a dependency of
the project. <a href="http://zeromq.org/">ZeroMQ</a>'s over-the-wire protocol is relatively simple and replicating <a href="http://zeromq.org/">ZeroMQ</a> framing in a custom
implementation should not be prohibitively difficult. However, there are many valuable features offered by
<a href="http://zeromq.org/">ZeroMQ</a> which would be a significantly larger undertaking to reproduce. Fortunately, bindings or native ports are
available in numerous languages.</p>
<p>To learn more about <a href="http://zeromq.org/">ZeroMQ</a>, read <a href="http://zguide.zeromq.org/page:all">the guide</a>. It's an enjoyable and worthwhile read.</p>
<p>A quick overview of what <a href="http://zeromq.org/">ZeroMQ</a> provides:</p>
<ul>
<li>A simple socket API.</li>
<li>Some well-defined patterns to connect sockets together.</li>
<li>Sockets that are tiny asynchronous message queues which:
<ul>
<li>abstract away complexity around the underlying socket,</li>
<li>are transport agnostic, meaning you can choose between TCP, PGM, IPC and inproc transports with little or
no changes to code,</li>
<li>and, they transparently reconnect when connections are dropped.</li>
</ul>
</li>
<li>The <code>inproc</code> transport for message passing between threads without mutex locks.</li>
<li>Built-in protocol for asymmetric encryption over the wire using Curve25519.</li>
<li>The ability to send and receive multipart messages using a simple framing scheme. <a href="http://zguide.zeromq.org/php:chapter2#toc11">More info</a>.</li>
<li>Support for SOCKS proxies.</li>
</ul>
<p>This document will refer to several <a href="http://api.zeromq.org/2-1:zmq-socket">ZeroMQ socket</a>s. These are referred to by prepending <code>ZMQ_</code> and the name
of the socket in capitals. For example, <code>ZMQ_ROUTER</code>.</p>
<p><strong><em>Note about <a href="http://zeromq.org/">ZeroMQ</a> frames and multipart messages</em></strong></p>
<p><a href="http://zeromq.org/">ZeroMQ</a> frames are length-specified blocks of binary data and can be strung together to make multipart messages.</p>
<pre><code class="language-text">|5|H|E|L|L|O|*|0|*|3|F|O|O|+|
* = more flag
+ = no more flag
</code></pre>
<p><em>A multipart message consisting of three frames &quot;HELLO&quot;, a zero-length frame and &quot;FOO&quot;</em></p>
<p>When this RFC mentions 'multipart messages', this is what it's referring to.</p>
<a class="header" href="#establishing-a-connection" id="establishing-a-connection"><h4>Establishing a Connection</h4></a>
<p>Every participating <a href="Glossary.html#communication-node">communication node</a> SHOULD open a control socket (see <a href="#controlservice">ControlService</a>) to allow peers to negotiate and
establish a peer connection. The <a href="#netaddress">NetAddress</a> of the control socket is what is stored in peer's routing tables and will
be used to establish new ephemeral <a href="#peerconnection">PeerConnection</a>s. Any peer that wants to connect MUST establish a connection
to the control socket of the destination peer to negotiate a new encrypted <a href="#peerconnection">PeerConnection</a>.</p>
<p>Once a connection is established, messages can be sent and received directly to/from the <a href="#peer">Peer</a>.</p>
<p>Incoming messages are validated, deserialized and handled as appropriate.</p>
<a class="header" href="#encryption" id="encryption"><h4>Encryption</h4></a>
<p>There are two forms of encryption which are used:</p>
<ul>
<li>Over the wire encryption: encryption of traffic between nodes using zMQ's <a href="http://curvezmq.org/page:read-the-docs">CURVE</a>
implementation.</li>
<li>Payload encryption: the <a href="#MessageEnvelopebody">MessageEnvelopeBody</a> is encrypted in such a way that only the destination recipient can decrypt it.</li>
</ul>
<a class="header" href="#components" id="components"><h3>Components</h3></a>
<p>The following components are proposed:</p>
<div class="mermaid">
graph TD
CSRV[ControlService]
IMS[InboundMessageService]
PM[PeerManager]
CM[ConnectionManager]
BCS[BroadcastStrategy]
OMS[OutboundMessageService] 
PC[PeerConnection] 
NA[NetAddress]
STR[Storage]
PEER[Peer]
RT[RoutingTable]
IMS --> PM
IMS --> CM
CSRV --> CM
CSRV --> PM
OMS -->|execute| BCS
OMS --> PM
OMS --> CM
PM --> RT
PM --> STR
CM --> PC
PC -->|has one| PEER
PEER -->|has many| NA
</div>
<a class="header" href="#netaddress" id="netaddress"><h4>NetAddress</h4></a>
<p>Represents one of the following:</p>
<ul>
<li>an IP address,</li>
<li>an Onion address,</li>
<li>or, an I2P address.</li>
</ul>
<pre><pre class="playpen"><code class="language-rust compile_fail">
# #![allow(unused_variables)]
#fn main() {
#[derive(Clone, PartialEq, Eq, Debug)]
/// Represents an address which can be used to reach a node on the network
pub enum NetAddress {
    /// IPv4 and IPv6
    IP(SocketAddress),
    Tor(OnionAddress),
    I2P(I2PAddress),
}
#}</code></pre></pre>
<a class="header" href="#messaging-structure" id="messaging-structure"><h4>Messaging structure</h4></a>
<p>This illustrates the structure of a Tari message.</p>
<pre><code class="language-text">+----------------------------------------+
|             MessageEnvelope            |
|  +----------------------------------+  |
|  |        MessageEnvelopeHeader     |  |
|  +----------------------------------+  |
|  +----------------------------------+  |
|  |      MessageEnvelopeBody         |  |
|  |     (optionally encrypted)       |  |
|  | +------------------------------+ |  |
|  | |            Message           | |  |
|  | |   +-----------------------+  | |  |
|  | |   |     MessageHeader     |  | |  |
|  | |   +-----------------------+  | |  |
|  | |                              | |  |
|  | |   +-----------------------+  | |  |
|  | |   |      MessageBody      |  | |  |
|  | |   +-----------------------+  | |  |
|  | +------------------------------+ |  |
|  +----------------------------------+  |
+----------------------------------------+
</code></pre>
<a class="header" href="#messageenvelope--wire-format" id="messageenvelope--wire-format"><h4>MessageEnvelope  wire format</h4></a>
<p>Every Tari message MUST use the MessageEnvelope format. This format consists of four frames of a multipart message.</p>
<p>A MessageEnvelope  represents a message which has just come off, or is about to go on to the wire and consists of the following:</p>
<table><thead><tr><th> Name     </th><th> Frame </th><th> Length (octets) </th><th> Type      </th><th> Description                                                                                                                                            </th></tr></thead><tbody>
<tr><td> identity </td><td> 0     </td><td> 8               </td><td> <code>[u8;8]</code>  </td><td> The identifier that a <code>ZMQ_ROUTER</code> socket expects so that it knows the intended destination of the message. This can be thought of as a session token. </td></tr>
<tr><td> version  </td><td> 1     </td><td> 1               </td><td> <code>u8</code>      </td><td> The wire protocol version.                                                                                                                             </td></tr>
<tr><td> header   </td><td> 2     </td><td> varies          </td><td> <code>Vec&lt;u8&gt;</code> </td><td> Serialized bytes of data containing an unencrypted <a href="#MessageEnvelopeHeader">MessageEnvelopeHeader</a>.                                                                                      </td></tr>
<tr><td> body     </td><td> 3     </td><td> varies          </td><td> <code>Vec&lt;u8&gt;</code> </td><td> Serialized bytes of data containing a unencrypted or encrypted <a href="#MessageEnvelopebody">MessageEnvelopeBody</a>.                                                                      </td></tr>
</tbody></table>
<p>The header and decrypted body MUST be deserializable as per <a href="RFC-0171_MessageSerialisation.html">RFC-0171: Message Serialisation</a></p>
<a class="header" href="#messageenvelopeheader" id="messageenvelopeheader"><h4>MessageEnvelopeHeader</h4></a>
<p>Every <a href="#MessageEnvelope">MessageEnvelope</a> MUST have an unencrypted header containing the following fields:</p>
<table><thead><tr><th> Name      </th><th> Type                      </th><th> Description                                                                                        </th></tr></thead><tbody>
<tr><td> version   </td><td> <code>u8</code>                      </td><td> The message protocol version.                                                                      </td></tr>
<tr><td> source    </td><td> <code>PublicKey</code>               </td><td> The source public key.                                                                             </td></tr>
<tr><td> dest      </td><td> <code>Option&lt;NodeDestination&gt;</code> </td><td> The destination <a href="Glossary.html#node-id">node ID</a> or public key. A destination is optional.                                </td></tr>
<tr><td> signature </td><td> <code>[u8]</code>                    </td><td> Signature of the message header and body, signed with the private key of the source.               </td></tr>
<tr><td> flags     </td><td> <code>u8</code>                      </td><td> <ul><li>bit 0: 1 indicates that the message body is encrypted</li><li>bits 1-7: reserved</li></ul> </td></tr>
</tbody></table>
<p>A <a href="Glossary.html#communication-node">communication node</a> and <a href="Glossary.html#communication-client">communication client</a>:</p>
<ul>
<li>MUST validate the signature of the message using the source's public key.</li>
<li>MUST reject the message if the signature verification fails.</li>
<li>if the encryption bit flag is set:
<ul>
<li>MUST attempt to decrypt the <a href="#MessageEnvelopebody">MessageEnvelopeBody</a>, or failing that</li>
<li>MUST forward the message to a subset of peers using the <code>Closest</code> <a href="#outboundmessageservice">BroadcastStrategy</a></li>
<li>MUST discard the message if the body is not encrypted</li>
</ul>
</li>
</ul>
<a class="header" href="#messageenvelopebody" id="messageenvelopebody"><h4>MessageEnvelopeBody</h4></a>
<p>A MessageEnvelopeBody is the payload of the <a href="#MessageEnvelope">MessageEnvelope</a>. A <a href="#MessageEnvelopebody">MessageEnvelopeBody</a> may be encrypted as required.</p>
<p>It consists of a [MessageHeader] and <a href="#message">Message</a> of a particular predefined <a href="#messagetype">MessageType</a>.</p>
<a class="header" href="#messagetype" id="messagetype"><h4>MessageType</h4></a>
<p>An enumeration of the messages which are part of the Tari network. <a href="#messagetype">MessageType</a>s are represented
as an unsigned 8-bit integer and each value must be mapped to a corresponding <a href="#message">Message</a> struct.</p>
<p>All <a href="#messagetype">MessageType</a>s fall within a particular numerical range according to the message's concern:</p>
<table><thead><tr><th> Category     </th><th> Range   </th><th> # message types </th><th> Description                                                            </th></tr></thead><tbody>
<tr><td> reserved     </td><td> 0       </td><td> 1               </td><td> Reserved for control messages such as <code>Ack</code>                            </td></tr>
<tr><td> <code>net</code>        </td><td> 1-32    </td><td> 32              </td><td> Network-related messages such as <code>join</code> and <code>discover</code>                 </td></tr>
<tr><td> <code>peer</code>       </td><td> 33-64   </td><td> 32              </td><td> Peer connection messages, such as <code>establish connection</code>               </td></tr>
<tr><td> <code>blockchain</code> </td><td> 65-96   </td><td> 32              </td><td> Messages related to the blockchain, such as <code>add block</code>                </td></tr>
<tr><td> <code>vn</code>         </td><td> 97-224  </td><td> 128             </td><td> Messages related to the validator nodes, such as <code>execute instruction</code> </td></tr>
<tr><td> <code>extended</code>   </td><td> 225-255 </td><td> 30              </td><td> Reserved for future use                                                </td></tr>
</tbody></table>
<p>In documentation, <a href="#messagetype">MessageType</a>s can be referred to by the category and name. For example, <code>peer::EstablishConnection</code> and
<code>net::Discover</code>.</p>
<a class="header" href="#messageheader" id="messageheader"><h4>MessageHeader</h4></a>
<p>Every Tari message MUST have a header containing the following fields:</p>
<table><thead><tr><th> Name         </th><th> Type </th><th> Description                                                        </th></tr></thead><tbody>
<tr><td> version      </td><td> <code>u8</code> </td><td> The message version.                                               </td></tr>
<tr><td> message_type </td><td> <code>u8</code> </td><td> An enumeration of the message type of the body. See <a href="#messagetype">MessageType</a>. </td></tr>
</tbody></table>
<p>As this is part of the <a href="#MessageEnvelopebody">MessageEnvelopeBody</a>, it can be encrypted along with the rest of the message
which keeps the type of message private.</p>
<a class="header" href="#messagebody" id="messagebody"><h4>MessageBody</h4></a>
<p>Messages are an intention to perform a task, and so MessageType names should be a verb like <code>net::Join</code> or <code>blockchain::AddBlock</code>.</p>
<p>All messages can be categorized as follows, each categorization has rules for how they should be handled:</p>
<ul>
<li>
<p>a propagation message</p>
<ul>
<li>SHOULD NOT have a destination in the MessageHeader</li>
<li>MUST be forwarded</li>
<li>SHOULD use the <code>Random</code> BroadcastStrategy</li>
<li>SHOULD discard a message that they have seen within the <a href="#duplicatemessagewindow">DuplicateMessageWindow</a></li>
</ul>
</li>
<li>
<p>a direct message</p>
<ul>
<li>MUST have a destination in the MessageHeader</li>
<li>SHOULD be discarded if it does not have a destination</li>
<li>SHOULD discard a message that they have seen before</li>
<li>if a destination peer is known, MUST use the <code>Direct</code> BroadcastStrategy</li>
<li>otherwise, SHOULD use the <code>Closest</code> BroadcastStrategy</li>
</ul>
</li>
<li>
<p>an encrypted message</p>
<ul>
<li>all recipients MUST attempt to decrypt the message</li>
<li>recipients MUST forward a message which cannot be decrypted</li>
<li>SHOULD discard a message that they have seen before</li>
</ul>
</li>
</ul>
<p>The <a href="#messagetype">MessageType</a> in the header MUST be used to determine the type of the message deserialize.
If the deserialization fails, the message SHOULD be discarded.</p>
<a class="header" href="#duplicatemessagewindow" id="duplicatemessagewindow"><h4>DuplicateMessageWindow</h4></a>
<p>A configurable length of time for which message signatures should be tracked in order to eliminate duplicate messages.
This should be long enough to make it highly unlikely that a particular message will be processed again
and short enough to not be a burden on the node.</p>
<a class="header" href="#inboundconnection" id="inboundconnection"><h4>InboundConnection</h4></a>
<p>A thin wrapper around a <code>ZMQ_ROUTER</code> socket which binds to a <a href="#netaddress">NetAddress</a> and accepts incoming multipart messages.
This connection blocks until there is data to read, or a timeout is reached. In either case, the <code>receive</code> method
can be called again (i.e. in a loop) to continue listening for messages. Client code should run this loop in it's own thread.
<code>send</code> is only called (if at all) in response to an incoming message.</p>
<p>Fields may include</p>
<ul>
<li>a <a href="#netaddress">NetAddress</a>,</li>
<li>a timeout,</li>
<li>underlying <a href="http://api.zeromq.org/2-1:zmq-socket">ZeroMQ socket</a>.</li>
</ul>
<p>Methods may include:</p>
<ul>
<li><code>receive()</code></li>
<li><code>send(data)</code></li>
<li><code>set_encryption(secret_key)</code></li>
<li><code>set_socks_proxy(address)</code></li>
<li><code>set_hwm(v)</code></li>
</ul>
<p>An InboundConnection:</p>
<ul>
<li>MUST perform the &quot;server-side&quot; <a href="http://curvezmq.org/page:read-the-docs">CurveZMQ</a> encryption protocol if encryption is set.
<ul>
<li>using <a href="http://zeromq.org/">ZeroMQ</a> this means setting the socketopts <code>ZMQ_CURVE_SERVER</code> to 1 and <code>ZMQ_CURVE_SECRETKEY</code> to the secret key before binding.</li>
</ul>
</li>
<li>MUST listen for and accept TCP connections.
<ul>
<li>For an IP <a href="#netaddress">NetAddress</a>, bind on the given host IP and port.</li>
<li>For an Onion <a href="#netaddress">NetAddress</a>, bind on 127.0.0.1 and the given port.</li>
<li>For an I2P <a href="#netaddress">NetAddress</a>, as yet undetermined.</li>
</ul>
</li>
<li>MUST read multipart messages and return them to the caller
<ul>
<li>if the timeout is reached return an error to be handled by the calling code</li>
</ul>
</li>
</ul>
<a class="header" href="#outboundconnection" id="outboundconnection"><h4>OutboundConnection</h4></a>
<p>A thin wrapper around a <code>ZMQ_DEALER</code> socket which connects to a <a href="#netaddress">NetAddress</a> and sends outbound multipart messages.
This connection blocks until data can be written, or a timeout is reached. The timeout should never be reached as
<a href="http://zeromq.org/">ZeroMQ</a> internally queues messages to be sent.</p>
<p>Fields may include</p>
<ul>
<li>a <a href="#netaddress">NetAddress</a>,</li>
<li>underlying <a href="http://api.zeromq.org/2-1:zmq-socket">ZeroMQ socket</a>,</li>
</ul>
<p>Methods may include:</p>
<ul>
<li><code>send(msg)</code></li>
<li><code>receive()</code></li>
<li><code>disconnect()</code></li>
<li><code>set_encryption(server_pk, client_pk, client_sk)</code></li>
<li><code>set_socks_proxy(address)</code></li>
<li><code>set_hwm(v)</code></li>
</ul>
<p>An <a href="#outboundconnection">OutboundConnection</a>:</p>
<ul>
<li>MUST perform the &quot;client-side&quot; <a href="http://curvezmq.org/page:read-the-docs">CurveZMQ</a> encryption protocol if encryption is set.
<ul>
<li>using <a href="http://zeromq.org/">ZeroMQ</a> this means setting the socketopts <code>ZMQ_CURVE_SERVERKEY</code>, <code>ZMQ_CURVE_SECRETKEY</code> and <code>ZMQ_CURVE_PUBLICKEY</code></li>
</ul>
</li>
<li>MUST connect to a TCP endpoint
<ul>
<li>For an IP <a href="#netaddress">NetAddress</a>, connect to the given host IP and port</li>
<li>For an Onion <a href="#netaddress">NetAddress</a>, connect to the onion address using the tcp protocol (e.g. <code>tcp://xyz...123.onion:1234</code>)</li>
<li>For an I2P <a href="#netaddress">NetAddress</a>, as yet undetermined</li>
</ul>
</li>
<li>MUST write the parts of the given <a href="#MessageEnvelope">MessageEnvelope</a> to the socket as a multipart message consisting of, in order:
<ul>
<li>identity</li>
<li>version</li>
<li>header</li>
<li>body</li>
</ul>
</li>
<li>if specified, MUST set a high water mark (HWM) on the underlying <a href="http://zeromq.org/">ZeroMQ</a> socket</li>
<li>If the HWM is reached, a call to <code>send</code> MUST return an error and any messages received SHOULD be discarded</li>
</ul>
<a class="header" href="#peer" id="peer"><h4>Peer</h4></a>
<p>A single peer which can communicate on the Tari network.</p>
<p>Fields may include:</p>
<ul>
<li><code>addresses</code> - a list of <a href="#netaddress">NetAddress</a>es associated with the Peer, perhaps accompanied with some bookkeeping metadata (such as preferred address)</li>
<li><code>node_type</code> - The type of node or client (i.e <a href="Glossary.html#base-node">BaseNode</a>, <a href="Glossary.html#validator-node">ValidatorNode</a>, <a href="Glossary.html#wallet">Wallet</a>, or <a href="Glossary.html#token-wallet">TokenWallet</a>)</li>
<li><code>last_seen</code> - a timestamp of the last time a message has been sent/received from this Peer</li>
<li><code>flags</code> - 8-bit flag
<ul>
<li>bit 0: is_banned</li>
<li>bit 1-7: reserved</li>
</ul>
</li>
</ul>
<p>A Peer may also contain reputation metrics (e.g. rejected_message_count, avg_latency) to be used to decide
if a peer should be banned. This mechanism is yet to be decided.</p>
<a class="header" href="#peerconnection" id="peerconnection"><h4>PeerConnection</h4></a>
<p>Represents direct bi-directional connection to another node or client. As connections are bi-directional,
the <a href="#peerconnection">PeerConnection</a> need only hold a single <a href="#inboundconnection">InboundConnection</a> or <a href="#outboundconnection">OutboundConnection</a>, depending on if the
node requested a peer connect to it or it is connecting to a peer.</p>
<p>PeerConnection will send messages to the peer in a non-blocking, asynchronous manner as long as the connection
is maintained.</p>
<p>It has a few important functions:</p>
<ul>
<li>Manage the underlying network connections; with automatic reconnection if necessary.</li>
<li>Forward incoming messages onto the given handler socket.</li>
<li>Send outgoing messages.</li>
</ul>
<p>Unlike <a href="#inboundconnection">InboundConnection</a> and <a href="#outboundconnection">OutboundConnection</a> which are essentially stateless,
<code>PeerConnection</code> maintains a particular <code>ConnectionState</code>.</p>
<ul>
<li><code>Idle</code> - the connection has not been established.</li>
<li><code>Connecting</code> - the connection is in progress.</li>
<li><code>Connected</code> - the connection has been established.</li>
<li><code>Suspended</code> - the connection has been suspended. Incoming messages will be discarded, calls to <code>send()</code> will error.</li>
<li><code>Dead</code> - the connection is no longer active because the connection was dropped.</li>
<li><code>Shutdown</code> - the connection is no longer active because it was shutdown.</li>
</ul>
<p>Fields may include:</p>
<ul>
<li>a connection state,</li>
<li>a control socket,</li>
<li>a peer connection <code>NetAddress</code></li>
<li>a direction (either <code>Inbound</code> or <code>Outbound</code>)</li>
<li>a public key obtained from the connection negotiation</li>
<li>(optional) SOCKS proxy.</li>
</ul>
<p>Methods may include:</p>
<ul>
<li><code>establish()</code></li>
<li><code>shutdown()</code></li>
<li><code>suspend()</code></li>
<li><code>resume()</code></li>
<li><code>send(msg)</code></li>
</ul>
<p>A <code>PeerConnection</code>:</p>
<ul>
<li>MUST listen for data on the given <a href="#netaddress">NetAddress</a> using an <a href="#inboundconnection">InboundConnection</a></li>
<li>MUST sequentially try to connect to one of the peer's <a href="#netaddress">NetAddress</a>es until one succeeds or all fail using an <a href="#outboundconnection">OutboundConnection</a></li>
<li>MUST immediately reject and dispose of a multipart message not consisting of four parts, as detailed in <a href="#MessageEnvelope">MessageEnvelope</a>.</li>
<li>MUST construct a <a href="#MessageEnvelope">MessageEnvelope</a> from the multiple parts.</li>
<li>MUST pass the constructed <a href="#MessageEnvelope">MessageEnvelope</a> to the message handler.</li>
<li>Should a connection drop, the connection state MUST transition to <code>Connecting</code> and the connection retried.</li>
<li>When a shutdown signal is received, MUST send a <code>net::Disconnect</code> message and drop the connection.</li>
</ul>
<a class="header" href="#connectionmanager" id="connectionmanager"><h4>ConnectionManager</h4></a>
<p>The ConnectionManager manages a set of live PeerConnections and provides an abstraction for other components
to initiate and use PeerConnections without having to worry about attaching the new PeerConnection to message handlers.</p>
<p>It consists of a list of active peer connections and an <code>inproc</code> message handler socket. This socket is 'written to' whenever
a message is received from any active <a href="#peerconnection">PeerConnection</a> for other components to act on.</p>
<p>Methods may include:</p>
<ul>
<li><code>establish_connection(Peer)</code> - create and return a new PeerConnection</li>
<li><code>disconnect(peer)</code> - disconnect a particular peer</li>
<li><code>suspend()</code> - temporarily suspend connections</li>
<li><code>resume()</code> - temporarily suspend connections</li>
<li><code>shutdown</code> - cleanly shutdown all PeerConnections</li>
</ul>
<p>The <code>ConnectionManager</code>:</p>
<ul>
<li>MUST call <code>suspend</code> on every <a href="#peerconnection">PeerConnection</a> if it's <code>suspend</code> method is called</li>
<li>MUST call <code>resume</code> on every <a href="#peerconnection">PeerConnection</a> if it's <code>resume</code> method is called</li>
<li>MUST call <code>shutdown</code> on every <a href="#peerconnection">PeerConnection</a> if it's <code>shutdown</code> method is called</li>
<li>MUST create a new <a href="#peerconnection">PeerConnection</a> with the given Peer and NetAddress, when <code>establish_connection</code> is called</li>
<li>MUST call <code>shutdown</code> on the <a href="#peerconnection">PeerConnection</a> and remove the connection for the given Peer, when <code>disconnect(peer)</code> is called</li>
<li>MAY disconnect peers if the connection has not been used for an extended period</li>
<li>SHOULD disconnect the least recently used peer if the connection pool is greater than <code>max connections</code></li>
</ul>
<a class="header" href="#controlservice" id="controlservice"><h4>ControlService</h4></a>
<p>The purpose of this service is to negotiate a new secure PeerConnection.</p>
<p>The control service accepts a single message:</p>
<ul>
<li><code>peer::EstablishConnection(pk, curve_pk, net_address)</code></li>
</ul>
<p>A ControlService:</p>
<ul>
<li>MUST listen for connections on a predefined CONTROL PORT</li>
<li>SHOULD deny connections from banned peers</li>
</ul>
<p>To establish a peer connection, the following steps apply:</p>
<p>Alice wants to connect to Bob</p>
<ol>
<li>Alice creates a <code>PeerConnection</code> to which Bob can connect.
<ul>
<li>A new CURVE keypair is generated</li>
</ul>
</li>
<li>Alice connects to Bob's control server and Bob accepts the connection.</li>
<li>Alice sends an <code>peer::establish_connection</code> message, with
<ul>
<li>the CURVE public key for the socket connection,</li>
<li>the node's public key corresponding to its <a href="Glossary.html#node-id">Node ID</a>,</li>
<li>the <a href="#netaddress">NetAddress</a> of the new PeerConnection.</li>
</ul>
</li>
<li>Bob accepts this request, and opens a new <code>PeerConnnection</code> socket using Alice's CURVE public key.</li>
<li>Bob connects to the given <a href="#netaddress">NetAddress</a> and sends a <code>peer::establish_connection</code> message.</li>
<li>If Alice accepts the connection, they can begin sending messages. If not, both sides terminate the connection.</li>
</ol>
<a class="header" href="#peermanager" id="peermanager"><h4>PeerManager</h4></a>
<p>The PeerManager's responsibility is to manage the list of peers that the node has previously interacted with.
This list is called a routing table and is made up of <a href="#peer">Peer</a>s.</p>
<p>The PeerManager can</p>
<ul>
<li>add a peer to the routing table,</li>
<li>search for a peer given a node id, public key or <a href="#netaddress">NetAddress</a>,</li>
<li>delete a peer from the list,</li>
<li>persist the peer list using a storage backend,</li>
<li>restore the peer list from the storage backend,</li>
<li>maintain lightweight views of peers; using a filter criterion; e.g. a list of peers that have been banned (i.e. a blacklist),</li>
<li>prune the routing table based on a filter criterion (e.g. last date seen)</li>
</ul>
<a class="header" href="#messagedispatcher" id="messagedispatcher"><h4>MessageDispatcher</h4></a>
<p>A MessageDispatcher associates MessageTypes to handlers. Each handler gets a MessageContext as a parameter.</p>
<p>The MessageContext contains:</p>
<ul>
<li>the requesting PeerConnection,</li>
<li>the MessageHeader</li>
<li>the deserialized message,</li>
<li>the OutboundMessageService.</li>
</ul>
<p>Basically, all the tools the handler needs to interact with the network.</p>
<p>A MessageDispatcher is responsible for:</p>
<ul>
<li>constructing the MessageContext</li>
<li>finding the message handler which is associated with the MessageType</li>
<li>passing the MessageContext to the handler</li>
<li>if the handler cannot be found, the message is ignored</li>
</ul>
<p>An example API may be:</p>
<pre><pre class="playpen"><code class="language-rust compile_fail">
# #![allow(unused_variables)]
#fn main() {
let dispatcher = MessageDispatcher::&lt;MessageType&gt;::new()
    .middleware(logger)
    .route(BlockchainMessageType::NewBlock, BlockHandlers::store_and_broadcast)
    ...
    .route(NetMessageType::Ping, send_pong);

inbound_msg_service.set_handler(dispatcher.handler);
#}</code></pre></pre>
<a class="header" href="#inboundmessageservice" id="inboundmessageservice"><h4>InboundMessageService</h4></a>
<p>InboundMessageService is a service that receives messages over a non-blocking asynchronous socket and
determines what to do with it. There are 3 options: handle, forward, discard.</p>
<p>A pool of worker threads (with a configurable size) is started and each listen for messages on their $1:n$ <code>inproc</code> message
socket. A <code>ZMQ_DEALER</code> socket is suggested for fair-queueing work amongst workers, who listen for work with a <code>ZMQ_REP</code>.
The workers read off this socket and process the messages.</p>
<p>An InboundMessageService:</p>
<ul>
<li>MUST receive messages from all PeerConnections</li>
<li>MUST write the message to the worker socket</li>
</ul>
<p>A worker:</p>
<ul>
<li>MUST deserialize the MessageHeader
<ul>
<li>if unable to deserialize, MUST discard the message</li>
</ul>
</li>
<li>MUST check the message signature
<ul>
<li>MUST discard the message if the signature is invalid.</li>
<li>MUST discard the message if the signature has been processed within the <a href="#duplicatemessagewindow">DuplicateMessageWindow</a></li>
</ul>
</li>
<li>If the encryption flag is set:
<ul>
<li>MUST attempt to decrypt the message
<ul>
<li>if successful, process and handle the message</li>
<li>otherwise, MUST forward the message using the <code>Random</code> BroadcastStrategy</li>
<li>if the message is not encrypted, MUST discard it</li>
</ul>
</li>
</ul>
</li>
<li>If the destination <a href="Glossary.html#node-id">node ID</a> is set:
<ul>
<li>if the destination match this node's ID: process and handle the message</li>
<li>if the destination does not match: MUST forward the message using the <code>Closest</code> BroadcastStrategy</li>
</ul>
</li>
<li>If the destination is not set:
<ul>
<li>if the MessageType is a kind of propagation message:
<ul>
<li>MUST handle the message</li>
<li>MUST forward the message using the <code>Random</code> BroadcastStrategy,</li>
</ul>
</li>
<li>if the MessageType is a kind of encrypted message:
<ul>
<li>MUST attempt to decrypt and handle the message</li>
<li>if successful, MUST handle the message</li>
<li>if unsuccessful, MUST forward the message using the <code>Random</code> or <code>Flood</code> BroadcastStrategy,</li>
</ul>
</li>
</ul>
</li>
</ul>
<a class="header" href="#outboundmessageservice" id="outboundmessageservice"><h4>OutboundMessageService</h4></a>
<p>OutboundMessageService is responsible for using the connection and peer infrastructure to
send messages to the rest of the network.</p>
<p>In particular, it is responsible for:</p>
<ul>
<li>serializing the message body</li>
<li>constructing the <a href="#MessageEnvelope">MessageEnvelope</a></li>
<li>executing the required BroadcastStrategy</li>
<li>sending messages using the [ConnectionManager]</li>
</ul>
<p>The actual sending of messages can be requested via the public <code>send_message</code> method which takes a
MessageHeader, MessageBody and BroadcastStrategy as parameters.</p>
<p><code>send_message</code> then selects an appropriate peer(s) from the ConnectionManager according to the
BroadcastStrategy and sends the message to each of the selected peers.</p>
<p>BroadcastStrategy determines how a set of peer nodes will be selected and can be one of:</p>
<ul>
<li><code>Direct</code> - send to a particular peer matching the given <a href="Glossary.html#node-id">node ID</a></li>
<li><code>Flood</code> - send to all known peers who are not [communication clients]</li>
<li><code>Closest</code> - send to $n$ closest peers who are not [communication clients]</li>
<li><code>Random</code> - send to a random set of peers of size $n$ who are not [communication clients]</li>
</ul>
<a class="header" href="#privacy-features" id="privacy-features"><h3>Privacy Features</h3></a>
<p>The following privacy features are proposed:</p>
<ul>
<li>A <a href="Glossary.html#communication-node">communication node</a> or <a href="Glossary.html#communication-client">communication client</a> MAY communicate solely over the Tor/I2P networks</li>
<li>All traffic (with the exception of the control service) MUST be encrypted</li>
<li>Messages MAY encrypt the body of a MessageEnvelope which only a particular recipient can decrypt.</li>
<li>The <code>destination</code> header field can be omitted, when used in conjunction with body encryption the destination is
completely unknown to the rest of the network.</li>
</ul>
<a class="header" href="#store-and-forward-strategy" id="store-and-forward-strategy"><h3>Store and Forward Strategy</h3></a>
<p>Sometimes it may be desirable for messages to be sent without a destination node/client being online. This
is especially important for a modern chat/messaging application.</p>
<p>The mechanism for this is proposed as follows:</p>
<p>Each <a href="Glossary.html#communication-node">communication node</a> MUST allocate some disk space for storage of messages for offline recipients.
Only some whitelisted MessageTypes are permitted to be stored. A sender sends a message destined for a particular
<a href="Glossary.html#node-id">node ID</a> to its closest peers which forward the message to their closest peers and so on.</p>
<p>Eventually, the message will reach nodes which either know the destination or are very close to the destination.
These nodes MUST store the message in some pending message bucket for the destination. The maximum number of
buckets and the size of each bucket SHOULD be a sufficiently large as to be unlikely to overflow, but not so
large as to approach disk space problems. Individual messages should be small and responsibilities for
storage are spread over the entire network.</p>
<p>A <a href="Glossary.html#communication-node">communication node</a></p>
<ul>
<li>MUST store messages for later retransmission, if all of the following conditions are true:
<ul>
<li>the MessageType is permitted to be stored</li>
<li>there are fewer than $n$ closer online peers to the destination</li>
</ul>
</li>
<li>MUST retransmit pending messages when a closer peer comes online or is added to the routing table</li>
<li>MAY remove a bucket, in any of the following conditions:
<ul>
<li>the bucket is empty,</li>
<li>a configured maximum number of buckets has been reached. Discard the bucket with the earliest creation timestamp.</li>
<li>the number of closer online peers to the destination is equal to or has exceeded $n$</li>
</ul>
</li>
<li>MAY expire individual messages after a sufficiently long time to live (ttl)</li>
</ul>
<p>This approach has the following benefits:</p>
<ul>
<li>When a destination comes online, they'll receive pending messages without having to query them.</li>
<li>The &quot;closer within a threshold&quot; metric is simple.</li>
<li>Messages are stored on multiple peers which makes it less likely for messages to disappear as nodes come and go
(depending on threshold $n$).</li>
</ul>
<a class="header" href="#queue-overflow-strategy" id="queue-overflow-strategy"><h3>Queue Overflow Strategy</h3></a>
<p>Inbound/OutboundConnections (and therefore PeerConnection) has a high water mark (HWM) set.</p>
<p>If the HWM is hit:</p>
<ul>
<li>any call to <code>send()</code> should return an error.</li>
<li>Incoming messages should be silently discarded.</li>
</ul>
<a class="header" href="#outstanding-items" id="outstanding-items"><h3>Outstanding Items</h3></a>
<ul>
<li>A PeerConnection will probably need to implement a heartbeat to detect if a peer has gone offline.</li>
<li>InboundConnection(Service) may want to send small replies (such as OK, ERR) when the message has been accepted/rejected.</li>
<li>OutboundConnection(Service) may want to receive and handle small replies.</li>
<li>Encrypted communication for the <a href="#controlservice">ControlService</a> would be better privacy, but since zMQ requires a CURVE public key before
the connection is bound, a dedicated 'secure connection negotiation socket' would be needed.</li>
<li>Details of distributed message storage.</li>
<li>Which <a href="#netaddress">NetAddress</a> to use if a peer has many.</li>
</ul>
<a class="header" href="#mempool" id="mempool"><h1>Mempool</h1></a>
<a class="header" href="#the-mempool-for-unconfirmed-transactions-on-the-tari-base-layer" id="the-mempool-for-unconfirmed-transactions-on-the-tari-base-layer"><h2>The Mempool for Unconfirmed Transactions on the Tari Base Layer</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/neonknight64">Yuko Roodt</a></p>
<a class="header" href="#license-13" id="license-13"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2018 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-13" id="language-13"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-13" id="disclaimer-13"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-13" id="goals-13"><h2>Goals</h2></a>
<p>This document will introduce the Tari <a href="Glossary.html#mempool">base layer</a> that consists of a <a href="Glossary.html#transaction-pool">Transaction Pool</a>, <a href="Glossary.html#pending-pool">Pending Pool</a>, <a href="Glossary.html#orphan-pool">Orphan Pool</a> and <a href="Glossary.html#reorg-pool">Reorg Pool</a>.
The Mempool is used for storing and managing unconfirmed and time-lock restricted <a href="Glossary.html#transaction">transaction</a>s.</p>
<a class="header" href="#related-rfcs-12" id="related-rfcs-12"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0100_BaseLayer.html">RFC-0100: The Tari Base Layer</a></li>
</ul>
<a class="header" href="#description-11" id="description-11"><h2>Description</h2></a>
<a class="header" href="#assumptions-3" id="assumptions-3"><h3>Assumptions</h3></a>
<ul>
<li>Each <a href="Glossary.html#base-node">base node</a> is connected to a number of peers that maintain their own copies of the Mempool.</li>
</ul>
<a class="header" href="#abstract-3" id="abstract-3"><h3>Abstract</h3></a>
<p>The Mempool is responsible for managing, verifying and maintaining all unconfirmed transactions that have not yet
been included in a <a href="Glossary.html#block">block</a> and added to the Tari <a href="Glossary.html#blockchain">blockchain</a>. It consists of a Transaction Pool, Pending Pool,
Orphan Pool and Reorg Pool to achieve these tasks. It is also responsible for propagating valid transactions and
sharing the Mempool state with connected peers. An overview of the required functionality for the Mempool and each
of its component pools will be provided.</p>
<a class="header" href="#overview-1" id="overview-1"><h3>Overview</h3></a>
<p>Every base node maintains a Mempool that consists of four separate pools: the Transaction Pool, Pending Pool,
Orphan Pool and Reorg Pool. These four pools have different tasks and work together to form the Mempool used
for maintaining unconfirmed transactions.</p>
<p>This is the role descriptions for each component pool:</p>
<ul>
<li>Transaction Pool: contains all unconfirmed transactions that have been verified, have passed all checks, that
only spend valid <a href="Glossary.html#unspent-transaction-outputs">UTXO</a>s and don't have any time-lock restrictions.</li>
<li>Pending Pool: contains unconfirmed transactions that have time-lock restrictions. The transactions in this pool
either attempt to spend UTXOs with time-locks or the transactions themselves have time-locks limiting them from
being included in new blocks until a specified future time or block height has been reached.</li>
<li>Orphan Pool: out of order unconfirmed transactions are managed by this pool, these transactions attempt to spend
non-existent UTXOs.</li>
<li>Reorg Pool: stores a backup of all transactions that have recently been included into blocks, in case a blockchain
reorganization occurs and these transactions have to be restored to the Transaction Pool so that they can be included
in future blocks.</li>
</ul>
<a class="header" href="#prioritizing-unconfirmed-transactions" id="prioritizing-unconfirmed-transactions"><h3>Prioritizing Unconfirmed Transactions</h3></a>
<p>The maximum storage capacity used for storing unconfirmed transactions by the Mempool and each of its component pools
can be configured. If a new transaction is received and the storage capacity limits have been reached, then
transactions are prioritized according to the transaction priority metric. The transaction priority metric consist
of the fees and the maturity of the UTXOs being spent by the transaction and should be applied to determine the priority
of each transaction in the Mempool. As the allocated storage space of the Mempool becomes limited, the transactions
with the highest priority are kept in the pool. The lowest priority transactions are discarded to make room for
higher priority incoming transactions.</p>
<p>The transaction priority metric has the following behavior:</p>
<ul>
<li>Transactions spending UTXOs with higher block height maturity SHOULD be prioritized over transactions spending UTXOs
with lower block height maturity.</li>
<li>Transactions with higher fees per transaction message size SHOULD be prioritized over lower fee transactions.</li>
</ul>
<a class="header" href="#syncing-and-updating-of-the-memory-pool-state" id="syncing-and-updating-of-the-memory-pool-state"><h3>Syncing and Updating of the Memory Pool State</h3></a>
<p>On the initial startup of the Mempool, the complete state of the Mempool that consists of the Transaction Pool, Pending
Pool, Orphan Pool and Reorg Pool can be requested and downloaded from the connected peers. A memory pool typically
doesn't make use of persistent storage but could be configured to keep a backup of the last known state. If an existing
Mempool state is locally available then a more efficient update process can be performed by requesting only the
unconfirmed transactions missing from the current Mempool state. When no state is available then the entire Mempool
state must be downloaded from the connected peers. During downloading or updating of the Mempool state, the validity
of all transaction in the pool must be verified and the priority of each transaction must be calculated.</p>
<p>Functional behavior required for sharing and updating of the Mempool state, and propagation of transactions between peers:</p>
<ul>
<li>All verified transaction MUST be propagated to neighboring peers.</li>
<li>Duplicate transactions MUST NOT be propagated to peers.</li>
<li>Unvalidated or invalid transactions MUST NOT be propagated to peers.</li>
<li>Verified transactions that were discarded due to low priority levels MUST be propagated to peers.</li>
<li>The Mempool MUST have an interface that can be used by neighboring peers to query the content and state of the memory
pool.</li>
<li>It MUST have a mechanism that enables peers to download the memory pool state in full or in part.</li>
<li>It MUST accept all transactions received from peers but MAY decide to discard low priority transactions.</li>
<li>It MUST allow wallets to track payments by monitoring that a particular transaction has been added to the Mempool.</li>
<li>A Mempool MAY choose:
<ul>
<li>to discard the Mempool state on restarts and then download the full state from its peers or</li>
<li>to store the state of the Mempool using persistent storage to reduce communication bandwidth required when
reinitializing the Mempool after a restart.</li>
</ul>
</li>
</ul>
<a class="header" href="#transaction-pool" id="transaction-pool"><h3>Transaction Pool</h3></a>
<p>The Transaction Pool consists of all unconfirmed transactions that have been received, verified and have passed
all checks. These unconfirmed transactions in the Transaction Pool are ready to be included and can be used to
construct new blocks for the Tari blockchain.</p>
<p>Functional behavior required of the Transaction Pool:</p>
<ul>
<li>It MUST verify that incoming transactions only spend existing UTXOs.</li>
<li>It MUST ensure that incoming transactions don't have a processing time-lock or has a time-lock that has
expired.</li>
<li>It MUST ensure that all time-locks of the UTXOs that will be spent by the transaction have expired.</li>
<li>Transactions that have been used to construct new blocks MUST be removed from the Transaction Pool and added to the Reorg Pool.</li>
</ul>
<a class="header" href="#pending-pool" id="pending-pool"><h3>Pending Pool</h3></a>
<p>The Pending Pool contains all transactions that are restricted by time-locks. A transaction could have a time-lock
limiting it from being processed or it can attempt to spend UTXOs with time-locks. These transactions require
their time-locks or the time-locks of the input UTXOs to expire before they can be processed and included into new
blocks. All transactions in the Pending Pool have been verified and passed all checks except their own time-lock has
not yet expired or some of the UTXOs that will be spent have time-lock restrictions that are not yet valid. Once the
transactions time-lock or the time-locks on the UTXOs have expired then the Pending Pool transactions can be moved
to the Transaction Pool for inclusion in future blocks.</p>
<p>Functional behavior required of the Pending Pool:</p>
<ul>
<li>Once the transaction time-lock or UTXO time-lock restricting the processing of a transaction has expired then the
pending transaction MUST be moved to the Transaction Pool.</li>
</ul>
<a class="header" href="#orphan-pool" id="orphan-pool"><h3>Orphan Pool</h3></a>
<p>The Orphan Pool contains all the received transactions that have passed all the verification steps and checks, except
they attempt to spend UTXOs that don't exist. A possible reason these UTXOs do not yet exist is that they may not yet
have been created and might exist in the future. Typically, these orphaned transactions are from a series or bundle of
transactions that need to be processed in a specific order but</p>
<ul>
<li>have been either received out of order,</li>
<li>or the order of processing the bundled transactions might not have been known or specified.</li>
</ul>
<p>As transactions are processed and the missing UTXOs have been created, then the orphaned transactions can be moved
to the Transaction Pool for possible inclusion in future blocks. Another possibility why the input UTXOs might not
be available is that the UTXOs were double spent by other transactions. In time, the double spent transactions will
be discarded from the Orphan Pool once they have reached the appropriate maturity threshold.</p>
<p>Functional behavior required of the Orphan Pool:</p>
<ul>
<li>Each newly received transaction MUST be verified and pass all checks except the UTXO validity check before it is
placed in the Orphan Pool.</li>
<li>Orphaned transactions must be upgraded and moved to the Transaction Pool once the previously unavailable UTXOs become
available.</li>
<li>Orphaned transactions that have surpassed the expiration time threshold MUST be removed from the Orphan Pool.</li>
</ul>
<a class="header" href="#reorg-pool" id="reorg-pool"><h3>Reorg Pool</h3></a>
<p>The Reorg Pool consists of all unconfirmed transaction that have recently been added to blocks, resulting in
their removal from the Transaction Pool. When a potential blockchain reorganization occurs that invalidates previously
assembled blocks, the transactions used to construct these discarded blocks can be recovered from the Reorg Pool and
can be added back into the Transaction Pool. This will ensure that high priority transactions are not lost during
blockchain reorganization but can be added into future blocks without retransmission of these transactions.</p>
<p>Functional behavior required of the Reorg Pool:</p>
<ul>
<li>Copies of the verified transactions removed from the Transaction pool that were placed in blocks MUST be stored in
the Reorg Pool.</li>
<li>Transactions in the Reorg pool MAY be removed after the threshold expiration time has been reached.</li>
<li>When a blockchain reorganization is detected, all affected transactions from the Reorg Pool MUST be moved to the
Transaction Pool.</li>
</ul>
<a class="header" href="#mempool-1" id="mempool-1"><h3>Mempool</h3></a>
<p>The Mempool manages the four component pools and interacts with peers to share and retrieve transactions and
the Mempool state. During the operation of the Mempool it will distribute incoming transactions to the appropriate
component pools. When a new incoming transaction is received a number of checks and verification steps need to be performed
to determine if the transaction can be added to the Mempool and determine which of the component pools should be responsible
for that particular transaction. Only when the new transaction has passed these checks can it be added to the Mempool and
should it be propagated to the connected peers.</p>
<p>Functional behavior required of the Mempool:</p>
<ul>
<li>If a duplicate transaction is received, that already exist in the Mempool, then the duplicate copy MUST be discarded.</li>
<li>When considering transactions that attempt to double spend UTXOs, the highest priority transaction MUST be kept and any
other transactions that spend the same UTXO MUST be discarded.</li>
<li>When the storage limit of the Mempool has been reached, new incoming transactions SHOULD be prioritized according to the
Priority metric.</li>
<li>Lower priority Mempool transactions MUST be discarded to make room for higher priority incoming transactions.</li>
<li>Incoming transactions with lower priorities than the minimum transaction priority in the Mempool MUST be discarded.</li>
<li>The Mempool MUST verify that incoming transactions do not have duplicate outputs.</li>
<li>It MUST check that all coinbase outputs that will be spent have matured sufficiently.</li>
<li>The distribution of storage space allocated to each component pool in the memory pool MAY be configured and adjusted.</li>
<li>The memory pool SHOULD have a mechanism to estimate fee categories from the current Mempool state. As an example,
a priority fee can be estimated that will ensure that a new transactions will have the appropriate priority to be added
into a new block in a timely manner.</li>
</ul>
<p>Functional behavior required for distributing incoming transactions to the component pools:</p>
<ul>
<li>Verified transactions that have passed all checks such as spending of valid UTXOs and expired time-locks MUST be
placed in the Transaction Pool</li>
<li>All transactions that attempt to spend UTXOs with valid time-locks MUST be added to the Pending Pool.</li>
<li>Incoming transactions with time-locks prohibiting them from being included into new blocks should be added to the
Pending Pool.</li>
<li>Newly received verified transaction attempting to spend a UTXO that does not yet exist MUST be added to the Orphan
pool.</li>
<li>Transactions that have been added to blocks and were removed from the Transaction Pool should be added to the Reorg Pool.</li>
</ul>
<a class="header" href="#tari-specific-base-layer-extensions" id="tari-specific-base-layer-extensions"><h1>Tari-specific Base Layer Extensions</h1></a>
<p>This section covers RFCs that describe extensions to the Mimblewimble protocol that enable key functionality for the
Tari Base layer token and Digital Asset network.</p>
<ul>
<li><a href="RFC-0220_AssetCheckpoints.html">RFC-0220: Asset Checkpoints</a></li>
<li><a href="RFC-0230_HTLC.html">RFC-0230: Time related transactions</a></li>
<li><a href="RFC-0322_VNRegistration.html">RFC-0322: Validator Node Registration</a></li>
<li><a href="RFC-0341_AssetRegistration.html">RFC-0322: Asset Registration</a></li>
</ul>
<a class="header" href="#rfc-0220assetcheckpoints" id="rfc-0220assetcheckpoints"><h1>RFC-0220/AssetCheckpoints</h1></a>
<p>RFC placeholder.</p>
<p>This document will describe the mechanism for Asset Checkpoints. To make up for the fact that the DAN has no
proof-of-work and therefore has lower degrees of trustlessness and decentralisation; VN committees must provide
checkpoints on the base layer from time to time. These checkpoints are, amongst other things, immutable commitments to
the state of an asset at a point in time.</p>
<a class="header" href="#rfc-0230time-related-transactions" id="rfc-0230time-related-transactions"><h1>RFC-0230/Time related transactions</h1></a>
<a class="header" href="#time-related-transactions" id="time-related-transactions"><h2>Time related transactions</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/SWvheerden">SW van heerden</a></p>
<a class="header" href="#license-14" id="license-14"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-14" id="language-14"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-14" id="disclaimer-14"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-14" id="goals-14"><h2>Goals</h2></a>
<p>This document describes a few extensions to <a href="Glossary.html#mimblewimble">MimbleWimble</a> to allow time related transactions.</p>
<a class="header" href="#related-rfcs-13" id="related-rfcs-13"><h2>Related RFCs</h2></a>
<ul>
<li><a href="BaseLayerExtensions.html">RFC-0200: Base Layer Extensions</a></li>
</ul>
<a class="header" href="#description-12" id="description-12"><h2>Description</h2></a>
<a class="header" href="#time-locked-contracts" id="time-locked-contracts"><h4>Time Locked contracts</h4></a>
<p>In <a href="Glossary.html#mimblewimble">Mimblewimble</a> time-locked contracts can be accomplished by modifying the kernel of each transaction to include a
block height. This limits how early in the blockchain lifetime the specific transaction can be included in a block.</p>
<p>This requires users constructing a transaction to:</p>
<ul>
<li>MUST include a lock height in the kernel of their transaction,</li>
<li>MUST include the lock height in the transaction signature to prevent lock height malleability.</li>
</ul>
<p>Tari Miners:</p>
<ul>
<li>MUST not add any transaction to the mined <a href="Glossary.html#block">block</a> that has not already exceeded its lock height.</li>
</ul>
<p>This also adds the following requirement to a <a href="Glossary.html#base-node">Base Node</a>:</p>
<ul>
<li>MUST reject any <a href="Glossary.html#block">block</a> that contains a kernel with a lock height greater than the <a href="Glossary.html#current-head">current head</a>.</li>
</ul>
<a class="header" href="#time-locked-utxos" id="time-locked-utxos"><h4>Time Locked UTXOs</h4></a>
<p>Time locked UTXOs can be accomplished by adding feature flag to a UTXO and a lock height. This allows a limit as to when
in the blockchain lifetime the specific UTXO can be spent.</p>
<p>This requires that users constructing a transaction:</p>
<ul>
<li>MUST include a the feature flag of their UTXO,</li>
<li>MUST include a lockheight in their UTXO.</li>
</ul>
<p>This adds the following requirement to a miner:</p>
<ul>
<li>MUST not allow a UTXO to be spent if the <a href="Glossary.html#current-head">current head</a> has not already exceeded the UTXO's lock height.</li>
</ul>
<p>This also adds the following requirement to a <a href="Glossary.html#base-node">base node</a>:</p>
<ul>
<li>MUST reject any <a href="Glossary.html#block">block</a> that contains a <a href="Glossary.html#unspent-transaction-outputs">UTXO</a> with a lock height not already past the <a href="Glossary.html#current-head">current head</a>.</li>
</ul>
<a class="header" href="#hashed-time-locked-contract" id="hashed-time-locked-contract"><h4>Hashed Time Locked Contract</h4></a>
<p>Hashed time locked contracts are a way of reserving funds for a certain payment, but it only pays out to the receiver if
certain conditions are met. If these are not met withing a time limit, the funds are payed back to the sender.</p>
<p>Unlike Bitcoin where this can be accomplished with a single transaction, in <a href="Glossary.html#mimblewimble">MimbleWimble</a> HTLCs involve a multi-step
process to construct a timelocked contract.</p>
<p>The steps are as follows:</p>
<ul>
<li>The sender MUST pay all the funds into a n-of-n <a href="Glossary.html#unspent-transaction-outputs">multisig</a>.</li>
<li>All parties involved MUST construct a refund <a href="Glossary.html#transaction">transaction</a> paying back all funds to the sender, spending this n-of-n
<a href="Glossary.html#unspent-transaction-outputs">multisig</a>. However, this <a href="Glossary.html#transaction">transaction</a> has a <a href="#hashed-time-locked-contract">transaction lock height</a> set in
the future and cannot be immediately mined. It therefore lives in the <a href="Glossary.html#mempool">mempool</a>. This means that if anything goes
wrong from here on out, the sender will get his money back after the time lock expires.</li>
<li>The sender MUST publish both above <a href="Glossary.html#transaction">transaction</a>s at the same time to ensure the receiver cannot hold him hostage.</li>
<li>The parties MUST construct a third <a href="Glossary.html#transaction">transaction</a> that pays the receiver the funds. This <a href="Glossary.html#transaction">transaction</a> typically makes
use of a preimage to allow spending of the <a href="Glossary.html#transaction">transaction</a> if the user reveals some knowledge, allowing the user to
unlock the <a href="Glossary.html#unspent-transaction-outputs">UTXO</a>.</li>
</ul>
<p>HTLC's in <a href="Glossary.html#mimblewimble">Mimblewimble</a> makes use of double spending the n-of-n <a href="Glossary.html#unspent-transaction-outputs">multisig</a> and the
first valid published <a href="Glossary.html#transaction">transaction</a> can then be mined and claim the n-of-n <a href="Glossary.html#unspent-transaction-outputs">multisig</a>.</p>
<p>An example of a <a href="Glossary.html#hashed-time-locked-contract">HTLC</a> in practice can be viewed at Tari University:
<a href="https://tlu.tarilabs.com/protocols/atomic-swaps/AtomicSwaps.html">Bitcoin atomic swaps</a>
<a href="https://tlu.tarilabs.com/protocols/grin-protocol-overview/MainReport.html#atomic-swaps">MimbleWimble atomic swaps</a></p>
<a class="header" href="#rfc-0322vnregistration" id="rfc-0322vnregistration"><h1>RFC-0322/VNRegistration</h1></a>
<a class="header" href="#validator-node-registration" id="validator-node-registration"><h2>Validator Node Registration</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a></p>
<a class="header" href="#license-15" id="license-15"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019. The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-15" id="language-15"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-15" id="disclaimer-15"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-15" id="goals-15"><h2>Goals</h2></a>
<p>This document describes Validator Node registration. Registration accomplishes two goals:</p>
<ol>
<li>Provide a register of Validator Nodes with an authority (the Tari base layer).</li>
<li>Offer Sybil resistance against gaining probabilistic majority of any given publicly nominated VN committee.</li>
</ol>
<a class="header" href="#related-rfcs-14" id="related-rfcs-14"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0302_ValidatorNodes.html">RFC-0302: Validator Nodes</a></li>
<li><a href="RFC-0304_VNCommittees.html">RFC-0304: Validator Node committee selection</a></li>
<li><a href="RFC-0170_NetworkCommunicationProtocol.html">RFC-0170: The Tari Communication Network and Network Communication Protocol</a></li>
<li><a href="RFC-0341_AssetRegistration.html">RFC-0341: Asset Registration</a></li>
<li><a href="BaseLayerExtensions.html">RFC-0200: Base Layer Extensions</a></li>
</ul>
<a class="header" href="#description-13" id="description-13"><h2>Description</h2></a>
<p>Validator Nodes register themselves on the <a href="Glossary.html#base-layer">Base layer</a> using a special <a href="Glossary.html#transaction">transaction</a> type. The registration
<a href="Glossary.html#transaction">transaction</a> type requires the spending of a certain minimum amount of <a href="Glossary.html#tari-coin">Tari coin</a>, the (<a href="Glossary.html#registration-deposit">Registration Deposit</a>),
that has a time-lock on the output for a minimum amount of time (<a href="Glossary.html#registration-term">Registration Term</a>) as well as some metadata, such as
the VNs public key.</p>
<p>The Node ID is calculated after registration to prevent mining of VN public keys that can be used to manipulate routing
on the DHT.</p>
<p>Once a VNs <a href="Glossary.html#registration-term">Registration Term</a> has expired so will this specific VN registration. The UTXO timelock will have elapsed so
the <a href="Glossary.html#registration-deposit">Registration Deposit</a> can be reclaimed and a new VN registration need to be performed. This automatic
registration expiry will ensure that the VN registry stays up to date with active VN registrations and inactive
registrations will naturally be removed.</p>
<p>Requiring nodes to register themselves serves two purposes:</p>
<ul>
<li>Makes VN Sybil attacks expensive,</li>
<li>Provides an authoritative &quot;central-but-not-centralised&quot; registry of validator nodes from the base layer.</li>
</ul>
<a class="header" href="#node-id" id="node-id"><h3>Node ID</h3></a>
<p>The Validator node ID can be calculated deterministically after the VN registration transaction is mined. This ensures
that VNs are randomly distributed over the DHT network.</p>
<p>VN Node IDs MUST be calculated as follows:</p>
<pre><code class="language-text"> NodeId = Hash( pk || h || kh )
</code></pre>
<p>Where</p>
<table><thead><tr><th align="left"> Field </th><th align="left"> Description                                                                   </th></tr></thead><tbody>
<tr><td align="left"> pk    </td><td align="left"> The Validator Node's DHT public key                                           </td></tr>
<tr><td align="left"> h     </td><td align="left"> The block height of the block in which the registration transaction was mined </td></tr>
<tr><td align="left"> kh    </td><td align="left"> The hash of the registration transaction's kernel                             </td></tr>
</tbody></table>
<p>Base Nodes SHOULD maintain a cached list of Validator Nodes and MUST return the Node ID in response to a
<code>get_validator_node_id</code> request.</p>
<a class="header" href="#validator-node-registration-1" id="validator-node-registration-1"><h3>Validator node registration</h3></a>
<p>A validator node MUST register on the base layer before it can join any DAN <a href="Glossary.html#committee">committee</a>s. Registration happens by virtue
of a Validator Node Registration <a href="Glossary.html#transaction">transaction</a>.</p>
<p>VN registrations are valid for the <a href="Glossary.html#registration-term">Registration Term</a>.</p>
<p>The registration term is set at SIX months.</p>
<p>A VN registration transaction is a special transaction.</p>
<ul>
<li>The transaction MUST have EXACTLY ONE UTXO with the <code>VN_Deposit</code> flag set.</li>
<li>This UTXO MUST also:
<ul>
<li>Set a time lock for AT LEAST the <a href="Glossary.html#registration-term">Registration Term</a> (or equivalent block periods)</li>
<li>Provide the <em>value</em> of the UTXO in the signature metadata</li>
<li>Provide the <em>public key</em> for the spending key for the output in the signature metadata</li>
</ul>
</li>
<li>The value of this output MUST be equal or greater than the <a href="Glossary.html#registration-deposit">Registration Deposit</a>.</li>
<li>The UTXO MUST store:
<ul>
<li>The value of the VN deposit UTXO as a u64.</li>
<li>The value of the <em>public key</em> for the spending key for the output as 32 bytes in little endian order.</li>
</ul>
</li>
<li>The <code>KernelFeatures</code> bit flag MUST have the <code>VN_Registration</code> flag set.</li>
<li>The kernel MUST also store the VN's DHT public key as 32 bytes in little endian order.</li>
</ul>
<a class="header" href="#validator-node-registration-renewal" id="validator-node-registration-renewal"><h3>Validator node registration renewal</h3></a>
<p>If a VN owner does not <em>renew</em> the registration before the <a href="Glossary.html#registration-term">Registration Term</a> has expired, the registration will lapse
and the VN will no longer be allowed to participate in any <a href="Glossary.html#committee">committee</a>s.</p>
<p>The number of consecutive renewals MAY increase the VN's reputation score.</p>
<p>A VN may only renew a registration in the TWO WEEK period prior to the current term expiring.</p>
<p>A VN renewal transaction is a special transaction:</p>
<ul>
<li>The transaction MUST have EXACTLY ONE UTXO with the <code>VN_Deposit</code> flag set.</li>
<li>The transaction MUST spend the previous VN Deposit UTXO for this VN.</li>
<li>This UTXO MUST also:
<ul>
<li>Set a time lock for AT LEAST 6 months (or equivalent block periods)</li>
<li>Provide the <em>value</em> of the transaction in the signature metadata</li>
<li>Provide the <em>public key</em> for the spending key for the output in the signature metadata</li>
</ul>
</li>
<li>This UTXO MUST also store
<ul>
<li>The value of the VN deposit UTXO as a u64.</li>
<li>The value of the <em>public key</em> for the spending key for the output as 32 bytes in little endian order.</li>
<li>The VN's Node ID. This can be validated by following the Renewal transaction kernel chain.</li>
<li>The kernel hash of this transaction's kernel.</li>
<li>A counter indicating that this is the n-th consecutive renewal. This counter will be confirmed by nodes and miners.
The first renewal will have counter value of one.</li>
</ul>
</li>
<li>The previous VN deposit UTXO MUST NOT be spendable in a standard transaction (i.e. its time lock has not expired).</li>
<li>The previous VN deposit UTXO MUST expire within the next TWO WEEKS.</li>
<li>The transaction MAY provide additional inputs to cover transaction fees and increases in the <a href="Glossary.html#registration-deposit">Registration Deposit</a>.</li>
<li>The transaction kernel MUST have the <code>VN_Renewal</code> bit flag set.</li>
<li>The transaction kernel MUST also store
<ul>
<li>The hash of the previous renewal transaction kernel, or the registration kernel if this is the first renewal.</li>
</ul>
</li>
</ul>
<p>One will notice that a validator node's Node ID does not change as a result of a renewal transaction. Rather, every
renewal adds to a chain linking back to the original registration transaction. It may be desirable to establish a long
chain of renewals, in order to offer evidence of longevity and improve a VN's reputation.</p>
<a class="header" href="#rfc-0341-asset-registration" id="rfc-0341-asset-registration"><h1>RFC-0341: Asset registration</h1></a>
<a class="header" href="#asset-registration-process" id="asset-registration-process"><h2>Asset registration process</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: Philip Robinson &lt;philipr-za&gt;</p>
<a class="header" href="#license-16" id="license-16"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019. The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-16" id="language-16"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-16" id="disclaimer-16"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-16" id="goals-16"><h2>Goals</h2></a>
<p>This document will describe the process that an <a href="Glossary.html#asset-issuer">Asset Issuer</a> will need to engage in to register a <a href="Glossary.html#digital-asset">digital asset</a> and commence its operation on the <a href="Glossary.html#digital-asset-network">digital asset network</a>.</p>
<a class="header" href="#related-rfcs-15" id="related-rfcs-15"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0311_AssetTemplates.html">RFC-0311: Digital Asset templates</a></li>
<li><a href="RFC-0302_ValidatorNodes.html">RFC-0302: Validator Nodes</a></li>
<li><a href="RFC-0304_VNCommittees.html">RFC-0304: Validator Node committee selection</a></li>
<li><a href="RFC-0220_AssetCheckpoints.html">RFC-0220: Asset Checkpoints</a></li>
</ul>
<a class="header" href="#description-14" id="description-14"><h2>Description</h2></a>
<a class="header" href="#abstract-4" id="abstract-4"><h3>Abstract</h3></a>
<p>This document will describe the process an <a href="Glossary.html#asset-issuer">Asset Issuer</a> (AI) will go through in order to:</p>
<ul>
<li>Register a <a href="Glossary.html#digital-asset">digital asset</a> (DA) on the <a href="Glossary.html#base-layer">base layer</a>,</li>
<li>assemble a <a href="Glossary.html#committee">committee</a> of <a href="Glossary.html#validator-node">Validator Node</a>s (VNs) and</li>
<li>commence operation of the (DA) on the <a href="Glossary.html#digital-asset-network">Digital Asset Network</a> (DAN).</li>
</ul>
<a class="header" href="#asset-creation-instruction" id="asset-creation-instruction"><h3>Asset creation instruction</h3></a>
<p>The first step in registering and commencing the operation of an asset is that the AI MUST issue an asset creation transaction to the <a href="Glossary.html#base-layer">base layer</a>.</p>
<p>This transaction will be time-locked for the length of the desired nomination period. This ensures that this transaction cannot be spent until the nomination period has elapsed so that it is present during the entire nomination process. The value of the transaction will be the <code>asset_creation_fee</code> described in <a href="RFC-0311_AssetTemplates.html">RFC-0311</a>. The AI will spend the transaction back to themselves but locking this fee up at this stage achieves 2 goals. Firstly, it makes it expensive to spam the network with asset creation transactions that a malicious AI does not intend to complete. Secondly, it proves to the VNs that participate in the nomination process that the AI does indeed have the funds required to commence operation of the asset once the committee has been selected. If the asset registration process fails, for example if there are not enough available VNs for the committee, then the AI can refund the fee to themselves after the time-lock expires.</p>
<p>The transaction will contain the following extra metadata to facilitate the registration process:</p>
<ol>
<li>
<p>The value of the transaction in clear text and the public spending key of the commitment so that it can be verified by third parties. A third party can verify the value of the commitment by doing the following:</p>
<ol>
<li>The output commitment is $ C = k.G + v.H $</li>
<li>$ v $ and $ k.G $ are provided in the metadata</li>
<li>A verifier can calculate $ C - k.G = v.H $ and verify this value by multiplying the clear text $ v $ by $ H $ themselves.</li>
</ol>
</li>
<li>
<p>A commitment (hash) to the asset parameters as defined by a <a href="Glossary.html#digitalassettemplate">DigitalAssetTemplate</a> described in <a href="RFC-0311_AssetTemplates.html">RFC-0311</a>. This template will define all the parameters of the asset the AI intends to register including information the VNs need to know like what the required <a href="Glossary.html#assetcollateral">AssetCollateral</a> is to be part of the committee.</p>
</li>
</ol>
<p>Once this transaction has been confirmed to the required depth on the blockchain the nomination phase can begin.</p>
<a class="header" href="#nomination-phase" id="nomination-phase"><h3>Nomination phase</h3></a>
<p>The next step in registering an asset is for the AI to select a committee of VNs to manage the asset. The process to do this is described in <a href="RFC-0304_VNCommittees.html">RFC-0304</a>. This process lasts as long as the time-lock on the asset creation transaction described above. The VNs have until that time-lock elapses to nominate themselves (in the case of an asset being registered using the <code>committee_mode::PUBLIC_NOMINATION</code> parameter in the <a href="Glossary.html#digitalassettemplate">DigitalAssetTemplate</a>).</p>
<a class="header" href="#asset-commencement" id="asset-commencement"><h3>Asset commencement</h3></a>
<p>Once the Nomination phase is complete and the AI has selected a committee as described in <a href="RFC-0304_VNCommittees.html">RFC-0304</a> the chosen committee and AI are ready to commit their <code>asset_creation_fee</code> and <a href="Glossary.html#assetcollateral">AssetCollateral</a>s to commence the operation of the asset. This is done by the AI and the committee members collaborating to build the initial <a href="Glossary.html#checkpoint">Checkpoint</a> of the asset. When this <a href="Glossary.html#checkpoint">Checkpoint</a> transaction is published to the <a href="Glossary.html#base-layer">base layer</a> the <a href="Glossary.html#digital-asset">digital asset</a> will be live on the DAN. The <a href="Glossary.html#checkpoint">Checkpoint</a> transaction is described in <a href="RFC-0220_AssetCheckpoints.html">RFC_0220</a>.</p>
<a class="header" href="#rfc-0300dan" id="rfc-0300dan"><h1>RFC-0300/DAN</h1></a>
<a class="header" href="#the-digital-assets-network-1" id="the-digital-assets-network-1"><h2>The Digital Assets Network</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a>, <a href="https://github.com/philipr-za">Philip Robinson</a></p>
<a class="header" href="#license-17" id="license-17"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2018 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-17" id="language-17"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-17" id="disclaimer-17"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-17" id="goals-17"><h2>Goals</h2></a>
<p>The goal of this RFC is to describe the key features of the Tari second layer, a.k.a the Digital Assets Network (DAN)</p>
<a class="header" href="#related-rfcs-16" id="related-rfcs-16"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0100_BaseLayer.html">RFC-0100: Base layer</a></li>
<li><a href="RFC-0311_AssetTemplates.html">RFC-0311: Digital assets</a></li>
<li><a href="RFC-0340_VNConsensusOverview.html">RFC-0340: VN Consensus Overview</a></li>
<li><a href="RFC-0302_ValidatorNodes.html">RFC-0302: Validator nodes</a></li>
</ul>
<a class="header" href="#description-15" id="description-15"><h2>Description</h2></a>
<a class="header" href="#abstract-5" id="abstract-5"><h3>Abstract</h3></a>
<p><a href="Glossary.html#digital-asset">Digital asset</a>s (DAs) are managed by committees of special nodes called <a href="Glossary.html#validator-node">Validator node</a>s (VNs). VNs manage digital asset state change and ensure
that the rules of the asset contracts are enforced.</p>
<ul>
<li>VNs form a peer-to-peer communication network that together defines the Tari <a href="Glossary.html#digital-asset-network">Digital Asset Network</a> (DAN)</li>
<li>VNs register themselves on the <a href="Glossary.html#base-layer">base layer</a> and commit collateral to prevent Sybil attacks.</li>
<li>Scalability is achieved by sacrificing decentralisation. Not <em>all</em> VNs manage <em>every</em> asset. Assets are managed by
subsets of the DAN, called VN <a href="Glossary.html#committee">committees</a>. These committees reach consensus on DA state amongst themselves.</li>
<li>VNs earn fees for their efforts.</li>
<li>Digital asset contracts are not Turing complete, but are instantiated by <a href="Glossary.html#asset-issuer">Asset Issuer</a>s (AIs) using Digital Asset templates that are defined
in the DAN protocol code.</li>
</ul>
<a class="header" href="#digital-assets" id="digital-assets"><h3>Digital Assets</h3></a>
<ul>
<li>Digital asset contracts are <em>not</em> Turing complete, but are selected from a set of <a href="Glossary.html#digitalassettemplate">DigitalAssetTemplate</a>s that govern
the behaviour of each contract type. e.g. there could be a Single-Use Token template for simple ticketing systems; a
Coupon template for loyalty programmes and so on.</li>
<li>The template system is intended to be highly flexible and additional templates can be added to the protocol periodically.</li>
<li>Asset issuers can link a Registered Asset Issuer Domain (RAID) ID in an OpenAlias TXT public Domain Name System (DNS)
record to a Fully Qualified Domain Name (FQDN) that they own. This is to help disambiguate similar
contracts and improve the signal-to-noise ratio from scam- or copy-cat contracts.</li>
</ul>
<p>An <a href="Glossary.html#asset-issuer">Asset Issuer</a> (AI) will issue a Digital Assets by constructing a contract from one of the supported set of <a href="Glossary.html#digitalassettemplate">DigitalAssetTemplate</a>s. The AI will choose
how large the committee of Validator Nodes will be for this DA and have the option to nominate <a href="Glossary.html#trusted-node">Trusted Node</a>s to be part of the VN committee for the DA.
Any remaining spots on the committee will be filled by permissionless VNs that are selected according to a <a href="Glossary.html#committeeselectionstrategy">CommitteeSelectionStrategy</a>. This is a strategy
that an AI will use to select from the set of potential candidate VNs that nominated themselves for a position on the committee when the AI broadcast a public call for VNs during the asset creation process. For the VNs to accept the appointment to the committee they will need to put up the specified collateral.</p>
<a class="header" href="#rfc-0301namespaceregistration" id="rfc-0301namespaceregistration"><h1>RFC-0301/NamespaceRegistration</h1></a>
<a class="header" href="#namespace-registration-on-the-base-layer" id="namespace-registration-on-the-base-layer"><h2>Namespace Registration on the Base Layer</h2></a>
<p><img src="./theme/images/status-draft.svg" alt="status: raw" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github,com/hansieodendaal">Hansie Odendaal</a></p>
<a class="header" href="#license-18" id="license-18"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS ORRAID
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-18" id="language-18"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-18" id="disclaimer-18"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-18" id="goals-18"><h2>Goals</h2></a>
<p>This purpose of this document is to describe and specify the process for creating and linking an <a href="Glossary.html#asset-issuer">asset issuer</a>
specified domain name with a <a href="Glossary.html#digital-asset">digital asset</a> on the Digital Assets Network (<a href="Glossary.html#digital-asset-network">DAN</a>).</p>
<a class="header" href="#related-rfcs-17" id="related-rfcs-17"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0341_AssetRegistration.html">RFC-0341/AssetRegistration</a></li>
<li><a href="RFC-0311_AssetTemplates.html">RFC-0310/AssetTemplates</a></li>
</ul>
<p><br></p>
<a class="header" href="#description-16" id="description-16"><h1>Description</h1></a>
<a class="header" href="#background" id="background"><h2>Background</h2></a>
<a class="header" href="#alternative-approaches" id="alternative-approaches"><h3>Alternative Approaches</h3></a>
<p>In order to easily differentiate different <a href="Glossary.html#digital-asset">digital asset</a>s in the DAN, apart from some unique unpronounceable
character string, a human readable identifier (domain name) is required. It is perceived that shorter names will have
higher value due to branding and marketability, and the question is how this can be managed elegantly. It is also
undesirable if for example the real Disney is forced to use the long versioned &quot;<em>disney.com-goofy-is-my-asset-yes</em>&quot;
because some fake Disneys claimed &quot;<em>goofy</em>&quot; and &quot;<em>disney.com-goofy</em>&quot; and everything in between.</p>
<p>One method to curb name space squatting is to register names on the <a href="Glossary.html#base-layer">base layer</a> layer with a domain name registration
transaction. Let us call such a name a Registered Asset Issuer Name (RAIN). To make registering RAINs difficult enough
to prevent spamming the network, a certain amount of <a href="Glossary.html#tari-coin">Tari coins</a> must be committed in a burn (permanently destroy) or
a time locked pay to self type transaction. Lots of management overhead will be associated with such a scheme, even if
domain-less assets are allowed. However, it would be impossible to stop someone
from registering say a &quot;<em>disney.com</em>&quot; RAIN if they do not own the real &quot;<em>disney.com</em>&quot; Fully Qualified Domain Name (FQDN).</p>
<p>Another approach would be to make use of the public Domain Name System (DNS) and to link the FQDNs, that are already
registered, to the <a href="Glossary.html#digital-asset">digital asset</a>s in the DAN, making use of <a href="https://openalias.org/">OpenAlias</a> text (TXT) DNS
records on a FQDN. Let us call this a Registered Asset Issuer Domain (RAID) TXT record. If we hash a public key and
FQDN pair, it will provide us with a unique RAID_ID (RAID Identification). The RAID_ID will serve a similar purpose in
the DAN as a Top Level Domain (TLD) in a DNS, as all digital assets belonging to a specific <a href="Glossary.html#asset-issuer">asset issuer</a> could then
be grouped under the FQDN by inference. To make this scheme more elaborate, but potentially unnecessary, all such
RAID_IDs could also be registered on the <a href="Glossary.html#base-layer">base layer</a>, similar to the RAIN scheme.</p>
<p>If the standard Mimblewimble protocol is followed, a new output feature can be defined to cater for a RAID tuple
<code>(RAID_ID, PubKey)</code> that is linked to a specific Unspent Transaction Output (<a href="Glossary.html#unspent-transaction-outputs">UTXO</a>). The <code>RAID_ID</code> could be based on
a <a href="https://en.bitcoin.it/wiki/Base58Check_encoding">Base58Check</a> variant applied to <code>Hash256(PubKey || FQDN)</code>. If the
amount of Tari coins associated with the RAID tuple transaction is burned, <code>(RAID_ID, PubKey)</code> will forever be present
on the blockchain and can increase blockchain bloat. On the other hand, if those <a href="Glossary.html#tari-coin">Tari coins</a> are spent back to its
owner with a specific time lock, it will be possible to spend and prune that UTXO later on. While that UTXO remains
unspent, the RAID tuple will be valid, but when all or part of it is spent, the RAID tuple will disappear from the
blockchain. Such a UTXO will thus be &quot;colored&quot; while unspent as it will have different properties to a normal UTXO. It
will also be possible to recreate the original RAID tuple by registering it using the original <code>Hash256(PubKey || FQDN)</code>.</p>
<p>Thinking about the makeup of the <code>RAID_ID</code> it is evident that it can easily be calculated on the fly using the public
key and FQDN, both of which values will always be known. The biggest advantage having the RAID tuple on the <a href="Glossary.html#base-layer">base
layer</a> is that of embedded consensus, where it will be validated (as no duplicates can be allowed) and mined before it
can be used. However, this comes at the cost of more complex code, a more elaborate asset registration process and
higher asset registration fees.</p>
<a class="header" href="#this-rfc" id="this-rfc"><h3>This RFC</h3></a>
<p>This document explores the creation and use of RAID TXT records to link asset issuer specified domain names with
digital assets on the <a href="Glossary.html#digital-asset-network">DAN</a>, without RAID_IDs being registered on the <a href="Glossary.html#base-layer">base layer</a>.</p>
<a class="header" href="#requirements" id="requirements"><h2>Requirements</h2></a>
<a class="header" href="#openalias-txt-dns-records" id="openalias-txt-dns-records"><h3>OpenAlias TXT DNS Records</h3></a>
<p>An OpenAlias TXT DNS record [<a href="https://docs.rs/openalias/0.2.0/openalias/index.html" title="Crate openalias">1</a>] on a FQDN is a single string and starts with &quot;<em>oa1:&lt;name&gt;</em>&quot; field followed by a
number of key-value pairs. Standard (optional) key-values are: &quot;<em>recipient_address</em>&quot;; &quot;<em>recipient_name</em>&quot;;
&quot;<em>tx_description</em>&quot;; &quot;<em>tx_amount</em>&quot;; &quot;<em>tx_payment_id</em>&quot;; &quot;<em>address_signature</em>&quot; and &quot;<em>checksum</em>&quot;. Additional key-values
may also be defined. Only entities with write access to a specific DNS record will be able to create the required TXT
DNS record entries.</p>
<p>TXT DNS records are limited to multiple strings of size 255, and as the User Datagram Protocol (UDP) size is 512 bytes, a TXT DNS record that exceeds that limit is less optimal [<a href="https://tools.ietf.org/html/rfc7208" title="RFC 7208">2</a>, Sections 3.3 &amp; 3.4]. Some hosting sites also pose limitations to TXT DNS record string lengths and concatenation of multiple strings as per [<a href="https://tools.ietf.org/html/rfc7208" title="RFC 7208">2</a>]. The basic idea of this specification is to make the implementation robust and flexible at the same time.</p>
<p><strong>Req</strong> - Integration with public DNS records MUST be used to ensure valid ownership of an FQDN that needs to be
linked to a <a href="Glossary.html#digital-asset">digital asset</a> on the DAN.</p>
<p><strong>Req</strong> - The total size of the OpenAlias TXT DNS record SHOULD not exceed 255 characters.</p>
<p><strong>Req</strong> - The total size of the OpenAlias TXT DNS record MUST not exceed 512 characters.</p>
<p><strong>Req</strong> - The OpenAlias TXT DNS record implementation MUST make provision to interpret entries that are made up of more than one string as defined in [<a href="https://tools.ietf.org/html/rfc7208" title="RFC 7208">2</a>].</p>
<p><strong>Req</strong> - The OpenAlias TXT DNS record SHOULD adhere to the formatting requirements as specified in [<a href="https://docs.rs/openalias/0.2.0/openalias/index.html" title="Crate openalias">1</a>].</p>
<p><strong>Req</strong> - The OpenAlias TXT DNS record MUST be constructed as follows:</p>
<table><thead><tr><th> OpenAlias TXT DNS Record Field </th><th> OpenAlias TXT DNS Record Data                                </th></tr></thead><tbody>
<tr><td> oa1:&lt;name&gt;                   </td><td> &quot;oa1:tari&quot;                                                   </td></tr>
<tr><td> pk                             </td><td> &lt;256 bit public key, in hexadecimal format (64 characters), that is converted into a <code>Base58</code> encoded string (44 characters)&gt; </td></tr>
<tr><td> raid_id                        </td><td> &lt;<code>RAID_ID</code> (<em>see <a href="#the-raid_id">The RAID_ID</a></em>) (15 characters)&gt; </td></tr>
<tr><td> nonce                          </td><td> &lt;256 bit public nonce, in hexadecimal format (64 characters), that is converted into a <code>Base58</code> encoded string (44 characters)&gt; </td></tr>
<tr><td> sig                            </td><td> &lt;<a href="Glossary.html#asset-issuer">Asset issuer</a>'s 256 bit Schnorr signature for the <code>RAID_ID</code> (<em>see <a href="#the-raid_id">The RAID_ID</a></em>), in hexadecimal format (64 characters), that is converted into a <code>Base58</code> encoded string (44 characters)&gt; </td></tr>
<tr><td> desc                           </td><td> &lt;Optional RAID description&gt;; ASCII String; Up to 48 characters for the condensed version (using only one string) and up to 235 characters (when spanning two strings). </td></tr>
<tr><td> crc                            </td><td> &lt;CRC-32 checksum of the entire record up to but excluding the checksum key-value pair (starting at &quot;<strong>oa1:tari</strong>&quot; and ending at the last &quot;<strong>;</strong>&quot; before the checksum key-value pair) in hexadecimal format (8 characters)&gt; </td></tr>
</tbody></table>
<p>    Examples: Two example OpenAlias TXT DNS records are shown; the first a condensed version and the second one that spans two strings:</p>
<pre><code class="language-text">RAID_ID:
public key    = ca469346d7643336c19155fdf5c6500a5232525ce4eba7e4db757639159e9861
FQDN          = disney.com
 -&gt; id        = RYqMMuSmBZFQkgp
   
base58 encodings:
public key    = ca469346d7643336c19155fdf5c6500a5232525ce4eba7e4db757639159e9861
 -&gt; base58    = EcbmnM6PLosBzpyCcBz1TikpNXRKcucpm73ez6xYfLtg
public nonce  = fc2c5fce596338f43f70dc0ce14659fdfea1ba3e588a7c6fa79957fc70aa1b4b
 -&gt; base58    = 5ctFNnCfBrP99rT1AFmj1WPyMD8uAdNUTESHhLoV3KBZ
signature     = 7dc54ec98da2350b0c8ed0561537517ac6f93a37f08a34482824e7df3514ce0d
 -&gt; base58    = 9TxTorviyTJAaVJ4eY4AQPixwLb6SDL4dieHff6MFUha
   
OpenAlias TXT DNS record (condensed: 211 characters):
IN   TXT = &quot;oa1:tari pk=EcbmnM6PLosBzpyCcBz1TikpNXRKcucpm73ez6xYfLtg;id=RYqMMuSmBZFQkgp;
nonce=5ctFNnCfBrP99rT1AFmj1WPyMD8uAdNUTESHhLoV3KBZ;sig=9TxTorviyTJAaVJ4eY4AQPixwLb6SDL4dieHff6MFUha;
desc=Cartoon charaters;crc=B31C7CA0&quot;

OpenAlias TXT DNS record (spanning two strings: string 1 = 179 characters and string 2 = 249 characters):
IN   TXT = &quot;oa1:tari pk=EcbmnM6PLosBzpyCcBz1TikpNXRKcucpm73ez6xYfLtg; id=RYqMMuSmBZFQkgp; 
nonce=5ctFNnCfBrP99rT1AFmj1WPyMD8uAdNUTESHhLoV3KBZ; sig=9TxTorviyTJAaVJ4eY4AQPixwLb6SDL4dieHff6MFUha; &quot;
&quot;desc=Cartoon charaters: Mickey Mouse\; Minnie Mouse\; Goofy\; Donald Duck\; Pluto\; Daisy Duck\; 
Scrooge McDuck\; Launchpad McQuack\; Huey, Dewey and Louie\; Bambi\; Thumper\; Flower\; Faline\; 
Tinker Bell\; Peter Pan and Captain Hook.; crc=96EC6593&quot;
</code></pre>
<a class="header" href="#the-raid_id" id="the-raid_id"><h3>The RAID_ID</h3></a>
<p>Because the <code>RAID_ID</code> does not exist as an entity on the base layer or in the <a href="Glossary.html#digital-asset-network">DAN</a>, it cannot be owned or
transferred, but only be verified as part of the OpenAlias TXT DNS record [<a href="https://docs.rs/openalias/0.2.0/openalias/index.html" title="Crate openalias">1</a>] verification. If an asset creator
chooses not to link a <code>RAID_ID</code> and FQDN, a default network assigned <code>RAID_ID</code> will be used in the digital asset
registration process.</p>
<p><strong>Req</strong> - A default <code>RAID_ID</code> MUST be used where it will not be linked to a FQDN, for example it MAY be derived
from a default input string <code>&quot;No FQDN&quot;</code>.</p>
<p><strong>Req</strong> - A FQDN linked (non-default) <code>RAID_ID</code> MUST be derived from the concatenation <code>PubKey || &lt;FQDN&gt;</code>.</p>
<p><strong>Req</strong> - All concatenations of inputs for any hash algorithm MUST be done without adding any spaces.</p>
<p><strong>Req</strong> - The hash algorithm MUST be <code>Blake2b</code> using a 32 byte digest size unless otherwise specified.</p>
<p><strong>Req</strong> - Deriving a <code>RAID_ID</code> MUST be calculated as follows:</p>
<ul>
<li>Inputs for all hashing algorithms used to calculate the <code>RAID_ID</code> MUST be lower case characters.</li>
<li>Stage 1 - MUST select the input string to use (either <code>&quot;No FQDN&quot;</code> or <code>PubKey || &lt;FQDN&gt;</code>).
<ul>
<li>Example: Mimblewimble public key <code>ca469346d7643336c19155fdf5c6500a5232525ce4eba7e4db757639159e9861</code> and FQDN
<code>disney.com</code> is used here, resulting in <code>ca469346d7643336c19155fdf5c6500a5232525ce4eba7e4db757639159e9861disney.com</code>.</li>
</ul>
</li>
<li>Stage 2 - MUST perform <code>Blake2b</code> hashing on the result of stage 1 using a 10 byte digest size.
<ul>
<li>Example: In hexadecimal representation <code>ff517a1387153cc38009</code> or binary representation<code>\xffQz\x13\x87\x15&lt;\xc3\x80\t</code></li>
</ul>
</li>
<li>Stage 3 - MUST concatenate the <code>RAID_ID</code> identifier byte, <code>0x62</code>, with the result of stage 2.
<ul>
<li>Example: <code>62ff517a1387153cc38009</code> `</li>
</ul>
</li>
<li>Stage 4 - MUST convert the result of stage 3 from a byte string into <code>Base58</code> encoded string.
This will result in a 15 character string starting with <code>R</code>.
<ul>
<li>Example: The resulting <code>RAID_ID</code> will be <code>RYqMMuSmBZFQkgp</code>.</li>
</ul>
</li>
</ul>
<p><strong>Req</strong> - A valid <code>RAID_ID</code> signature MUST be a 256 bit Schnorr signature defined as <code>s = PvtNonce + e·PvtKey</code> with
the challenge <code>e</code> being <code>e = Blake2b(PubNonce || PubKey || RAID_ID)</code>.</p>
<a class="header" href="#sequence-of-events" id="sequence-of-events"><h3>Sequence of Events</h3></a>
<p>The sequence of events leading up to digital asset registration are perceived as follows:</p>
<ol>
<li>
<p>The <a href="Glossary.html#asset-issuer">asset issuer</a> will decide if the default <code>RAID_ID</code> or a <code>RAID_ID</code> that is linked to a FQDN must be used for
asset registration.
(<em><strong>Note:</strong> A single linked (<code>RAID_ID</code>, FQDN) tuple may be associated with multiple digital assets from the same
asset issuer.</em>)</p>
</li>
<li>
<p><strong>Req</strong> - If a default <code>RAID_ID</code> is required:</p>
<ol>
<li>The asset issuer MUST use the default <code>RAID_ID</code> (see <a href="#the-raid_id">The RAID_ID</a>).</li>
<li>The asset issuer MUST NOT sign the <code>RAID_ID</code>.</li>
</ol>
</li>
<li>
<p><strong>Req</strong> - If a linked (<code>RAID_ID</code>, FQDN) tuple is required:</p>
<ol>
<li>The asset issuer MUST create a <code>RAID_ID</code>.</li>
<li>The asset issuer MUST sign the <code>RAID_ID</code> as specified (see <a href="#the-raid_id">The RAID_ID</a>).</li>
<li>The asset issuer MUST create a valid TXT DNS record (see <a href="#openalias-txt-dns-records">OpenAlias TXT DNS Records</a>).</li>
</ol>
</li>
<li>
<p><strong>Req</strong> - <a href="Glossary.html#validator-node">Validator Node</a>s (VN) MUST only allow a valid <code>RAID_ID</code> to be used in the digital asset registration
process.</p>
</li>
<li>
<p><strong>Req</strong> - VNs MUST verify the OpenAlias TXT DNS record if a linked (<code>RAID_ID</code>, FQDN) tuple is used:</p>
<ol>
<li>Verify that all fields have been completed as per the specification (see
<a href="#openalias-txt-dns-records">OpenAlias TXT DNS Records</a>).</li>
<li>Verify that the <code>RAID_ID</code> can be calculated from information provided in the TXT DNS record and the FQDN of the public DNS record it is in.</li>
<li>Verify that the asset issuer's <code>RAID_ID</code> signature is valid.</li>
<li>Verify the checksum.</li>
</ol>
</li>
</ol>
<a class="header" href="#confidentiality-and-security" id="confidentiality-and-security"><h3>Confidentiality and Security</h3></a>
<p>To prevent client lookups from leaking, OpenAlias recommends making use of <a href="https://dnscrypt.info/">DNSCrypt</a>,
resolution via DNSCrypt-compatible resolvers that support Domain Name System Security Extensions (DNSSEC) and without
DNS requests being logged.</p>
<p><strong>Req</strong> - <a href="Glossary.html#token-wallet">Token Wallet</a>s (TW) and VNs SHOULD implement the following confidentiality and security measures when
dealing with OpenAlias TXT DNS records:</p>
<ul>
<li>All queries SHOULD make use of the DNSCrypt protocol.</li>
<li>Resolution SHOULD be forced via DNSCrypt-compatible resolvers that
<ul>
<li>support DNSSEC;</li>
<li>do not log DNS requests.</li>
</ul>
</li>
<li>The DNSSEC trust chain validity:
<ul>
<li>SHOULD be verified;</li>
<li>SHOULD be reported back to the <a href="Glossary.html#asset-issuer">asset issuer</a>.</li>
</ul>
</li>
</ul>
<a class="header" href="#references" id="references"><h2>References</h2></a>
<p>[<a href="https://docs.rs/openalias/0.2.0/openalias/index.html" title="Crate openalias">1</a>] Crate openalias [online]. Available: https://docs.rs/openalias/0.2.0/openalias/index.html.
Date accessed: 2019-03-05.</p>
<p>[<a href="https://tools.ietf.org/html/rfc7208" title="RFC 7208">2</a>] RFC 7208: Sender Policy Framework (SPF) for Authorizing Use of Domains in Email, Version 1 [online].
Available: https://tools.ietf.org/html/rfc7208. Date accessed: 2019-03-06.</p>
<a class="header" href="#rfc-0302validatornode" id="rfc-0302validatornode"><h1>RFC-0302/ValidatorNode</h1></a>
<a class="header" href="#validator-nodes" id="validator-nodes"><h2>Validator Nodes</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a>, <a href="https://github.com/philipr-za">Philip Robinson</a></p>
<a class="header" href="#license-19" id="license-19"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2018 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-19" id="language-19"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-19" id="disclaimer-19"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-19" id="goals-19"><h2>Goals</h2></a>
<p>The goal of this RFC is to describe the responisibilities of Validator Nodes (VNs) on the DAN.</p>
<a class="header" href="#related-rfcs-18" id="related-rfcs-18"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0322_VNRegistration.html">RFC-0322: Validator Node Registration</a></li>
<li><a href="RFC-0304_VNCommittees.html">RFC-0304: Validator Node committee selection</a></li>
<li><a href="RFC-0340_VNConsensusOverview.html">RFC-0340: VN Consensus Overview</a></li>
</ul>
<a class="header" href="#description-17" id="description-17"><h2>Description</h2></a>
<a class="header" href="#abstract-6" id="abstract-6"><h3>Abstract</h3></a>
<p><a href="Glossary.html#validator-node">Validator Node</a>s form the basis of the second layer DAN. All actions on this network take place by interacting with VN's. Some examples of actions
that VNs will facilitate are:</p>
<ul>
<li>Issuing a <a href="Glossary.html#digital-asset">Digital Asset</a>,</li>
<li>querying the state of <a href="Glossary.html#digital-asset">Digital Asset</a> and its constituent <a href="Glossary.html#digital-asset-tokens">tokens</a>,</li>
<li>issuing an instruction to change the state of a <a href="Glossary.html#digital-asset">Digital Asset</a> or <a href="Glossary.html#digital-asset-tokens">tokens</a>.</li>
</ul>
<p>VNs will also perform archival functions for the assets they manage. The lifetime of these archives and the fee structure for this function is
still being discussed.</p>
<a class="header" href="#registration" id="registration"><h4>Registration</h4></a>
<p>VNs register themselves on the <a href="Glossary.html#base-layer">Base Layer</a> using a special <a href="Glossary.html#transaction">transaction</a> type.</p>
<p>Validator node registration is described in <a href="RFC-0322_VNRegistration.html">RFC-0322</a>.</p>
<a class="header" href="#execution-of-instructions" id="execution-of-instructions"><h4>Execution of instructions</h4></a>
<p>VNs are expected to manage the state of digital assets on behalf of digital asset issuers. They receive fees as reward
for doing this.</p>
<ul>
<li>Digital assets consist of an initial state plus a set of state transition rules. These rules are set by the Tari
protocol, but will usually provide parameters that must be specified by the <a href="Glossary.html#asset-issuer">Asset Issuer</a>.</li>
<li>The set of VNs that participate in managing state of a specific DA is called a <a href="Glossary.html#committee">Committee</a>. A committee is selected during the asset
issuance process and membership of the committee can be updated at <a href="Glossary.html#checkpoint">Checkpoint</a>s.</li>
<li>It is the VNs responsibility to ensure that every state change in a digital asset conforms to the contract's rules.</li>
<li>VNs accept digital asset <a href="Glossary.html#instructions">Instructions</a> from clients and peers. <a href="Glossary.html#instructions">Instructions</a> allow for creating, updating, expiring and archiving digital assets on the DAN.</li>
<li>VNs provide additional collateral, called <a href="Glossary.html#assetcollateral">AssetCollateral</a>, when accepting an offer to manage an asset, which is stored in a multi-signature
UTXO on the base layer. This collateral can be taken from the VN if it is proven that the VN engaged in
malicious behaviour.</li>
<li>VNs participate in fraud proof validations in the event of consensus disputes (which could result in the malicious VN's
collateral being slashed).</li>
<li>Digital asset metadata (e.g. large images) are managed by VNs. The large data itself will not be stored on the VNs but an external location and a hash of the data can be stored. Whether the data is considered part of the state
(and thus checkpointed) or out of state depends on the type of digital asset contract employed.</li>
</ul>
<a class="header" href="#fees" id="fees"><h4>Fees</h4></a>
<p>Fees will be paid to VNs based on the amount of work they did during a checkpoint period. The fees will be paid from a fee pool which will be collected
and reside in a UTXO that is accessible by the committee. The exact mechanism for the the payment of the fees by the committee and who pays the various
types of fees is still under discussion.</p>
<a class="header" href="#checkpoints" id="checkpoints"><h4>Checkpoints</h4></a>
<p>VNs periodically post checkpoint summaries to the <a href="Glossary.html#base-layer">base layer</a> for each asset that they are managing. The checkpoints will form an immutable
record of the <a href="Glossary.html#digital-asset">Digital Asset</a> state on the base-layer. There will be two types of checkpoints:</p>
<ul>
<li>
<p>An Opening checkpoint (OC) will:</p>
<ul>
<li>Specify the members of the VN committee.</li>
<li>Lock up the collateral for the committee members for this checkpoint period.</li>
<li>Collect the fee pool for this checkpoint period from the Asset Issuer into a Multi-Sig UTXO under the control of the committee.
This can be a top-up of the fees or a whole new fee pool.</li>
</ul>
</li>
<li>
<p>A Closing checkpoint (CC) will:</p>
<ul>
<li>Summarize the Digital Asset state on the base layer.</li>
<li>Release the fee pay outs.</li>
<li>Release the collateral for the committee members for this checkpoint period.</li>
<li>Allow for committee members to resign from the committee</li>
</ul>
</li>
</ul>
<p>After an DA is issued there will immediately be an Opening checkpoint. After a checkpoint period there will then be a Closing checkpoint followed
immediately by an Opening checkpoint for the next period, we will call this set of checkpoints an Intermediate checkpoint, which could be a compressed combination of an opening and closing checkpoint. This will continue
until the end of the asset's lifetime where there will be a final Closing checkpoint that will be followed by the retirement of the asset.</p>
<div class="mermaid">
graph LR;
    subgraph Asset Issuance
    IssueAsset-->OC1;
    end
    OC1-->CC1;
    subgraph Intermediate Checkpoint
    CC1-->OC2;
    end
    OC2-->CC2;
    subgraph Intermediate Checkpoint
    CC2-->OC3;
    end
    OC3-->CC3;
    subgraph Asset Retirement
    CC3-->RetireAsset;
    end
</div>
<a class="header" href="#consensus" id="consensus"><h4>Consensus</h4></a>
<p>Committees of VNs will use a <a href="Glossary.html#consensusstrategy">ConsensusStrategy</a> to manage the process of</p>
<ul>
<li>Propogating signed instructions between members of the committee.</li>
<li>Determining when the threshold has been reached for an instruction to be considered valid.</li>
</ul>
<p>Part of the <a href="Glossary.html#consensusstrategy">ConsensusStrategy</a> will be mechanisms for detecting actions by <a href="Glossary.html#bad-actor">Bad Actor</a>s. The nature of the enforcement actions that can be taken
against bad actors are still to be decided.</p>
<a class="header" href="#network-communication" id="network-communication"><h3>Network communication</h3></a>
<p>The VNs will communicate using a peer-to-peer (P2P) network. To facilitate this this VNs must perform the following functions:</p>
<ul>
<li>VNs MUST maintain a list of peers, and which assets each peer is managing.</li>
<li>VNs MUST relay <a href="Glossary.html#instructions">instructions</a> to members of the committee that are managing the relevant asset.</li>
<li>VNs MUST respond to requests for information about digital assets that they manage on the DAN.</li>
<li>VNs and clients can advertise public keys to facilitate P2P communication encryption</li>
</ul>
<a class="header" href="#rfc-0304vncommittees" id="rfc-0304vncommittees"><h1>RFC-0304/VNCommittees</h1></a>
<a class="header" href="#validator-node-committee-selection" id="validator-node-committee-selection"><h2>Validator Node committee selection</h2></a>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: Philip Robinson &lt;philipr-za&gt;</p>
<a class="header" href="#license-20" id="license-20"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019. The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-20" id="language-20"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-20" id="disclaimer-20"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-20" id="goals-20"><h2>Goals</h2></a>
<p>This document will describe the process an <a href="Glossary.html#asset-issuer">Asset Issuer</a> (AI) will go through in order to select the committee of <a href="Glossary.html#validator-node">Validator Node</a>s
(VNs) that will serve a given <a href="Glossary.html#digital-asset">Digital Asset</a> (DA).</p>
<a class="header" href="#related-rfcs-19" id="related-rfcs-19"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0311_AssetTemplates.html">RFC-0311: Digital Asset templates</a></li>
<li><a href="RFC-0302_ValidatorNodes.html">RFC-0302: Validator Nodes</a></li>
<li><a href="RFC-0341_AssetRegistration.html">RFC-0341: Asset Registration</a></li>
</ul>
<a class="header" href="#description-18" id="description-18"><h2>Description</h2></a>
<a class="header" href="#abstract-7" id="abstract-7"><h3>Abstract</h3></a>
<p><a href="Glossary.html#digital-asset">Digital Asset</a>s (DAs) are managed by <a href="Glossary.html#committee">committee</a>s of nodes called <a href="Glossary.html#validator-node">Validator Node</a>s (VNs), as described in <a href="RFC-0300_DAN.html">RFC-0300</a> and <a href="RFC-0302_ValidatorNodes.html">RFC-0302</a>. During the asset creation process, described in <a href="RFC-0341_AssetRegistration.html">RFC-0341</a>, the <a href="Glossary.html#asset-issuer">Asset Issuer</a> (AI) MUST select a committee of VNs to manage their asset. This process consists of the following steps:</p>
<ol>
<li>Candidate VNs MUST be nominated to be considered for selection by the AI.</li>
<li>The AI MUST employ a <a href="Glossary.html#committeeselectionstrategy">CommitteeSelectionStrategy</a> to select VNs from the set of nominated candidates.</li>
<li>The AI MUST make an offer of committee membership to the selected VNs.</li>
<li>Selected VNs MAY accept the offer to become part of the committee by posting the required <a href="Glossary.html#assetcollateral">AssetCollateral</a>.</li>
</ol>
<a class="header" href="#nomination" id="nomination"><h3>Nomination</h3></a>
<p>The first step in assembling a committee is to nominate candidate VNs. As described in <a href="RFC-0311_AssetTemplates.html">RFC-0311</a> an asset can be created with two possible <code>committee_modes</code>: <code>CREATOR_NOMINATION</code> or <code>PUBLIC_NOMINATION</code>.</p>
<p>In <code>CREATOR_NOMINATION</code> mode the AI nominates candidate committee members directly. The AI will have a list of permissioned <a href="Glossary.html#trusted-node">Trusted Node</a>s that they want to act as the committee. The AI will contact the candidate VNs directly to inform them of their nomination.</p>
<p>In <code>PUBLIC_NOMINATION</code> mode the AI does not have a list of <a href="Glossary.html#trusted-node">Trusted Node</a>s and wants to source unknown VNs from the network. In this case the AI broadcasts a public call for nomination to the Tari network using the peer-to-peer messaging protocol described in <a href="RFC-0172_PeerToPeerMessagingProtocol.html">RFC-0172</a>. This call for nomination contains all the details of the asset and VNs that want to participate will then nominate themselves by contacting the AI.</p>
<a class="header" href="#selection" id="selection"><h3>Selection</h3></a>
<p>Once the AI has received a list of nominated VNs it must make a selection, assuming enough VNs were nominated to populate the committee. The AI will employ some <a href="Glossary.html#committeeselectionstrategy">CommitteeSelectionStrategy</a> in order to select the committee from the candidate VNs that have been nominated. This strategy might aim for a perfectly random selection or perhaps it will consider some metrics about the candidate VNs such as the length of their VN registrations which might indicate that they are reliable and have not been blacklisted for poor or malicious performance.</p>
<p>A consideration when selecting a committee in <code>PUBLIC_NOMINATION</code> mode will be the size of the pool of nominated VNs. The size of this pool relative to the size of the committee to be selected will be linked to a risk profile. If the pool has very few candidates in it then it will be much easier for an attacker to have nominated their own nodes in order to obtain a majority membership of the committee i.e. if the AI is selecting a committee of 10 members using a uniformly random selection strategy and only 12 public nominations are received an attacker only requires control of 6 VNs to achieve a majority position in the committee. In contrast, if 100 nominations are received and the AI performs a uniformly random selection an attacked would need to control more than 50 of the nominated nodes in order to achieve a majority position in the committee.</p>
<a class="header" href="#offer-acceptance" id="offer-acceptance"><h3>Offer acceptance</h3></a>
<p>Once the selection has been made by the AI the selected VNs will be informed and an offer of membership will be made to them. If the VNs are still inclined to join the committee they will accept the offer by posting the <a href="Glossary.html#assetcollateral">AssetCollateral</a> required by the asset to the <a href="Glossary.html#base-layer">base layer</a> during the initial <a href="Glossary.html#checkpoint">Checkpoint</a> transaction built to commence the operation of the asset.</p>
<a class="header" href="#asset-management" id="asset-management"><h1>Asset Management</h1></a>
<p>This section contains RFCs that describe various aspects of asset management in the Tari network.</p>
<a class="header" href="#rfc-0311assettemplates" id="rfc-0311assettemplates"><h1>RFC-0311/AssetTemplates</h1></a>
<a class="header" href="#digital-asset-templates" id="digital-asset-templates"><h2>Digital Asset templates</h2></a>
<p><img src="https://github.com/tari-project/tari/raw/master/RFC/src/theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a></p>
<a class="header" href="#license-21" id="license-21"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019. The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-21" id="language-21"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-21" id="disclaimer-21"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-21" id="goals-21"><h2>Goals</h2></a>
<p>Describe the Tari Digital Asset templating system for smart contract definition.</p>
<p>The term “smart contracts” in this document is used to refer to a set of rules enforced by computers. These smart
contracts are not Turing complete, such as those executed by the Ethereum VM.</p>
<a class="header" href="#related-rfcs-20" id="related-rfcs-20"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0300_DAN.html">RFC-0300: The Digital Assets Network</a></li>
<li><a href="RFC-0301_NamespaceRegistration.html">RFC-0301: Namespace registration</a></li>
<li><a href="RFC-0340_VNConsensusOverview.html">RFC-0340: Validator Node Consensus</a></li>
<li><a href="RFC-0374_TCAssetManagement.html">RFC-0374: Asset Creation and management</a></li>
</ul>
<a class="header" href="#description-19" id="description-19"><h2>Description</h2></a>
<a class="header" href="#motivation" id="motivation"><h3>Motivation</h3></a>
<p>The reasons for issuing assets on Tari under a templating system, rather than a scripting language (whether Turing
complete or not) are manifold:</p>
<ul>
<li>A scripting language, irrespective of how simple it is, limits the target market for asset issuers to developers, or
people who pay developers.</li>
<li>The market doesn’t want general smart contracts. This is evidenced by the fact that the vast majority of Ethereum
transactions go through ERC-20 or ERC-721 contracts, which are literally contract templates.</li>
<li>The attack surface for smart contracts is reduced considerably; to the node software itself.</li>
<li>Bugs can be fixed for all contracts simultaneously by using a template versioning system. Existing assets can opt-in
to fixes by migrating assets to a new version of the contract.</li>
<li>Contracts will have better QA since more eyes are looking at fewer contract code sets.</li>
<li>Transmission, storage and processing of contracts will be more efficient as one only has to deal with the parameters
and not the logic of the contract. Furthermore, the cost for users is usually lower, since there's no need to add
friction / extra costs to contract execution (e.g. ethereum gas) to work around the halting problem.</li>
</ul>
<a class="header" href="#implementation" id="implementation"><h3>Implementation</h3></a>
<p>Assets are created on the Tari network by issuing a <code>create_asset</code> instruction from a wallet or client and broadcasting
it to the Tari Digital Assets Network (DAN).</p>
<p>The instruction is in JSON format and MUST contain the following fields:</p>
<table><thead><tr><th align="left"> Name                               </th><th align="left"> Type          </th><th align="left"> Description                                                                                                                            </th></tr></thead><tbody>
<tr><td align="left"> <strong>Asset description</strong>              </td><td align="left">               </td><td align="left">                                                                                                                                        </td></tr>
<tr><td align="left"> issuer                             </td><td align="left"> PubKey        </td><td align="left"> The public key of the creator of the asset. See <a href="#issuer">issuer</a>                                                                      </td></tr>
<tr><td align="left"> name                               </td><td align="left"> <code>string[64]</code>  </td><td align="left"> The name or identifier for the asset. See <a href="#name-and-description">Name and Description</a>                                                </td></tr>
<tr><td align="left"> description                        </td><td align="left"> <code>string[216]</code> </td><td align="left"> A short description of the asset - with name, fits in a tweet. See <a href="#name-and-description">Name and Description</a>                       </td></tr>
<tr><td align="left"> raid_id                            </td><td align="left"> <code>string[15]</code>  </td><td align="left"> The <a href="#raid-id">Registered Asset Issuer Domain (RAID_ID)</a> for the asset.                                                                </td></tr>
<tr><td align="left"> fqdn                               </td><td align="left"> <code>string[*]</code>   </td><td align="left"> The FQDN corresponding to the <code>raid_id</code>. Up to 255 characters in length; or &quot;No_FQDN&quot; to use the default.                              </td></tr>
<tr><td align="left"> public_nonce                       </td><td align="left"> PubKey        </td><td align="left"> Public nonce part of the creator signature                                                                                             </td></tr>
<tr><td align="left"> template_id                        </td><td align="left"> <code>u64</code>         </td><td align="left"> The template descriptor. See <a href="#template-id">Template ID</a>                                                                               </td></tr>
<tr><td align="left"> asset_expiry                       </td><td align="left"> <code>u64</code>         </td><td align="left"> A timestamp or block height after which the asset will automatically expire. Zero for arbitrarily long-lived assets                    </td></tr>
<tr><td align="left"> <strong>Validation Committee selection</strong> </td><td align="left">               </td><td align="left">                                                                                                                                        </td></tr>
<tr><td align="left"> committee_mode                     </td><td align="left"> <code>u8</code>          </td><td align="left"> The validation committee nomination mode, either <code>CREATOR_NOMINATION</code> (0) or <code>PUBLIC_NOMINATION</code> (1)                                                 </td></tr>
<tr><td align="left"> committee_parameters               </td><td align="left"> Object        </td><td align="left"> See <a href="#committee-parameters">Committee Parameters</a>.                                                                                     </td></tr>
<tr><td align="left"> asset_creation_fee                 </td><td align="left"> <code>u64</code>         </td><td align="left"> The fee the issuer is paying, in microTari, for the asset creation process                                                             </td></tr>
<tr><td align="left"> commitment                         </td><td align="left"> <code>u256</code>        </td><td align="left"> A time-locked commitment for the asset creation fee                                                                                    </td></tr>
<tr><td align="left"> initial_state_hash                 </td><td align="left"> <code>u256</code>        </td><td align="left"> The hash of the canonical serialisation of the initial template state (of the template-specific data)                                  </td></tr>
<tr><td align="left"> initial_state_length               </td><td align="left"> <code>u64</code>         </td><td align="left"> Size in bytes of initial state                                                                                                         </td></tr>
<tr><td align="left"> <strong>template-specific data</strong>         </td><td align="left"> Object        </td><td align="left"> Template-specific metadata can be defined in this section                                                                              </td></tr>
<tr><td align="left"> <strong>Signatures</strong>                     </td><td align="left">               </td><td align="left">                                                                                                                                        </td></tr>
<tr><td align="left"> metadata_hash                      </td><td align="left"> <code>u256</code>        </td><td align="left"> A hash of the previous three sections' data, in canonical format (<code>m</code>)                                                                 </td></tr>
<tr><td align="left"> creator_sig                        </td><td align="left"> <code>u256</code>        </td><td align="left"> A digital signature of the message <code>H(R ‖ P ‖ RAID_ID ‖ m)</code> using the asset creator’s private key corresponding to the <code>issuer</code> PKH </td></tr>
<tr><td align="left"> commitment_sig                     </td><td align="left"> <code>u256</code>        </td><td align="left"> A signature proving the issuer is able to spend the commitment to the asset fee                                                        </td></tr>
</tbody></table>
<a class="header" href="#committee-parameters" id="committee-parameters"><h4>Committee parameters</h4></a>
<p>If <code>committee_mode</code> is <code>CREATOR_NOMINATION</code> the <code>committee_parameters</code> object is</p>
<table><thead><tr><th> Name             </th><th> Type         </th><th> Description </th></tr></thead><tbody>
<tr><td align="left"> trusted_node_set </td><td align="left"> Array of PKH </td><td align="left"> See below   </td></tr>
</tbody></table>
<p>Only the nodes in the trusted node set will be allowed to execute instructions for this asset.</p>
<p>If <code>committee_mode</code> is <code>PUBLIC_NOMINATION</code> the <code>committee_parameters</code> object is</p>
<table><thead><tr><th> Name                    </th><th> Type  </th><th> Description                                                                                                           </th></tr></thead><tbody>
<tr><td align="left"> node_threshold          </td><td align="left"> <code>u32</code> </td><td align="left"> The required number of validator nodes that must register to execute instructions for this asset                      </td></tr>
<tr><td align="left"> minimum_collateral      </td><td align="left"> <code>u64</code> </td><td align="left"> The minimum amount of Tari a validator node must put up in collateral in order to execute instructions for this asset </td></tr>
<tr><td align="left"> node_selection_strategy </td><td align="left"> <code>u32</code> </td><td align="left"> The selection strategy to employ allowing nodes to register to manage this asset                                      </td></tr>
</tbody></table>
<a class="header" href="#issuer" id="issuer"><h4>Issuer</h4></a>
<p>Anyone can create new assets on the Tari network from their Tari Collections client. The client will provide the PKH and
sign the instruction. The client needn’t use the same private key each time.</p>
<a class="header" href="#name-and-description" id="name-and-description"><h4>Name and Description</h4></a>
<p>These fields are purely for informational purposes and do not need to be unique, and do not act as an asset ID.</p>
<a class="header" href="#raid-id" id="raid-id"><h4>RAID ID</h4></a>
<p>The RAID_ID is a 15 character string that associates the asset issuer with a registered internet domain name on DNS.</p>
<p>If it is likely that a digital asset issuer will be issuing many assets on the Tari Network (hundreds, or thousands),
the issuer should strongly consider using a registered domain (e.g. <code>acme.com</code>). This is
done via OpenAlias on the domain owner's DNS record, as described in <a href="RFC-0301_NamespaceRegistration.html">RFC-0301</a>. A
RAID prevents spoofing of assets from copycats or other malicious actors. It also makes asset discovery
simpler.</p>
<p>Assets from issuers that do not have a RAID are all grouped under the default RAID.</p>
<p>RAID owners must provide a valid signature proving that they own the given domain when creating assets.</p>
<a class="header" href="#fqdn" id="fqdn"><h4>FQDN</h4></a>
<p>The fully qualified domain name that corresponds to the <code>raid_id</code> or the string <code>&quot;NO FQDN&quot;</code> to use the default RAID ID.
Validator nodes will calculate and check that the RAID ID is valid when
<a href="signature-validation">validating the instruction signature</a>.</p>
<a class="header" href="#public-nonce" id="public-nonce"><h4>Public nonce</h4></a>
<p>A single-use public nonce to be used in the asset signature.</p>
<a class="header" href="#asset-identification" id="asset-identification"><h4>Asset identification</h4></a>
<p>Assets are identified by a 64-character string that uniquely identifies an asset on the network:</p>
<table><thead><tr><th> Bytes </th><th> Description                                     </th></tr></thead><tbody>
<tr><td align="left"> 8     </td><td align="left"> Template type (hex)                             </td></tr>
<tr><td align="left"> 4     </td><td align="left"> Template version (hex)                          </td></tr>
<tr><td align="left"> 4     </td><td align="left"> Feature flags (hex)                             </td></tr>
<tr><td align="left"> 15    </td><td align="left"> RAID identifier (Base58)                        </td></tr>
<tr><td align="left"> 1     </td><td align="left"> A period character, <code>.</code>                         </td></tr>
<tr><td align="left"> 32    </td><td align="left"> Hex representation of the <code>metadata_hash</code> field </td></tr>
</tbody></table>
<p>This allows assets to be deterministically identified from their initial state. Two different creation instructions
leading to the same hash refer to the same single asset, by definition. Validator Nodes maintain an index of assets and
their committees, and so can determine whether a given asset already exists; and MUST reject any <code>create_asset</code>
instruction for an existing asset.</p>
<a class="header" href="#template-id" id="template-id"><h4>Template ID</h4></a>
<p>Tari uses templates to define the behaviour for its smart contracts. The template id refers to the type of digital asset
begin created.</p>
<p><strong>Note:</strong> Integer values are given in <em>little-endian</em> format; i.e. the least significant bit is <em>first</em>.</p>
<p>The template number is a 64-bit unsigned integer and has the following format, with 0 representing
the least significant bit.</p>
<table><thead><tr><th> Bit range </th><th> Description                       </th></tr></thead><tbody>
<tr><td align="left"> 0 - 31    </td><td align="left"> Template type (0 - 4,294,967,295) </td></tr>
<tr><td align="left"> 32 - 47   </td><td align="left"> Template version (0 - 65,535)     </td></tr>
<tr><td align="left"> 48        </td><td align="left"> Beta Mode flag                    </td></tr>
<tr><td align="left"> 49        </td><td align="left"> Confidentiality flag              </td></tr>
<tr><td align="left"> 50 - 63   </td><td align="left"> Reserved  (Must be 0)             </td></tr>
</tbody></table>
<p>The lowest 32 bits refer to the canonical smart contract type; the qualitative types of contracts the network supports.
Many assets can be issued from a single template.</p>
<p>Template types below 65,536 (2<sup>16</sup>) are public, community-developed templates.
All validator nodes MUST implement and be able to interpret instructions related to these templates.</p>
<p>Template types 65,536 and above are opt-in or proprietary templates. There is no guarantee that any given validator node
will be able to manage assets on these templates. Part of the committee selection and confirmation process for new
assets will be an attestation by validator nodes that they are willing and able to manage the asset under the designated
template rules.</p>
<p>A global registry of opt-in template types will be necessary to prevent collisions (public templates existence will be
evident from the Validator Node source code), possibly implemented as a special transaction type on the base layer; the
base layer being perfectly suited for hosting such a registry. The details of this will be covered in a separate
proposal.</p>
<p>Examples of template types may be</p>
<table><thead><tr><th> Template type </th><th> Asset                    </th></tr></thead><tbody>
<tr><td align="left"> 1             </td><td align="left"> Simple single-use tokens </td></tr>
<tr><td align="left"> 2             </td><td align="left"> Simple coupons           </td></tr>
<tr><td align="left"> 20            </td><td align="left"> ERC-20-compatible        </td></tr>
<tr><td align="left"> ...           </td><td align="left"> ...                      </td></tr>
<tr><td align="left"> 120           </td><td align="left"> Collectible Cards        </td></tr>
<tr><td align="left"> 144           </td><td align="left"> In-game items            </td></tr>
<tr><td align="left"> 721           </td><td align="left"> ERC-721-compatible       </td></tr>
<tr><td align="left"> ...           </td><td align="left"> ...                      </td></tr>
<tr><td align="left"> 65,537        </td><td align="left"> Acme In game items       </td></tr>
<tr><td align="left"> 723,342       </td><td align="left"> CryptoKitties v8         </td></tr>
</tbody></table>
<p>The template id may also set one or more feature flags to indicate that the contract is</p>
<ul>
<li>experimental, or in testing phase, (bit 48).</li>
<li>confidential. The definition of confidential assets and their implementation is not finalised at the time of writing.</li>
</ul>
<p>Wallets / client apps SHOULD have settings to allow or otherwise completely ignore asset types on the network that have
certain feature flags enabled. For instance, most consumer wallets should never interact with templates that have the
“Beta mode” bit set. Only developer’s wallets should ever even see that such assets exist.</p>
<a class="header" href="#asset-expiry" id="asset-expiry"><h4>Asset expiry</h4></a>
<p>Asset issuers can set a future expiry date or block height after which the asset will expire and nodes will be free to
expunge any/all state relating to the asset from memory after a fixed grace period. The grace period is to allow
interested parties (e.g. the issuer) to take a snapshot of the final state of the contract if they wish (e.g. proving
that you had a ticket for that epic World Cup final game, even after the asset no longer exists on the DAN).</p>
<p>Nodes will publish a final checkpoint on the base layer soon after expiry and before purging an asset.</p>
<p>The expiry_date is a Unix epoch, representing the number of seconds since 1 January 1970 00:00:00 UTC if the value is
greater than 1,500,000,000; or a block height if it is less than that value (with 1 min blocks this scheme is valid
until the year 4870).</p>
<p>Expiry times should not be considered exact, since nodes don’t share the same clocks and block heights as time proxies
become more inaccurate the further out you go (since height in the future is dependent on hash rate).</p>
<a class="header" href="#signature-validation" id="signature-validation"><h3>Signature validation</h3></a>
<p>Validator nodes will verify the <code>creator_sig</code> for every <code>create_asset</code> instruction before propagating the instruction to
the network. This involves the following process:</p>
<ol>
<li>
<p>The VN MUST calculate the metadata hash by hashing the canonical representation of all the data in the first three
sections of the <code>create_asset</code> instruction.</p>
</li>
<li>
<p>The VN MUST compare this calculated value to the value given in the <code>metadata_hash</code> field. If they do not match, drop
the instruction and STOP.</p>
</li>
<li>
<p>The VN MUST calculate the RAID ID from the <code>fqdn</code> and <code>issuer</code> fields as specified in <a href="RFC-0301_NamespaceRegistration.html">RFC-0301</a>.</p>
</li>
<li>
<p>The VN MUST compare the calculated RAID ID with the value given in the <code>raid_id</code> field. If they do not match, drop
the instruction and STOP.</p>
</li>
<li>
<p>If the <code>fqdn</code> is `&quot;No FQDN&quot;, then skip to step 9.</p>
</li>
<li>
<p>The VN MUST Look up the OpenAlias TXT record at the domain given in <code>fqdn</code>. If the record is does not exist, then
drop the instruction and STOP.</p>
</li>
<li>
<p>The VN MUST check that each of the public key and RAID ID in the TXT record match the values in the <code>create_asset</code>
instruction. If any values do not match, then drop the instruction and STOP.</p>
</li>
<li>
<p>The VN MUST validate the registration signature in the TXT record, using the TXT record's nonce, the issuer's public
key and the RAID ID. If the signature does not verify, drop the instruction and STOP.</p>
</li>
<li>
<p>The VN MUST validate the signature in the <code>creator_sig</code> field against the challenge built up from the issuer's public
key, the nonce given in <code>public_nonce</code> field, the <code>raid_id</code> field and the <code>metadata_hash</code> field.</p>
</li>
</ol>
<p>If step 9 passes, then the VN has proven that the <code>create_asset</code> contains a valid RAID ID, and that if a non-default
FQDN was provided, that the owner of that domain provided the <code>create_asset</code> instruction. In this case, the VN SHOULD
propagate the instruction to the network.</p>
<a class="header" href="#rfc-0313assetreadapi" id="rfc-0313assetreadapi"><h1>RFC-0313/AssetReadAPI</h1></a>
<p>RFC placeholder.</p>
<p>This document will describe the read-only API for gaining basic information about public digital assets; and how
information about hidden/private assets is provided.</p>
<a class="header" href="#rfc-0315assettransfer" id="rfc-0315assettransfer"><h1>RFC-0315/AssetTransfer</h1></a>
<p>RFC placeholder.</p>
<p>This document will describe the process for third-party asset transfer; i.e. Collections &lt;-&gt; Collections transfer</p>
<a class="header" href="#rfc-0316assetretirement" id="rfc-0316assetretirement"><h1>RFC-0316/AssetRetirement</h1></a>
<p>RFC placeholder.</p>
<p>This document will describe the process for asset retirement / expiry, and how attestations of final state can be made
long after the Validator Node committee has purged all record of the asset.</p>
<a class="header" href="#rfc-0340vnconsensusoverview" id="rfc-0340vnconsensusoverview"><h1>RFC-0340/VNConsensusOverview</h1></a>
<p>RFC placeholder.</p>
<p>This document will describe the high-level overview of how VN committees reach consensus about the current state of an
asset after each instruction is executed.</p>
<a class="header" href="#rfc-0342vninstructions" id="rfc-0342vninstructions"><h1>RFC-0342/VNInstructions</h1></a>
<p>RFC placeholder.</p>
<p>This document will describe the types of asset instructions that may be issued by Tari Collections.</p>
<a class="header" href="#rfc-0343vnconsensusalgorithm" id="rfc-0343vnconsensusalgorithm"><h1>RFC-0343/VNConsensusAlgorithm</h1></a>
<p>RFC placeholder.</p>
<p>This document will describe the details of the DAN VN consensus algorithm.</p>
<a class="header" href="#rfc-0350disputeresolution" id="rfc-0350disputeresolution"><h1>RFC-0350/DisputeResolution</h1></a>
<p>RFC placeholder.</p>
<p>This document will describe the dispute resolution process, which can occur if a party feels that a VN committee has
broken network rules while executing an instructions.</p>
<a class="header" href="#rfc-0500paymentchannels" id="rfc-0500paymentchannels"><h1>RFC-0500/PaymentChannels</h1></a>
<p>RFC placeholder.</p>
<p>This document will describe how Tari implements payment channels. The base layer is slow. The DAN is fast. However,
every non-read DAN instruction has a fee (i.e. base layer transaction) associated with it. To bridge the speed gap
between the two layers, a payment channel solution is required. This document provides the high-level overview of how
this is done.</p>
<a class="header" href="#rfc-1000tariusecases-1" id="rfc-1000tariusecases-1"><h1>RFC-1000/TariUseCases</h1></a>
<a class="header" href="#a-digital-asset-framework-1" id="a-digital-asset-framework-1"><h2>A Digital Asset Framework</h2></a>
<p><img src="./theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/lelandlee">Leland Lee</a></p>
<a class="header" href="#license-22" id="license-22"><h1>License</h1></a>
<p><a href="https://opensource.org/licenses/BSD-3-Clause"> The 3-Clause BSD License</a>.</p>
<p>Copyright 2019 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<a class="header" href="#language-22" id="language-22"><h2>Language</h2></a>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all capitals, as
shown here.</p>
<a class="header" href="#disclaimer-22" id="disclaimer-22"><h2>Disclaimer</h2></a>
<p>The purpose of this document and its content is for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community regarding the
technological merits of the potential system outlined herein.</p>
<a class="header" href="#goals-22" id="goals-22"><h2>Goals</h2></a>
<p>There will be many types of digital assets that can be issued on Tari. This document is intended to help potential asset
issuers identify use cases for Tari that lead to the design of new types of digital assets that may or may not exist in
their ecosystems today.</p>
<a class="header" href="#related-rfcs-21" id="related-rfcs-21"><h2>Related RFCs</h2></a>
<ul>
<li><a href="RFC-0001_overview.html">RFC-0001: An overview of the Tari network</a></li>
<li><a href="RFC-0300_DAN.html">RFC-0300: The Digital Assets Network</a></li>
</ul>
<a class="header" href="#description-20" id="description-20"><h2>Description</h2></a>
<p>Tari <a href="Glossary.html#digital-asset">digital asset</a>s may exist on the Tari <a href="Glossary.html#digital-asset-network">Digital Assets Network</a> (DAN), are perceived to have value and can be
owned, with the associated digital data being classified as intangible, personal property.</p>
<a class="header" href="#types-1" id="types-1"><h3>Types</h3></a>
<p>Digital assets may have the following high level classification scheme:</p>
<ul>
<li>Symbolic
<ul>
<li>Insignia</li>
<li>Mascots</li>
<li>Event-driven or historical (eg. a rivalry or a highly temporal event)</li>
</ul>
</li>
<li>Artifacts or Objects
<ul>
<li>Legendary</li>
<li>Rare</li>
<li>High demand</li>
<li>Artistic</li>
<li>Historical</li>
</ul>
</li>
<li>Utility
<ul>
<li>Tickets</li>
<li>In-game items</li>
<li>Points</li>
<li>Currency</li>
<li>Full or fractional representation</li>
<li>Bearer instruments / access token</li>
<li>Chat stickers</li>
</ul>
</li>
<li>Persona
<ul>
<li>Personality trait(s)</li>
<li>Emotion(s)</li>
<li>Statistics</li>
<li>Superpower(s)</li>
<li>Storyline(s)</li>
<li>Relationship(s)</li>
<li>Avatar</li>
</ul>
</li>
</ul>
<a class="header" href="#behaviors-1" id="behaviors-1"><h3>Behaviors</h3></a>
<p>Digital asset tokens may influence the following behavioral types:</p>
<ul>
<li>Advance purchase</li>
<li>Experience enhancement</li>
<li>Sharing</li>
<li>Loyalty</li>
<li>Reward for performance</li>
<li>Tipping</li>
<li>Donating to a charity</li>
<li>Collecting</li>
<li>Trading</li>
<li>Building / combining</li>
</ul>
<a class="header" href="#attributes-1" id="attributes-1"><h3>Attributes</h3></a>
<p>Digital assets have many different properties, which may be one or more of the following:</p>
<ul>
<li>Digital assets can be interactive:
<ul>
<li>Easter eggs
<ul>
<li>Media</li>
<li>Dynamic (eg. Imagine if assets were similar to sounds, visualisations or other kinds of &quot;demos&quot; or &quot;gifs&quot;)</li>
</ul>
</li>
<li>Game mechanics</li>
<li>Evolutionary</li>
</ul>
</li>
<li>Digital assets can be combined to create super assets.</li>
<li>Digital assets can be attribute(s) of another digital asset (e.g. wheels of a vehicle or a VIP ticket has two drink cards).</li>
<li>Digital assets can have contingencies (e.g. ownership of a digital asset is contingent on ownership of a different digital asset, using this digital asset is contingent on holding it for a particular duration, etc)</li>
<li>Digital assets can have utility (e.g. be useful).</li>
<li>Digital assets can be used across platforms (e.g. a digital asset for a game could be used as avatars in a social network).</li>
<li>Digital assets can have history.</li>
<li>Digital assets can have user-generated tags and/or metadata.</li>
</ul>
<a class="header" href="#interactions-1" id="interactions-1"><h3>Interactions</h3></a>
<p>Digital asset owners may have the following interactions with the DAN and/or other people:</p>
<ul>
<li>Digital asset owners can attest that they have ownership over there assets at time <code>t</code>.</li>
<li>Digital assets owners may attest ownership to an individual, to a group of friends or to the entire world.</li>
</ul>
<a class="header" href="#rules-1" id="rules-1"><h3>Rules</h3></a>
<p>Rules are the governance of how digital assets may be used or transferred, as defined by the asset issuer:</p>
<ul>
<li>Royalty Fees -  Digital asset issuers can set a royalty that charges a fee every time the digital asset is transferred between parties. The fee as defined by the issuer can be fixed or dynamic or follow a complex formula and value is granted to the issuer(s) and/or other entities.</li>
<li>Contingency - Digital asset ownership/interaction may be contingent/dependent on another asset.</li>
<li>Timing Controls - Digital assets can only be transferred or used at particular times.</li>
<li>Sharing - Digital assets can be shared to others or even co-owned.</li>
<li>Privacy - Ownership of a digital asset can be changed from private to public.</li>
<li>Upgradability/Versioning - Digital assets can be upgraded and/or versioned.</li>
<li>Redeemability - Digital assets can be used once or multiple times.</li>
</ul>
<a class="header" href="#examples-1" id="examples-1"><h3>Examples</h3></a>
<p>Some examples of how different types of digital assets with different attributes, rules and interactions may be
manifested are shown below.</p>
<a class="header" href="#crystal-skull-of-akador-1" id="crystal-skull-of-akador-1"><h4>Crystal Skull of Akador</h4></a>
<ul>
<li>Is rare
<ul>
<li>Is 1 of 5</li>
</ul>
</li>
<li>Is legendary
<ul>
<li>https://indianajones.fandom.com/wiki/Crystal_Skull_of_Akator</li>
<li>Press reports that this artifact could be worth $X</li>
</ul>
</li>
<li>Drives collectibility</li>
<li>Drives advance purchase
<ul>
<li>If you are one of the first 100,000 people to buy tickets to Indiana Jones World you have a chance of winning this 1 of 5 artifact.</li>
</ul>
</li>
<li>Has superpowers and utility
<ul>
<li>If you have this item while visiting Indiana Jones World, you get to skip the line three times.</li>
</ul>
</li>
<li>Is a contingency for another asset
<ul>
<li>If you collect this item, two Sankara stones, and the Cross of Coronado, you can buy the ark of the covenant:
<ul>
<li>Ark of the covenant is rare. It is 1 of 1.</li>
<li>Ark of the covenant is legendary.</li>
<li>Ark of the covenant gives you lifetime access to Indiana Jones World.</li>
<li>Ark of the covenant has rules; 20% of the resale price goes to Indiana Jones World.</li>
</ul>
</li>
</ul>
</li>
</ul>
<a class="header" href="#ab-de-villiers-bat-1" id="ab-de-villiers-bat-1"><h4>AB de Villiers' bat</h4></a>
<ul>
<li>Isn’t Rare
<ul>
<li>Is 1 of 100,000</li>
</ul>
</li>
<li>Is Legendary
<ul>
<li>https://www.youtube.com/watch?v=HK6B2da3DPA</li>
</ul>
</li>
<li>Drives collectibility
<ul>
<li>Is part of a series of bats from famous batsmen.</li>
</ul>
</li>
<li>Can be combined with other assets
<ul>
<li>Be one of the first 10 people to combine six bats to turn this asset into a One Day International (ODI) century bat:
<ul>
<li>ODI century bats are rare, they are 1 of 10.</li>
<li>ODI century bats are legendary.</li>
</ul>
</li>
</ul>
</li>
<li>Has no superpowers</li>
<li>Has no utility</li>
<li>Has no rules</li>
</ul>
<a class="header" href="#ovo-owl-x-supreme-1" id="ovo-owl-x-supreme-1"><h4>OVO Owl x Supreme</h4></a>
<ul>
<li>Is Rare
<ul>
<li>Is 1 of 200</li>
</ul>
</li>
<li>Is Legendary
<ul>
<li>https://www.supremenewyork.com</li>
<li>https://us.octobersveryown.com</li>
</ul>
</li>
<li>Has a game mechanic
<ul>
<li>Every time it’s transferred, it may become a golden ticket that grants you access to any Drake show.</li>
<li>If its become a golden ticket and is transferred, it loses its golden ticket superpower.</li>
</ul>
</li>
<li>Has utility
<ul>
<li>Unlocks exclusive media content feat. Drake hosted by OVO SOUND.</li>
<li>May become a golden ticket that grants you access to any Drake show.</li>
</ul>
</li>
<li>Has rules
<ul>
<li>Every time its transferred Supreme and OVO SOUND receive 25% of the transaction value.</li>
</ul>
</li>
</ul>
<a class="header" href="#tari-network-terminology" id="tari-network-terminology"><h1>Tari Network Terminology</h1></a>
<p>Below are a list of terms and their definitions that are used throughout the Tari code and documentation. Let's use this
glossary to disambiguate ideas, and work towards a
<a href="https://blog.carbonfive.com/2016/10/04/ubiquitous-language-the-joy-of-naming/">ubiquitous language</a> for this project.</p>
<a class="header" href="#archive-node" id="archive-node"><h2>Archive node</h2></a>
<p>[archivenode]: #archive-node    &quot;a full history node&quot;</p>
<p>This is a full history <a href="#base-node" title="A full Tari node running on the base layer, validating and propagating Tari coin transactions and blocks">base node</a>. It will keep a complete history of every transaction ever received and it will not implement pruning.</p>
<a class="header" href="#assetcollateral" id="assetcollateral"><h2>AssetCollateral</h2></a>
<p>The amount of tari coin that a <a href="#validator-node" title="A second-layer node that manages and validates digital asset state transitions">Validator Node</a> must put up on the <a href="#base-layer" title="The Tari layer handling payments and secured by proof of work">base layer</a> in order to become part of an asset <a href="#committee" title="A group of validator nodes that are responsible for managing a specific Digital Asset">committee</a>.</p>
<a class="header" href="#asset-issuer" id="asset-issuer"><h2>Asset Issuer</h2></a>
<p>An entity that creates digital assets on the Tari DAN. The Asset Issuer will specify the parameters of the contract template
that defines the rules that govern the asset and the number and nature of its constituent tokens on issuance. The Asset Issuer
will, generally, be the initial owner of the tokens.</p>
<a class="header" href="#bad-actor" id="bad-actor"><h2>Bad Actor</h2></a>
<p>A participant that acts maliciously or negligently to the detriment of the network or another participant.</p>
<a class="header" href="#base-layer" id="base-layer"><h2>Base layer</h2></a>
<p>The Tari Base layer is a merge-mined <a href="#blockchain" title="The linked sequence of Tari blocks on the Tari base layer">blockchain</a> secured by proof-of-work. The base layer is primarily responsible for
the emission of new Tari, for securing and managing <a href="#tari-coin" title="The base layer token">Tari coin</a> transfers.</p>
<a class="header" href="#base-node" id="base-node"><h2>Base Node</h2></a>
<p>A full Tari node running on the base layer. It's primary role is validating and propagating <a href="#tari-coin" title="The base layer token">Tari coin</a> transactions
and blocks to the rest of the network.</p>
<a class="header" href="#block" id="block"><h2>Block</h2></a>
<p>A collection transactions and associated metadata recorded as a single entity in the Tari blockchain. The ordering of
Tari transactions is set purely by the block height of the block they are recorded in.</p>
<a class="header" href="#block-reward" id="block-reward"><h2>Block reward</h2></a>
<p>The amount of Tari created by the coinbase transaction in every block. The block reward is set by the
<a href="#emission-schedule">emission schedule</a>.</p>
<a class="header" href="#blockchain" id="blockchain"><h2>Blockchain</h2></a>
<p>A sequence of tari <a href="#block" title="A collection transactions and associated metadata recorded as a single entity in the Tari blockchain">block</a>s. Each block contains a hash of the previous valid block. Thus the blocks form a chain
with the property that changing anything in a block other than the head block requires rewriting the entire
blockchain from that point on.</p>
<a class="header" href="#blockchain-state" id="blockchain-state"><h2>Blockchain state</h2></a>
<p>[blockchainstate]: #blockchain-state    &quot;This is a snapshot of how the blockchain looks&quot;</p>
<p>The complete state of the blockchain at a specific block height. This means a pruned <a href="#unspent-transaction-outputs">utxo</a> set, a complete set of kernels and headers up to that block height from the genesis block.</p>
<a class="header" href="#broadcaststrategy" id="broadcaststrategy"><h2>BroadcastStrategy</h2></a>
<p>A strategy for propagating messages amongst nodes in a peer-to-peer network. Example implementations of
<code>BroadcastStrategy</code> include the Gossip protocol, Dandelion and flood fill.</p>
<a class="header" href="#checkpoint" id="checkpoint"><h2>Checkpoint</h2></a>
<p>A hash of the state of a Digital Asset that is recorded on the base layer.</p>
<a class="header" href="#coinbase-transaction" id="coinbase-transaction"><h2>Coinbase transaction</h2></a>
<p>The first transaction in every Tari block yields a <a href="#block-reward" title="The amount of Tari created in every block">Block Reward</a> according to the Tari <a href="#emission-schedule">emission Schedule</a> and is
awarded to the miner that performed the Proof of Work for the block.</p>
<a class="header" href="#committee" id="committee"><h2>Committee</h2></a>
<p>A group of <a href="#validator-node" title="A second-layer node that manages and validates digital asset state transitions">Validator Node</a>s that are responsible for managing the state of a specific <a href="#digital-asset" title="Sets of Native digital tokens, both fungible and non-fungible that are created by 
asset issuers on the Tari 2nd layer">Digital Asset</a>. A committee is selected
during asset issuance and can be updated at <a href="#checkpoint" title="A summary of the state of a Digital Asset that is recorded on the base layer">Checkpoint</a>s.</p>
<a class="header" href="#committeeselectionstrategy" id="committeeselectionstrategy"><h2>CommitteeSelectionStrategy</h2></a>
<p>A strategy for an Asset Issuer to select candidates for the committee from the available registered Validator Nodes who responded to the nomination call for that asset.</p>
<a class="header" href="#consensusstrategy" id="consensusstrategy"><h2>ConsensusStrategy</h2></a>
<p>The approach that will be taken for a committee to reach consensus on the validity of instructions that are performed on a
given Digital Asset.</p>
<a class="header" href="#commitment" id="commitment"><h2>Commitment</h2></a>
<p>A commitment is a cryptographic primitive that allows one to commit to a chosen value while keeping it hidden from
others, with the ability to reveal the committed value later. Commitments are designed so that one cannot change the
value or statement after they have committed to it.</p>
<a class="header" href="#communication-node" id="communication-node"><h2>Communication Node</h2></a>
<p>A Communication Node is either a Validator Node or Base Node that is part of the Tari communication network. It maintains the network and is responsible for forwarding and propagating joining requests, discovery requests and data messages on the communication network.</p>
<a class="header" href="#communication-client" id="communication-client"><h2>Communication Client</h2></a>
<p>A Communication Client is a Wallet or Asset Manager that makes use of the Tari communication network to send joining and discovery requests. A Communication Client does not maintain the communication network and is not responsible for forwarding or propagating any requests or data messages.</p>
<a class="header" href="#creator-nomination-mode" id="creator-nomination-mode"><h2>Creator Nomination Mode</h2></a>
<p>An asset runs in creator nomination mode when <em>every</em> validator node in a validator committee is a <a href="#trusted-node" title="A permissioned Validator Node nominated by an Asset Issuer">Trusted Node</a> that was directly nominated by the <a href="#asset-issuer" title="An entity that creates digital assets on the Tari DAN">Asset Issuer</a>.</p>
<a class="header" href="#current-head" id="current-head"><h2>Current head</h2></a>
<p>[currenthead]: #current-head    &quot;The last valid block of the longest chain&quot;</p>
<p>The last <a href="#block" title="A collection transactions and associated metadata recorded as a single entity in the Tari blockchain">block</a> of the base layer that represents the latest valid block. This <a href="#block" title="A collection transactions and associated metadata recorded as a single entity in the Tari blockchain">block</a> must be from the longest proof-of-work chain to be the current head.</p>
<a class="header" href="#digital-asset" id="digital-asset"><h2>Digital asset</h2></a>
<p>Digital assets (DAs) are the sets or collections of native digital tokens (both fungible and non-fungible) that are
created by <a href="#asset-issuer" title="An entity that creates digital assets on the Tari DAN">asset issuer</a>s on the Tari 2nd layer. For example, a promoter might create a DA for a music concert event. The
event is the digital asset, and the tickets for the event are digital asset <a href="#digital-asset-tokens" title="or just, &quot;tokens&quot;. The tokens associated with a given digital asset. Tokens are created
 by asset issuers">tokens</a>.</p>
<a class="header" href="#digital-asset-network" id="digital-asset-network"><h2>Digital Asset Network</h2></a>
<p>The Tari second layer. All digital asset interactions are managed on the Tari Digital Assets Network (DAN). These
interactions (defined in <a href="#instructions" title="Second-layer network commands for managing digital asset state">instruction</a>s) are processed and validated by <a href="#validator-node" title="A second-layer node that manages and validates digital asset state transitions">Validator Node</a>s.</p>
<a class="header" href="#digitalassettemplate" id="digitalassettemplate"><h2>DigitalAssetTemplate</h2></a>
<p>A DigitalAssetTemplate is one of a set of contract types supported by the DAN. These contracts are non-turing complete and consist of
rigid rule-sets with parameters that can be set by Asset Issuers.</p>
<a class="header" href="#digital-asset-tokens" id="digital-asset-tokens"><h2>Digital asset tokens</h2></a>
<p>Digital asset tokens (or often, just &quot;tokens&quot;) are the finite set of digital entities associated with a given digital
asset. Depending on the DA created, tokens can represent tickets, in-game items, collectibles or loyalty points. They
are bound to the <a href="#digital-asset" title="Sets of Native digital tokens, both fungible and non-fungible that are created by 
asset issuers on the Tari 2nd layer">digital asset</a> that created them.</p>
<a class="header" href="#hashed-time-locked-contract-1" id="hashed-time-locked-contract-1"><h2>Hashed Time Locked Contract</h2></a>
<p>A time locked contract that only pays out after a certain criteria has been met or refunds the originator if a certain period has expired.</p>
<a class="header" href="#emission-schedule" id="emission-schedule"><h2>Emission schedule</h2></a>
<p>An explicit formula as a function of the block height, <em>h</em>, that determines the block reward for the
<em>h</em><sup>th</sup> block.</p>
<a class="header" href="#instructions" id="instructions"><h2>Instructions</h2></a>
<p>Instructions are the <a href="#digital-asset-network" title="The Tari second layer. All digital asset interactions are managed here.">digital asset network</a> equivalent of <a href="#transaction" title="Base layer tari coin transfers.">transaction</a>s. Instructions are issued by asset issuers and
client applications and are relayed by the DAN to the <a href="#validator-node" title="A second-layer node that manages and validates digital asset state transitions">validator node</a>s that are managing the associated
<a href="#digital-asset" title="Sets of Native digital tokens, both fungible and non-fungible that are created by 
asset issuers on the Tari 2nd layer">digital asset</a>.</p>
<a class="header" href="#mempool-2" id="mempool-2"><h2>Mempool</h2></a>
<p>The mempool consists of the transaction pool, pending pool, orphan pool and reorg pool, and is responsible for managing unconfirmed transactions that have not yet been included in the
longest proof-of-work chain. Miners usually draw verified transactions from the mempool to build up transaction <a href="#block" title="A collection transactions and associated metadata recorded as a single entity in the Tari blockchain">block</a>s.</p>
<a class="header" href="#mimblewimble" id="mimblewimble"><h2>Mimblewimble</h2></a>
<p>Mimblewimble is a privacy-centric cryptocurrency protocol. It was
<a href="https://download.wpsoftware.net/bitcoin/wizardry/mimblewimble.txt">dropped</a> in the Bitcoin Developers chatroom by an
anonymous author and has since been refined by several authors, including Andrew Poelstra.</p>
<a class="header" href="#mining-server" id="mining-server"><h2>Mining Server</h2></a>
<p>A Mining Server is responsible for constructing new blocks by bundling transactions from the <a href="#mempool" title="A memory pool for unconfirmed transactions on the base layer">mempool</a> of a connected <a href="#base-node" title="A full Tari node running on the base layer, validating and propagating Tari coin transactions and blocks">Base Node</a>. It also distributes Proof-of-Work tasks to Mining Workers and verifies PoW solutions.</p>
<a class="header" href="#mining-worker" id="mining-worker"><h2>Mining Worker</h2></a>
<p>A Mining Worker is responsible for performing Proof-of-Work tasks received from its parent <a href="#mining-server">Mining Server</a>.</p>
<a class="header" href="#multisig" id="multisig"><h2>Multisig</h2></a>
<p>Multi-signatures (Multisigs) are also known as N-of-M signatures, this means that a minimum of N number of the M peers need to agree before a transaction can be spent. N and M can be equal; which is a special case and is often referred to as an N-of-N Multisig.</p>
<p><a href="https://tlu.tarilabs.com/cryptography/musig-schnorr-sig-scheme/The_MuSig_Schnorr_Signature_Scheme.html">TLU musig</a></p>
<a class="header" href="#node-id-1" id="node-id-1"><h2>Node ID</h2></a>
<p>A node ID is a unique identifier that specifies the location of a <a href="#communication-node" title="A communication node that is responsible for maintaining the Tari communication network">communication node</a> or <a href="#communication-client" title="A communication client that makes use of the Tari communication network, but does not maintain it">communication client</a> in the
Tari communication network. The node ID can either be obtained from registration on the <a href="#base-layer" title="The Tari layer handling payments and secured by proof of work">Base Layer</a> or can be derived
from the public identification key of a <a href="#communication-node" title="A communication node that is responsible for maintaining the Tari communication network">communication node</a> or <a href="#communication-client" title="A communication client that makes use of the Tari communication network, but does not maintain it">communication client</a>.</p>
<a class="header" href="#orphan-pool-1" id="orphan-pool-1"><h2>Orphan Pool</h2></a>
<p>The orphan pool is part of the <a href="#mempool" title="A memory pool for unconfirmed transactions on the base layer">mempool</a> and manages all <a href="#transaction" title="Base layer tari coin transfers.">transaction</a>s that have been verified but attempt to spend <a href="#unspent-transaction-outputs">UTXO</a>s that do not exist or haven't been created yet.</p>
<a class="header" href="#pending-pool-1" id="pending-pool-1"><h2>Pending Pool</h2></a>
<p>The pending pool is part of the <a href="#mempool" title="A memory pool for unconfirmed transactions on the base layer">mempool</a> and manages all <a href="#transaction" title="Base layer tari coin transfers.">transaction</a>s that have a time-lock restriction on when it can be processed or attempts to spend <a href="#unspent-transaction-outputs">UTXO</a>s with time-locks.</p>
<a class="header" href="#pruning-horizon" id="pruning-horizon"><h2>Pruning horizon</h2></a>
<p>[pruninghorizon]: #pruning-horizon  &quot;Block height at which pruning will commence&quot;</p>
<p>This is a local setting for each node to help reduce syncing time and bandwidth. This is the number of blocks from the chain tip beyond which a chain will be pruned.</p>
<a class="header" href="#public-nomination-mode" id="public-nomination-mode"><h2>Public Nomination Mode</h2></a>
<p>An asset runs in public nomination mode when the <a href="#asset-issuer" title="An entity that creates digital assets on the Tari DAN">Asset Issuer</a> broadcasts a call for nominations to the network and VNs from the network nominate themselves as candidates to become members of the <a href="#committee" title="A group of validator nodes that are responsible for managing a specific Digital Asset">committee</a> for the asset. The <a href="#asset-issuer" title="An entity that creates digital assets on the Tari DAN">Asset Issuer</a> will then employ the <a href="#committeeselectionstrategy" title="A strategy for an Asset Issuer to select candidates for the committee from the available registered Validator Nodes who responded to the nomination call for that asset">CommitteeSelectionStrategy</a> to select the committee from the list of available candidates.</p>
<a class="header" href="#range-proof" id="range-proof"><h2>Range proof</h2></a>
<p>A mathematical demonstration that a value inside a <a href="#commitment">commitment</a> (i.e. it is hidden) lies within a certain range. For
<a href="#mimblewimble" title="a privacy-centric cryptocurrency protocol">Mimblewimble</a>, range proofs are used to prove that outputs are positive values.</p>
<a class="header" href="#registration-deposit" id="registration-deposit"><h2>Registration Deposit</h2></a>
<p>An amount of tari coin that is locked up on the base layer when a <a href="#validator-node" title="A second-layer node that manages and validates digital asset state transitions">Validator Node</a> is registered. In order to make Sybil
attacks expensive and to provide an authorative base layer registry of <a href="#validator-node" title="A second-layer node that manages and validates digital asset state transitions">validator node</a>s they will need to lock up a
amount of <a href="#tari-coin" title="The base layer token">Tari Coin</a> on the <a href="#base-layer" title="The Tari layer handling payments and secured by proof of work">Base Layer</a> using a registration transaction to begin acting as a VN on the DAN.</p>
<a class="header" href="#registration-term" id="registration-term"><h2>Registration Term</h2></a>
<p>The minimum amount of time that a VN registration lasts, the <a href="#registration-deposit" title="An amount of tari coin that is locked up on the base layer when a [Validator Node] is registered">Registration Deposit</a> can only be released after this
minimum period has elapsed.</p>
<a class="header" href="#reorg-pool-1" id="reorg-pool-1"><h2>Reorg Pool</h2></a>
<p>The reorg pool is part of the <a href="#mempool" title="A memory pool for unconfirmed transactions on the base layer">mempool</a> and stores all <a href="#transaction" title="Base layer tari coin transfers.">transaction</a>s that have recently been included in blocks in case a blockchain reorganization occurs and the transactions need to be restored to the <a href="#transaction-pool" title="A pool in the Mempool for valid and verified unconfirmed transactions">transaction pool</a>.</p>
<a class="header" href="#spending-key" id="spending-key"><h2>Spending Key</h2></a>
<p>A private spending key is a private key that permits spending of a <a href="#unspent-transaction-outputs">UTXO</a>. It is also sometimes referred to as a
Blinding Factor, since is Tari (and Mimblewimble) outputs, the value of a UTXO is <em>blinded</em> by the spending key:</p>
<p>$$ C = v.H + k.G $$</p>
<p>The public key, \(P = k.G\) is known as the <em>public</em> spending key.</p>
<a class="header" href="#synchronisationstate" id="synchronisationstate"><h2>SynchronisationState</h2></a>
<p>The current synchronisation state of a <a href="#base-node" title="A full Tari node running on the base layer, validating and propagating Tari coin transactions and blocks">Base Node</a>. This can either be</p>
<ul>
<li><code>new</code> - The blockchain state is empty and is waiting for synchronisation to begin.</li>
<li><code>synchronising</code> - The blockchain state is in the process of synchronising with the rest of the network.</li>
<li><code>synchronised</code> - The blockchain state has synchronised with the rest of the network and is in a position to validate
transactions.</li>
</ul>
<a class="header" href="#synchronisationstrategy" id="synchronisationstrategy"><h2>SynchronisationStrategy</h2></a>
<p>The generalised approach for a <a href="#base-node" title="A full Tari node running on the base layer, validating and propagating Tari coin transactions and blocks">Base Node</a> to obtain the current state of the blockchain from the peer-to-peer network.
Specific implementations may differ based on different trade-offs and constraints with respect to bandwidth, local
network conditions etc.</p>
<a class="header" href="#tari-coin" id="tari-coin"><h2>Tari Coin</h2></a>
<p>The base layer token. Tari coins are released according to the <a href="#emission-schedule">emission schedule</a> on the Tari <a href="#blockchain" title="The linked sequence of Tari blocks on the Tari base layer">base layer</a> in <a href="#coinbase-transaction">coinbase transaction</a>s.</p>
<a class="header" href="#transaction" id="transaction"><h2>Transaction</h2></a>
<p>Transactions are activities recorded on the Tari <a href="#blockchain" title="The linked sequence of Tari blocks on the Tari base layer">blockchain</a> running on the <a href="#base-layer" title="The Tari layer handling payments and secured by proof of work">base layer</a>. Transactions always involve a
transfer of <a href="#tari-coin" title="The base layer token">Tari coin</a>s.</p>
<a class="header" href="#transaction-pool-1" id="transaction-pool-1"><h2>Transaction Pool</h2></a>
<p>The transaction pool is part of the <a href="#mempool" title="A memory pool for unconfirmed transactions on the base layer">mempool</a> and manages all <a href="#transaction" title="Base layer tari coin transfers.">transaction</a>s that have been verified, that spend valid <a href="#unspent-transaction-outputs">UTXO</a>s and don't have any time-lock restrictions.</p>
<a class="header" href="#trusted-node" id="trusted-node"><h2>Trusted Node</h2></a>
<p>A permissioned Validator Node nominated by an Asset Issuer that will form part of the committee for that Digital Asset.</p>
<a class="header" href="#token-wallet" id="token-wallet"><h2>Token Wallet</h2></a>
<p>A Tari Token Wallet is responsible for managing <a href="#digital-asset" title="Sets of Native digital tokens, both fungible and non-fungible that are created by 
asset issuers on the Tari 2nd layer">Digital asset</a>s and <a href="#digital-asset-tokens" title="or just, &quot;tokens&quot;. The tokens associated with a given digital asset. Tokens are created
 by asset issuers">Tokens</a>, and for constructing and negotiating <a href="#instructions" title="Second-layer network commands for managing digital asset state">instruction</a>s for transferring and receiving Assets and Tokens on the <a href="#digital-asset-network" title="The Tari second layer. All digital asset interactions are managed here.">Digital Asset Network</a>.</p>
<a class="header" href="#unspent-transaction-outputs" id="unspent-transaction-outputs"><h2>Unspent transaction outputs</h2></a>
<p>An unspent transaction output (UTXO) is a discrete number of Tari that are available to be spent. The sum of all
UTXOs represents all the Tari currently in circulation. In addition, the sum of all UTXO values equals the sum of the
<a href="#block-reward" title="The amount of Tari created in every block">block reward</a>s for all blocks up to the current block height.</p>
<p>UTXO values are hidden by their <a href="#commitment">commitment</a>s. Only the owner of the UTXO and (presumably) the creator of the UTXO
(either a <a href="#coinbase-transaction">Coinbase transaction</a> or previous spender) know the value of the UTXO.</p>
<a class="header" href="#validator-node" id="validator-node"><h2>Validator Node</h2></a>
<p>Validator nodes (VNs) make up the Tari second layer, or <a href="#digital-asset-network" title="The Tari second layer. All digital asset interactions are managed here.">Digital Asset Network</a>. VNs are responsible for creating and
updating <a href="#digital-asset" title="Sets of Native digital tokens, both fungible and non-fungible that are created by 
asset issuers on the Tari 2nd layer">digital asset</a>s living on the Tari network.</p>
<a class="header" href="#validationstate" id="validationstate"><h2>ValidationState</h2></a>
<p>Transactions or blocks are <code>unvalidated</code> when first received by a <a href="#base-node" title="A full Tari node running on the base layer, validating and propagating Tari coin transactions and blocks">Base Node</a>. After validation, they are either
<code>rejected</code> or <code>validated</code>.</p>
<p><code>Validated</code> transactions can be added to the <a href="#mempool" title="A memory pool for unconfirmed transactions on the base layer">mempool</a> and propagated to peers.</p>
<p><code>Validated</code> blocks are added to the <a href="#blockchain" title="The linked sequence of Tari blocks on the Tari base layer">blockchain</a> and propagated to peers.</p>
<a class="header" href="#wallet" id="wallet"><h2>Wallet</h2></a>
<p>A Tari Wallet is responsible for managing key pairs, and for constructing and negotiating <a href="#transaction" title="Base layer tari coin transfers.">transaction</a>s for transferring and receiving <a href="#tari-coin" title="The base layer token">tari coin</a>s on the <a href="#base-layer" title="The Tari layer handling payments and secured by proof of work">Base Layer</a>.</p>
<a class="header" href="#disclaimer-23" id="disclaimer-23"><h1>Disclaimer</h1></a>
<p>This document is subject to the <a href="../DISCLAIMER.html">disclaimer</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Initialize mermaid -->
        <script src="theme/js/mermaid.min.js" type="text/javascript" charset="utf-8"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>
        
        

    </body>
</html>
